<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ULTRA SPEED TV</title>
    <style>
        :root {
            --bg: #000;
            --accent: #00d4ff;
            --card-w: 250px;
            --card-h: 140px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background: var(--bg);
            color: #fff;
            font-family: sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        /* Hero simplificado para no gastar CPU */
        .hero {
            height: 40vh;
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: linear-gradient(0deg, #000 0%, transparent 100%);
        }

        .hero-name { font-size: 4rem; font-weight: bold; text-shadow: 0 4px 10px #000; }
        .hero-status { color: var(--accent); letter-spacing: 2px; font-size: 0.9rem; }

        /* Contenedor principal */
        .viewport {
            height: 60vh;
            position: relative;
            overflow: hidden;
        }

        .strip {
            display: flex;
            padding-left: 50px;
            will-change: transform;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            align-items: center;
            height: 300px;
        }

        .card {
            flex: 0 0 var(--card-w);
            height: var(--card-h);
            margin-right: 20px;
            background: #111;
            border-radius: 15px;
            border: 3px solid #222;
            position: relative;
            transition: transform 0.2s;
            /* Círculo de carga mientras no hay imagen */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        /* Efecto de fondo difuminado dentro de la card */
        .card-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            filter: blur(0px);
            transition: opacity 0.3s;
            opacity: 0;
            z-index: 1;
        }

        .card.loaded .card-bg { opacity: 1; }

        /* Círculo de carga (estética APK) */
        .card::before {
            content: "";
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            position: absolute;
            z-index: 0;
        }

        .card.loaded::before { display: none; }

        .card:focus {
            transform: scale(1.15);
            border-color: #fff;
            z-index: 10;
        }

        .card-info {
            position: absolute;
            bottom: -45px;
            width: 100%;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
            opacity: 0.6;
        }

        .card:focus .card-info { opacity: 1; color: var(--accent); }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="hero">
    <div class="hero-status" id="status">SISTEMA ULTRA-LIGHT</div>
    <div class="hero-name" id="current-name">TV LIVE</div>
</div>

<div class="viewport">
    <div class="strip" id="strip"></div>
</div>

<script>
    const M3U_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";
    const strip = document.getElementById('strip');
    let channels = [];
    let curIdx = 0;
    let lastKeyTime = 0;

    async function load() {
        try {
            const r = await fetch(M3U_URL);
            const d = await r.text();
            parse(d);
        } catch(e) { document.getElementById('status').innerText = "ERROR RED"; }
    }

    function parse(data) {
        const lines = data.split('\n');
        for(let i=0; i<lines.length; i++) {
            if(lines[i].includes('#EXTINF')) {
                const name = lines[i].split(',')[1]?.trim() || "Canal";
                const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1] || "";
                const url = lines[i+1]?.trim();
                if(url && url.startsWith('http')) channels.push({name, logo, url});
            }
        }
        render();
    }

    function render() {
        const frag = document.createDocumentFragment();
        channels.forEach((ch, i) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.tabIndex = 0;
            card.innerHTML = `<div class="card-bg"></div><div class="card-info">${ch.name}</div>`;
            
            card.onfocus = () => {
                curIdx = i;
                moveStrip(i);
                document.getElementById('current-name').innerText = ch.name;
            };
            
            card.onkeydown = (e) => { if(e.key === 'Enter') window.location.href = ch.url; };
            frag.appendChild(card);
        });
        strip.appendChild(frag);
        setTimeout(() => {
            strip.children[0]?.focus();
            manageMemory();
        }, 100);
    }

    function moveStrip(idx) {
        const now = Date.now();
        const diff = now - lastKeyTime;
        lastKeyTime = now;

        const offset = -(idx * (250 + 20));
        strip.style.transform = `translateX(${offset}px)`;

        // Si navegamos normal, actualizamos RAM rápido. Si volamos, esperamos.
        clearTimeout(window.moveTO);
        window.moveTO = setTimeout(manageMemory, diff < 100 ? 150 : 0);
    }

    function manageMemory() {
        const cards = strip.children;
        const buffer = 4; // Cuántas imágenes cargar alrededor

        for(let i=0; i<cards.length; i++) {
            const card = cards[i];
            const bg = card.querySelector('.card-bg');
            const dist = Math.abs(i - curIdx);

            if(dist <= buffer) {
                if(!card.classList.contains('loaded')) {
                    const img = new Image();
                    img.src = channels[i].logo;
                    img.onload = () => {
                        bg.style.backgroundImage = `url(${channels[i].logo})`;
                        card.classList.add('loaded');
                    };
                }
            } else {
                // Borrar para liberar RAM
                bg.style.backgroundImage = "";
                card.classList.remove('loaded');
            }
        }
    }

    // Navegación inteligente de 2 en 2 o 4 en 4
    window.addEventListener('keydown', (e) => {
        if(e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            const now = Date.now();
            const delta = now - lastKeyTime;
            let jump = 1;

            if(delta < 80) jump = 4;
            else if(delta < 150) jump = 2;

            if(jump > 1) {
                e.preventDefault();
                let target = e.key === 'ArrowRight' ? curIdx + jump : curIdx - jump;
                target = Math.max(0, Math.min(target, channels.length - 1));
                strip.children[target].focus();
            }
        }
    });

    load();
</script>

</body>
</html>
