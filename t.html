
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>DixMax Pro Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
        :root { --bg: #050505; --card-bg: #121212; --accent: #0070ff; --text: #ffffff; --muted: #888888; }
        body, html { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); height: 100%; overflow: hidden; }

        /* NAVEGACIÓN SPA */
        .page { position: absolute; inset: 0; display: none; overflow-y: auto; padding-bottom: 100px; z-index: 10; }
        .page.active { display: block; }

        /* BUSCADOR */
        .search-container { padding: 20px; position: sticky; top: 0; background: var(--bg); z-index: 20; }
        .search-box { 
            background: var(--card-bg); border: 1px solid #222; border-radius: 50px; 
            display: flex; align-items: center; padding: 0 20px; height: 50px;
        }
        .search-box input { 
            background: transparent; border: none; color: white; flex: 1; 
            margin-left: 10px; outline: none; font-size: 1rem;
        }

        /* OVERLAYS */
        .full-overlay { 
            position: fixed; inset: 0; background: var(--bg); z-index: 10000; 
            display: none; flex-direction: column; transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.32, 1, 0.23, 1);
        }

        /* PLAYER & UI */
        #mainVideo { width: 100%; height: 100%; background: #000; }
        .player-ui { 
            position: absolute; inset: 0; 
            background: rgba(0,0,0,0.6); 
            display: flex; flex-direction: column; 
            justify-content: space-between; 
            padding: 25px; 
            transition: opacity 0.3s ease, visibility 0.3s;
            z-index: 10001;
        }
        .player-ui.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        
        #videoTouchArea { position: absolute; inset: 0; z-index: 10000; }

        .progress-rail { height: 4px; background: rgba(255,255,255,0.2); width: 100%; position: relative; cursor: pointer; border-radius: 5px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; border-radius: 5px; position: relative; }
        .progress-dot { width: 14px; height: 14px; background: var(--accent); border-radius: 50%; position: absolute; right: -7px; top: -5px; box-shadow: 0 0 10px var(--accent); }

        /* GRID & CARDS */
        #hero { height: 55vh; position: relative; overflow: hidden; }
        #hero img { width: 100%; height: 100%; object-fit: cover; }
        .hero-grad { position: absolute; inset: 0; background: linear-gradient(transparent 50%, var(--bg)); display: flex; flex-direction: column; justify-content: flex-end; padding: 30px; }
        
        .section-title { padding: 20px; font-size: 1rem; font-weight: 800; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .h-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 0 20px 20px; scrollbar-width: none; }
        .card { flex: 0 0 150px; border-radius: 18px; overflow: hidden; background: var(--card-bg); position: relative; border: 1px solid #1a1a1a; }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card-label { position: absolute; bottom: 0; width: 100%; padding: 10px 8px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); font-size: 0.75rem; font-weight: 600; }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(10,10,10,0.98); display: flex; border-top: 1px solid #1a1a1a; z-index: 5000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); cursor: pointer; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }
        .nav-item span { font-size: 0.65rem; font-weight: 700; }

        #resumeBox { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 20000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .dialog { background: var(--card-bg); padding: 30px; border-radius: 24px; width: 100%; max-width: 360px; text-align: center; border: 1px solid #222; }
        .btn-pill { width: 100%; padding: 15px; border-radius: 50px; border: none; font-weight: bold; margin-top: 12px; cursor: pointer; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="playerView" class="full-overlay">
        <div id="videoTouchArea"></div>
        <video id="mainVideo" playsinline></video>
        <div class="player-ui" id="pUI">
            <div style="z-index: 10002;">
                <i class="fas fa-chevron-down" onclick="closePlayer()" style="font-size:1.6rem; padding:10px"></i> 
                <span id="pTitle" style="margin-left:15px; font-weight: bold;"></span>
            </div>
            <div style="display:flex; justify-content:center; gap:50px; font-size:3rem; z-index: 10002;">
                <i class="fas fa-undo" onclick="jump(-10)"></i>
                <i class="fas fa-play" id="playBtn" onclick="togglePlay()"></i>
                <i class="fas fa-redo" onclick="jump(10)"></i>
            </div>
            <div style="z-index: 10002;">
                <div style="font-size:0.85rem; margin-bottom:10px;"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
                <div class="progress-rail" id="progArea"><div class="progress-fill" id="progBar"><div class="progress-dot"></div></div></div>
            </div>
        </div>
    </div>

    <div id="capsView" class="full-overlay">
        <div style="padding:25px; border-bottom:1px solid #1a1a1a; display:flex; align-items:center; gap:15px;">
            <i class="fas fa-chevron-down" onclick="closeCaps()" style="font-size:1.5rem"></i>
            <h2 id="capsTitle"></h2>
        </div>
        <div id="capsList" style="flex:1; overflow-y:auto; padding:20px;"></div>
    </div>

    <div id="resumeBox">
        <div class="dialog">
            <h3>Continuar viendo</h3>
            <p id="resumeTxt" style="color:var(--muted); margin:15px 0;"></p>
            <button class="btn-pill" style="background:var(--accent); color:white" onclick="doResume(true)">CONTINUAR</button>
            <button class="btn-pill" style="background:#222; color:white" onclick="doResume(false)">REINICIAR</button>
        </div>
    </div>

    <main id="pg-home" class="page active"><div id="hero"></div><div id="homeContent"></div></main>
    <main id="pg-search" class="page">
        <div class="search-container"><div class="search-box"><i class="fas fa-search"></i><input type="text" id="searchInput" placeholder="Buscar..." oninput="searchData()"></div></div>
        <div id="searchGrid" class="h-scroll" style="flex-wrap:wrap"></div>
    </main>
    <main id="pg-series" class="page"><h2 class="section-title">Series</h2><div id="grid-series" class="h-scroll" style="flex-wrap:wrap"></div></main>
    <main id="pg-live" class="page"><h2 class="section-title">Canales</h2><div id="grid-live" class="h-scroll" style="flex-wrap:wrap"></div></main>

    <nav>
        <div class="nav-item active" onclick="nav('home', this)"><i class="fas fa-home"></i><span>INICIO</span></div>
        <div class="nav-item" onclick="nav('search', this)"><i class="fas fa-search"></i><span>BUSCAR</span></div>
        <div class="nav-item" onclick="nav('series', this)"><i class="fas fa-tv"></i><span>SERIES</span></div>
        <div class="nav-item" onclick="nav('live', this)"><i class="fas fa-broadcast-tower"></i><span>VIVO</span></div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const API = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        const M3U = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";
        let db = { series:[], movies:[], live:[], all:[] }, timerUI, startY = 0, currentMedia = null;
        const video = document.getElementById('mainVideo'), hls = new Hls();
        const pUI = document.getElementById('pUI');

        async function init() {
            try {
                const [r1, r2] = await Promise.all([fetch(API).then(r=>r.json()), fetch(M3U).then(r=>r.text())]);
                db.series = r1.filter(x => x.episodes);
                db.movies = r1.filter(x => !x.episodes);
                
                // FILTRO M3U8: Solo añade si tiene URL válida
                r2.split('\n').forEach((line, i, arr) => {
                    if(line.includes('#EXTINF')){
                        const url = arr[i+1]?.trim();
                        if(url && url.startsWith('http')) {
                            db.live.push({ 
                                title: line.split(',')[1]?.trim(), 
                                img: line.match(/tvg-logo="([^"]*)"/)?.[1], 
                                url: url, 
                                isLive: true, 
                                isEvent: line.toLowerCase().includes('evento') 
                            });
                        }
                    }
                });

                db.all = [...db.series, ...db.movies, ...db.live];
                renderHero();
                renderRows();
                setupSwipe(document.getElementById('playerView'), closePlayer);
                setupSwipe(document.getElementById('capsView'), closeCaps);
            } catch(e) { console.error("Error", e); }
        }

        // MOSTRAR/OCULTAR CONTROLES
        function toggleUI(e) {
            if (e && e.target !== document.getElementById('videoTouchArea') && e.target !== video) return;
            pUI.classList.contains('hidden') ? showUI() : hideUI();
        }
        function showUI() { 
            pUI.classList.remove('hidden'); 
            clearTimeout(timerUI); 
            if(!video.paused) timerUI = setTimeout(hideUI, 3000); 
        }
        function hideUI() { pUI.classList.add('hidden'); }
        document.getElementById('videoTouchArea').onclick = toggleUI;
        video.onclick = toggleUI;

        function renderHero() {
            const event = db.live.find(x => x.isEvent && x.url);
            const featured = event || db.movies[0];
            if(!featured) return;
            document.getElementById('hero').innerHTML = `
                <img src="${featured.coverImage || featured.img}">
                <div class="hero-grad">
                    <span style="color:var(--accent); font-weight:bold; font-size:0.8rem;">${event ? '● EN VIVO' : 'PELÍCULA DESTACADA'}</span>
                    <h1 style="font-size:2.2rem; margin:10px 0;">${featured.title}</h1>
                    <button class="btn-pill" style="background:var(--accent); color:white; width:200px" onclick="action('${featured.title}')">REPRODUCIR</button>
                </div>`;
        }

        function createCard(i) {
            const c = document.createElement('div'); c.className = 'card';
            c.innerHTML = `<img src="${i.img || i.coverImage}"><div class="card-label">${i.title}</div>`;
            c.onclick = () => action(i.title);
            return c;
        }

        function renderRows() {
            const sections = [{t:"En Vivo", d:db.live}, {t:"Series", d:db.series}, {t:"Cine", d:db.movies}];
            sections.forEach(s => {
                const row = document.createElement('div');
                row.innerHTML = `<h2 class="section-title">${s.t}</h2><div class="h-scroll"></div>`;
                s.d.slice(0,12).forEach(i => row.querySelector('.h-scroll').appendChild(createCard(i)));
                document.getElementById('homeContent').appendChild(row);
            });
            db.series.forEach(i => document.getElementById('grid-series').appendChild(createCard(i)));
            db.live.forEach(i => document.getElementById('grid-live').appendChild(createCard(i)));
        }

        function action(title) {
            const item = db.all.find(x => x.title === title);
            if(item.episodes) {
                document.getElementById('capsTitle').textContent = item.title;
                const list = document.getElementById('capsList'); list.innerHTML = '';
                item.episodes.forEach((ep, idx) => {
                    const div = document.createElement('div'); div.className = 'card'; div.style.flex = '0 0 100%'; div.style.marginBottom = '10px'; div.style.padding = '20px'; div.style.display = 'flex'; div.style.alignItems = 'center';
                    div.innerHTML = `<span style="background:var(--accent); border-radius:50%; width:30px; height:30px; display:flex; align-items:center; justify-content:center; margin-right:15px; font-weight:bold;">${idx+1}</span> Capítulo ${idx+1}`;
                    div.onclick = (e) => { e.stopPropagation(); launch(ep.video_url, `E${idx+1} - ${item.title}`); };
                    list.appendChild(div);
                });
                openOverlay('capsView');
            } else { launch(item.url || item.video_url, item.title, item.isLive); }
        }

        function launch(url, title, isLive) {
            const cached = localStorage.getItem('c_' + title);
            currentMedia = { url, title, isLive };
            if(!isLive && cached && parseFloat(cached) > 10) {
                document.getElementById('resumeTxt').textContent = "Regresa al minuto " + format(cached);
                document.getElementById('resumeBox').style.display = 'flex';
            } else { play(url, title, 0); }
        }

        function play(url, title, time) {
            window.activeT = title; document.getElementById('pTitle').textContent = title;
            openOverlay('playerView');
            if (Hls.isSupported() && url.includes('m3u8')) {
                hls.loadSource(url); hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => { video.currentTime = time; video.play(); });
            } else { video.src = url; video.onloadedmetadata = () => { video.currentTime = time; video.play(); }; }
            const pv = document.getElementById('playerView');
            if(pv.requestFullscreen) pv.requestFullscreen();
            showUI();
        }

        function doResume(yes) {
            document.getElementById('resumeBox').style.display = 'none';
            play(currentMedia.url, currentMedia.title, yes ? parseFloat(localStorage.getItem('c_' + currentMedia.title)) : 0);
        }

        function openOverlay(id) { const el = document.getElementById(id); el.style.display = 'flex'; setTimeout(() => el.style.transform = 'translateY(0)', 10); }
        function closePlayer() { 
            if(video.duration && !currentMedia.isLive) localStorage.setItem('c_' + window.activeT, video.currentTime);
            video.pause(); const el = document.getElementById('playerView'); el.style.transform = 'translateY(100%)';
            setTimeout(() => { el.style.display = 'none'; hls.detachMedia(); }, 400); 
            if(document.fullscreenElement) document.exitFullscreen();
        }
        function closeCaps() { const el = document.getElementById('capsView'); el.style.transform = 'translateY(100%)'; setTimeout(() => el.style.display = 'none', 400); }

        function setupSwipe(el, cb) {
            el.addEventListener('touchstart', e => { if(e.target.closest('.progress-rail') || e.target.closest('i')) return; startY = e.touches[0].clientY; el.style.transition = 'none'; });
            el.addEventListener('touchmove', e => { if(!startY) return; let d = e.touches[0].clientY - startY; if(d > 0) el.style.transform = `translateY(${d}px)`; });
            el.addEventListener('touchend', e => { el.style.transition = 'transform 0.4s ease'; if(startY && e.changedTouches[0].clientY - startY > 150) cb(); else el.style.transform = 'translateY(0)'; startY = 0; });
        }

        document.getElementById('progArea').onclick = (e) => { e.stopPropagation(); video.currentTime = (e.offsetX / e.currentTarget.offsetWidth) * video.duration; showUI(); };
        function togglePlay() { video.paused ? video.play() : video.pause(); showUI(); }
        function jump(t) { video.currentTime += t; showUI(); }
        function format(s) { if(isNaN(s)) return "0:00"; let m=Math.floor(s/60), sec=Math.floor(s%60); return m+":"+(sec<10?"0"+sec:sec); }
        video.ontimeupdate = () => { document.getElementById('progBar').style.width = (video.currentTime / video.duration * 100) + '%'; document.getElementById('cur').textContent = format(video.currentTime); document.getElementById('dur').textContent = format(video.duration); };
        video.onplay = () => { document.getElementById('playBtn').className = "fas fa-pause"; showUI(); };
        video.onpause = () => { document.getElementById('playBtn').className = "fas fa-play"; showUI(); };
        function nav(id, btn) { document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.getElementById('pg-'+id).classList.add('active'); btn.classList.add('active'); }

        init();
    </script>
</body>
</html>
