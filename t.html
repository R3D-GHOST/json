<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kawaii Play TV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<meta name="theme-color" content="#1A1A2E">
<style>
/* --- 2. CSS Completamente Revisado y Optimizado para TV --- */
:root {
  --primary-bg: #1A1A2E; 
  --secondary-bg: #272842; 
  --card-bg: #323354;
  --text-primary: #E8EAF6; 
  --text-secondary: #9FA8DA; 
  --accent-pink: #FF69B4; 
  --accent-yellow: #FFD700; 
  --border-color: #4A4A6E;
  --watched-color: #4CAF50;
  --focus-color: var(--accent-yellow); 
  --focus-scale: 1.12; 
  --menu-width: 320px; /* Ancho del men√∫ fijo */
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--primary-bg);
  color: var(--text-primary);
  overflow: hidden; 
  scroll-behavior: smooth; 
}

/* --- Accesibilidad y Foco --- */
*:not(button, a, input, [tabindex="0"]):focus {
    outline: none !important;
}


/* --- MEN√ö PERMANENTE (Estilo TV) --- */
header {
  display: none; 
}

#side-menu {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: var(--menu-width); 
    background: var(--secondary-bg);
    z-index: 1001;
    padding-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border-right: 3px solid var(--accent-pink);
    box-shadow: 5px 0 15px rgba(0,0,0,0.5);
    transform: translateX(0) !important; 
    transition: none !important;
}

.search-container {
    padding: 0 20px 20px;
}

#side-menu input {
  padding: 15px;
  border-radius: 12px;
  font-size: 18px;
  background-color: var(--card-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  outline: none;
  width: 100%;
}
#side-menu input:focus {
    border-color: var(--accent-pink);
    box-shadow: 0 0 10px rgba(255, 105, 180, 0.7);
}

.nav-link {
    color: var(--text-primary);
    text-decoration: none;
    padding: 18px 25px; 
    font-size: 20px;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
}

.nav-link:focus {
    background-color: var(--card-bg);
    color: var(--focus-color);
    box-shadow: inset 6px 0 0 var(--focus-color);
    transform: scale(1.05); 
}

/* --- Main & Screens (Ajuste para dejar espacio al men√∫) --- */
main {
  position: relative;
  margin-left: var(--menu-width); 
  padding: 20px 0;
  height: 100vh;
  overflow-y: scroll; 
}

.screen {
  display: none;
  animation: fadeIn 0.3s ease;
  padding-bottom: 50px;
}
.screen.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.loader-container { 
    z-index: 10000; 
    /* El loader debe cubrir el men√∫ y el contenido */
    margin-left: calc(0px - var(--menu-width)); 
    width: calc(100% + var(--menu-width));
}

.banner { 
    position: relative;
    height: 40vh; /* Reducir altura del banner */
    background: #000;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 50px;
    color: white;
    overflow: hidden;
}
.banner-bg { /* ... se mantiene ... */ }
.banner h2 { /* ... se mantiene ... */ }
.banner #btn-live { /* ... se mantiene ... */ }
.banner #btn-live:focus { /* ... se mantiene ... */ }

/* --- Content Sections --- */
.section { padding: 15px 30px; }
.section h2 { /* ... se mantiene ... */ }

.row {
  display: flex;
  overflow-x: scroll;
  gap: 30px;
  padding-bottom: 25px;
  -ms-overflow-style: none;
  scrollbar-width: none;
}
.row::-webkit-scrollbar { display: none; }

.card {
  flex: 0 0 240px; 
  background: var(--card-bg);
  border-radius: 16px;
  cursor: pointer;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,.4);
  transition: transform 0.3s ease, box-shadow 0.3s ease, outline 0.3s ease;
  outline: 6px solid transparent; 
  outline-offset: 4px;
}

.card:focus {
    transform: scale(var(--focus-scale));
    box-shadow: 0 15px 40px rgba(0,0,0,.8);
    outline: 6px solid var(--focus-color); 
    z-index: 5;
}

/* ... Resto de estilos se mantiene (Detail, Episodes, etc.) ... */
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@4.0.0/dist/hls.min.js"></script>
</head>
<body>

<div id="loader" class="loader-container">
    <div class="loader"></div>
</div>

<nav id="side-menu" class="permanent-menu">
    <div class="search-container">
        <input id="search" type="text" placeholder="Buscar..." tabindex="0"/> 
    </div>
    <a href="#" class="nav-link" data-screen="home" tabindex="0">üè† Inicio</a>
    <a href="#" class="nav-link" data-screen="favorites" tabindex="0">‚≠ê Favoritos</a>
    <a href="#" class="nav-link" data-screen="watched" tabindex="0">‚úîÔ∏è Vistos</a>
</nav>

<header style="display: none;">
    <div class="logo-container">
        <h1 id="header-title">Kawaii Play TV</h1>
    </div>
</header>

<main id="main-content">
    <div id="banner" class="banner">
      <img id="banner-bg" class="banner-bg" src="" alt="Live channel background">
      <h2 id="banner-title"></h2>
      <a id="btn-live" style="padding: 18px 30px; background: var(--accent-pink); color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 2; font-weight: bold; align-self: flex-start; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; text-decoration: none; display: inline-block; outline: none;" href="#" target="_blank" rel="noopener noreferrer" tabindex="0">Ver en directo</a>
    </div>
    
    <div id="home" class="screen active" tabindex="0"> 
        </div>
    
    <div id="detail" class="screen" tabindex="0"> 
        <div class="detail-hero">
            <img id="detail-poster" class="detail-poster" src="" alt="Poster">
            <div class="detail-hero-overlay"></div>
            <div class="detail-header">
                <button id="back-btn" tabindex="-1">‚¨Ö Atr√°s</button>
            </div>
            <div class="detail-info">
                <h2 id="detail-title"></h2>
                <div class="detail-actions">
                    <button id="play-action-btn" tabindex="-1">‚ñ∂ Ver Episodio 1</button>
                    <button id="fav-btn" tabindex="-1">‚≠ê A√±adir a Favoritos</button>
                </div>
                <p id="detail-description"></p>
            </div>
        </div>
        <div id="detail-content" class="detail-content">
            </div>
    </div>
    
    <div id="favorites" class="screen" tabindex="0"></div>
    <div id="watched" class="screen" tabindex="0"></div>
</main>

<script>
// Key Codes para D-Pad de TV
const KEY_CODES = {
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    ENTER: 13,
    ESC: 27
};

const DATA_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
const M3U_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/toro.m3u8";

// DOM Elements
const loader = document.getElementById("loader");
const mainContent = document.getElementById("main-content");
const home = document.getElementById("home");
const favoritesScreen = document.getElementById("favorites");
const watchedScreen = document.getElementById("watched");

const searchInput = document.getElementById("search");
const backBtn = document.getElementById("back-btn");
const playActionBtn = document.getElementById('play-action-btn');
const favBtn = document.getElementById("fav-btn");

const navLinks = Array.from(document.querySelectorAll('#side-menu .nav-link'));
const menuElements = [searchInput, ...navLinks]; // Elementos enfocables del men√∫

// State y Local Storage (se mantienen)
let allData = { movies: [], series: [], channels: [] };
let liveChannels = [];
let liveInterval = null;
let currentDetailItem = null;
let currentFocusedElement = null; 

let favorites = JSON.parse(localStorage.getItem('kawaii_favorites')) || [];
let watched = JSON.parse(localStorage.getItem('kawaii_watched')) || {};
let continueWatching = JSON.parse(localStorage.getItem('kawaii_continue')) || [];
let progress = JSON.parse(localStorage.getItem('kawaii_progress')) || {};


// --- UTILITY FUNCTIONS ---
const generateItemId = (item) => item.title;
const updateFavorites = () => localStorage.setItem('kawaii_favorites', JSON.stringify(favorites));
const updateWatched = () => localStorage.setItem('kawaii_watched', JSON.stringify(watched));

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if(screen) screen.classList.add('active');
    
    // Configuraci√≥n de foco inicial
    setTimeout(() => {
        let initialFocusTarget;
        if (screenId === 'detail') {
            // El foco inicial en detalle es el bot√≥n Atr√°s
            initialFocusTarget = backBtn;
        } else {
             // En Home, Favorites o Watched, el foco inicial es el primer elemento del contenido (Banner o Card)
             initialFocusTarget = screen.querySelector('#btn-live') || screen.querySelector('.card') || menuElements[0]; 
        }
        
        if (initialFocusTarget) {
            initialFocusTarget.focus();
            currentFocusedElement = initialFocusTarget;
            mainContent.scrollTop = 0; 
        } else if (screenId !== 'detail') {
            // Si no hay contenido, enfocar el men√∫
            menuElements[0].focus();
            currentFocusedElement = menuElements[0];
        }
    }, 100);
}

// ... (loadData, loadM3U, parseM3U, renderBannerLive se mantienen) ...

/**
 * FUNCI√ìN REVISADA: Crea una secci√≥n y CARGA TODO el contenido al instante.
 */
function createSection(title, items, cardCreator, parentElement) {
    const section = document.createElement("div");
    section.className = "section";
    
    const h2 = document.createElement("h2");
    h2.textContent = title;
    section.appendChild(h2);
    
    const row = document.createElement("div");
    row.className = "row";
    
    const fragment = document.createDocumentFragment();
    items.forEach(item => fragment.appendChild(cardCreator(item)));
    
    row.appendChild(fragment);
    section.appendChild(row);
    parentElement.appendChild(section);
    
    // NO HAY L√ìGICA DE CARGA ADICIONAL NI OBSERVERS
}

function renderHome(filter = "") {
    home.innerHTML = "";
    
    const lowerFilter = filter.toLowerCase();

    // 1. Continuar Viendo
    if (!filter) {
        const continueWatching = JSON.parse(localStorage.getItem('kawaii_continue')) || [];
        const continueData = continueWatching.map(storedItem => {
            return allData.movies.find(i => generateItemId(i) === generateItemId(storedItem)) || 
                   allData.series.find(i => generateItemId(i) === generateItemId(storedItem));
        }).filter(Boolean);
        if (continueData.length > 0) {
             createSection("Continuar Viendo", continueData, (item) => {
                return item.episodes ? createSeriesCard(item) : createMovieCard(item);
            }, home); // Carga completa
        }
    }

    // 2. Otros contenidos
    const filteredMovies = allData.movies.filter(item => item.title.toLowerCase().includes(lowerFilter));
    const filteredSeries = allData.series.filter(item => item.title.toLowerCase().includes(lowerFilter));
    const filteredChannels = allData.channels
        .filter(c => c.group.toUpperCase() !== "EN DIRECTO")
        .filter(ch => ch.name.toLowerCase().includes(lowerFilter));

    if (filteredMovies.length) createSection("Pel√≠culas", filteredMovies, createMovieCard, home);
    if (filteredSeries.length) createSection("Series", filteredSeries, createSeriesCard, home);
    if (filteredChannels.length) createSection("Canales", filteredChannels, createChannelCard, home);
}

// ... (Card Creators, openItem, playVideo, renderFavorites, renderWatched se mantienen) ...


// --- TV FOCUS NAVIGATION (D-Pad) L√ìGICA FINAL Y ARREGLADA ---

document.addEventListener('keydown', (e) => {
    if (e.keyCode === KEY_CODES.ESC) {
        e.preventDefault();
        if (document.getElementById('detail').classList.contains('active')) {
            backBtn.click();
        }
        return;
    }

    if (document.getElementById('detail').classList.contains('active')) {
        // En detalle, s√≥lo navega entre elementos enfocables de arriba a abajo
        handleVerticalFocus(e, '#detail button');
        return;
    }

    // L√≥gica principal de navegaci√≥n TV (Men√∫ vs Contenido)
    if ([KEY_CODES.LEFT, KEY_CODES.UP, KEY_CODES.RIGHT, KEY_CODES.DOWN].includes(e.keyCode)) {
        handleTVFocus(e);
    }
});

function handleTVFocus(e) {
    const currentActive = document.activeElement;
    const isMenuFocused = menuElements.includes(currentActive) || currentActive === searchInput;

    e.preventDefault();

    if (isMenuFocused) {
        handleMenuNavigation(e, currentActive);
    } else {
        // Asume que estamos en el contenido principal (cards, banner, botones)
        handleGridFocus(e, currentActive);
    }
}

/**
 * 1. Navegaci√≥n dentro del men√∫ vertical fijo.
 */
function handleMenuNavigation(e, currentActive) {
    const navElements = menuElements.filter(el => el.getAttribute('tabindex') !== '-1');
    const currentIndex = navElements.indexOf(currentActive);
    let nextElement = null;

    if (e.keyCode === KEY_CODES.UP) {
        let nextIndex = (currentIndex - 1 + navElements.length) % navElements.length;
        nextElement = navElements[nextIndex];

    } else if (e.keyCode === KEY_CODES.DOWN) {
        let nextIndex = (currentIndex + 1) % navElements.length;
        nextElement = navElements[nextIndex];
        
    } else if (e.keyCode === KEY_CODES.RIGHT) {
        // RIGHT: Saltar al contenido principal (Banner o Primera Card)
        const initialFocusTarget = document.getElementById('btn-live') || document.querySelector('.card');
        if (initialFocusTarget) {
            nextElement = initialFocusTarget;
        } else {
            nextElement = currentActive; 
        }
    }
    
    if (nextElement) {
        nextElement.focus();
    }
}


/**
 * 2. Navegaci√≥n en el contenido principal (horizontal y vertical) - L√≥gica de cuadr√≠cula.
 */
function handleGridFocus(e, currentActive) {
    const bannerElements = [document.getElementById('btn-live')]; 
    const isBannerFocused = bannerElements.includes(currentActive);
    const focusableCards = Array.from(document.querySelectorAll('.card:not([tabindex="-1"])'));
    const rowElements = Array.from(document.querySelectorAll('.row'));
    let newFocusElement = null;
    let currentCardRect = currentActive.getBoundingClientRect();

    // LEFT: Volver al Men√∫ Fijo
    if (e.keyCode === KEY_CODES.LEFT) {
        // Si estamos en la primera columna visible (banner o primera tarjeta de la fila)
        if (isBannerFocused || focusableCards.includes(currentActive) && currentActive.previousElementSibling === null) {
            const currentScreenId = document.querySelector('.screen.active').id;
            const targetMenuLink = document.querySelector(`.nav-link[data-screen="${currentScreenId}"]`) || menuElements[0];
            newFocusElement = targetMenuLink;
        } else {
            // Navegaci√≥n horizontal normal entre tarjetas
            let row = currentActive.closest('.row');
            if (row) {
                 const rowCards = Array.from(row.querySelectorAll('.card'));
                 const currentIndex = rowCards.indexOf(currentActive);
                 if (currentIndex > 0) {
                     newFocusElement = rowCards[currentIndex - 1];
                 }
            }
        }
    }
    
    // RIGHT: Navegaci√≥n horizontal normal
    if (e.keyCode === KEY_CODES.RIGHT) {
        let row = currentActive.closest('.row');
        if (row) {
             const rowCards = Array.from(row.querySelectorAll('.card'));
             const currentIndex = rowCards.indexOf(currentActive);
             if (currentIndex !== -1 && currentIndex < rowCards.length - 1) {
                 newFocusElement = rowCards[currentIndex + 1];
             }
        }
    }
    
    // UP / DOWN: Navegaci√≥n vertical
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        
        // 1. Determinar √≠ndice de la fila actual
        let currentRowIndex = -1; // -1: Banner
        if (!isBannerFocused) {
            rowElements.forEach((row, i) => {
                if (Array.from(row.querySelectorAll('.card')).includes(currentActive)) currentRowIndex = i;
            });
        }
        
        let targetRowIndex = currentRowIndex + (e.keyCode === KEY_CODES.DOWN ? 1 : -1);

        // 2. Transici√≥n Banner <-> Primera Fila
        if (targetRowIndex === -1 && e.keyCode === KEY_CODES.UP) { 
            newFocusElement = bannerElements[0];
        } else if (targetRowIndex === 0 && e.keyCode === KEY_CODES.DOWN && isBannerFocused) { 
            if (rowElements.length > 0) targetRowIndex = 0;
            else newFocusElement = currentActive; 
        }

        // 3. Transici√≥n entre Filas (Row Indices 0+)
        if (targetRowIndex >= 0 && targetRowIndex < rowElements.length) {
            const targetRowCards = Array.from(rowElements[targetRowIndex].querySelectorAll('.card'));
            
            let bestMatch = null;
            let minDistance = Infinity;

            const currentCardCenter = currentCardRect.left + currentCardRect.width / 2;
            
            // Buscar el card mejor alineado horizontalmente
            for (const card of targetRowCards) {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;
                const distance = Math.abs(currentCardCenter - cardCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = card;
                }
            }
            newFocusElement = bestMatch;
        }
    }
    
    // 4. Aplicar Foco y Scroll
    if (newFocusElement) {
        newFocusElement.focus();
        currentFocusedElement = newFocusElement;
        
        newFocusElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        
        // Scroll horizontal del ROW (si aplica)
        let row = newFocusElement.closest('.row');
        if(row) {
            const rect = newFocusElement.getBoundingClientRect();
            const rowRect = row.getBoundingClientRect();
            if (rect.right > rowRect.right) {
                row.scrollLeft += (rect.right - rowRect.right + 30);
            } else if (rect.left < rowRect.left) {
                 row.scrollLeft -= (rowRect.left - rect.left + 30);
            }
        }
    }
}

// ... (El resto de la l√≥gica de detalle y control se mantiene igual) ...

// --- INITIALIZATION ---
async function init() {
    loader.classList.remove('hidden');
    
    // El men√∫ est√° siempre habilitado
    [backBtn, playActionBtn, favBtn].forEach(el => el.setAttribute('tabindex', '-1'));

    await Promise.all([loadData(), loadM3U()]); 
    renderHome();
    loader.classList.add('hidden');
    
    // Foco inicial en el primer elemento del men√∫ (la barra de b√∫squeda)
    searchInput.focus();
    currentFocusedElement = searchInput;
}

init();
</script>
</body>
</html>
