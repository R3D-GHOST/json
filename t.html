<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kawaii Play TV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<meta name="theme-color" content="#161b22">
<style>
/* --- 2. CSS Completamente Revisado y Optimizado para TV --- */
:root {
  --primary-bg: #1A1A2E; /* Azul oscuro elegante */
  --secondary-bg: #272842; /* Tono de fondo secundario */
  --card-bg: #323354;
  --text-primary: #E8EAF6; /* Blanco azulado */
  --text-secondary: #9FA8DA; /* Gris azulado suave */
  --accent-pink: #FF69B4; /* Rosa chill√≥n */
  --accent-yellow: #FFD700; /* Dorado para foco */
  --border-color: #4A4A6E;
  --watched-color: #4CAF50;
  --focus-color: var(--accent-yellow); 
  --focus-scale: 1.12; /* Mayor escala para TV */
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--primary-bg);
  color: var(--text-primary);
  /* Evita el scroll global innecesario al navegar */
  overflow-y: scroll; 
  /* Ajuste para que el scroll sea m√°s r√°pido/fluido en contenedores */
  scroll-behavior: smooth; 
}

/* --- Accesibilidad y Foco (Esencial para TV) --- */
/* Reset de foco en elementos no interactivos para evitar saltos */
*:not(button, a, input, [tabindex="0"]):focus {
    outline: none !important;
}

/* --- Loader (sin cambios significativos) --- */
.loader-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--primary-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  transition: opacity 0.5s ease;
}

.loader {
  border: 4px solid var(--border-color);
  border-top: 4px solid var(--accent-pink);
  border-radius: 50%;
  width: 60px; /* Un poco m√°s grande para TV */
  height: 60px;
  animation: spin 1s linear infinite;
}

.loader-container.hidden {
  opacity: 0;
  pointer-events: none;
}

/* --- Header & Navigation --- */
header {
  background: var(--secondary-bg);
  padding: 15px 30px; /* M√°s padding */
  display: flex;
  align-items: center;
  gap: 20px;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 2px solid var(--border-color);
}

.hamburger-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 32px; /* M√°s grande */
    cursor: pointer;
    padding: 0 15px;
    z-index: 1002;
    outline: none; 
    transition: transform 0.2s, color 0.2s;
}

.hamburger-btn:focus {
    color: var(--focus-color);
    transform: scale(1.1);
    outline: 2px solid var(--focus-color);
    border-radius: 4px;
}

header h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

#side-menu {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 320px; /* Ancho c√≥modo para men√∫ de TV */
    background: var(--secondary-bg);
    z-index: 1001;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); /* Curva de TV */
    padding-top: 90px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border-right: 3px solid var(--accent-pink);
    box-shadow: 5px 0 15px rgba(0,0,0,0.5);
}

#side-menu.open {
    transform: translateX(0);
}

#menu-overlay {
    background: rgba(0,0,0,0.85); /* M√°s oscuro */
}

.search-container {
    padding: 0 20px;
}

#side-menu input {
  padding: 15px;
  border-radius: 12px;
  font-size: 18px;
  background-color: var(--card-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  outline: none;
}
#side-menu input:focus {
    border-color: var(--accent-pink);
    box-shadow: 0 0 10px rgba(255, 105, 180, 0.7);
}

.nav-link {
    padding: 18px 25px; 
    font-size: 20px;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
}

/* Foco en Menu Links */
.nav-link:focus {
    background-color: var(--card-bg);
    color: var(--focus-color);
    box-shadow: inset 6px 0 0 var(--focus-color);
}

/* --- Main & Screens --- */
main {
  padding: 20px 0;
}

.screen {
  padding-bottom: 50px; /* Espacio extra para asegurar que el √∫ltimo card tenga margen */
}

/* --- Banner --- */
.banner {
  height: 50vh; /* Usa vista de pantalla para TV */
  padding: 50px;
}

.banner h2 {
  font-size: 44px;
  font-weight: 900;
}

.banner #btn-live {
  padding: 18px 30px;
  font-size: 20px;
  border-radius: 10px;
  outline: none;
}

/* Foco en Bot√≥n de Banner */
.banner #btn-live:focus {
    background-color: var(--focus-color);
    color: var(--primary-bg);
    box-shadow: 0 0 20px var(--focus-color);
    transform: scale(1.05);
}

/* --- Content Sections --- */
.section {
  padding: 15px 30px;
}

.section h2 {
  margin: 25px 0 20px;
  font-size: 28px;
  font-weight: 700;
  color: var(--accent-pink);
}

.row {
  display: flex;
  overflow-x: scroll;
  gap: 30px; /* M√°s espacio */
  padding-bottom: 25px; /* Espacio para la sombra/foco */
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.card {
  /* Tama√±o TV */
  flex: 0 0 240px; 
  background: var(--card-bg);
  border-radius: 16px;
  cursor: pointer;
  box-shadow: 0 6px 15px rgba(0,0,0,.4);
  transition: transform 0.3s ease, box-shadow 0.3s ease, outline 0.3s ease;
  outline: 6px solid transparent; 
  outline-offset: 4px; /* Separaci√≥n de la tarjeta */
}

.card img {
  width: 100%;
  height: 360px; /* Proporci√≥n 2:3 */
  border-radius: 16px 16px 0 0;
}

.card h3 {
  margin: 12px;
  font-size: 18px;
  font-weight: 600;
  white-space: normal; /* Permitir que el t√≠tulo se envuelva si es necesario */
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: 2.4em;
  line-height: 1.2;
}

/* Foco para Tarjetas - Mantenemos la mejor pr√°ctica */
.card:focus {
    transform: scale(var(--focus-scale));
    box-shadow: 0 15px 40px rgba(0,0,0,.8);
    outline: 6px solid var(--focus-color); 
    z-index: 5;
}

.tv-card {
    flex: 0 0 280px;
}

.tv-card img {
    height: 160px;
    object-fit: contain;
    background-color: #000;
}

/* --- Detail Screen --- */
.detail-hero {
    min-height: 60vh; /* Alto de vista */
}

.detail-info {
    padding: 30px;
}

#back-btn,
#play-action-btn,
#fav-btn {
    padding: 15px 25px;
    font-size: 18px;
    border-radius: 8px;
    outline: none;
    transition: all 0.2s ease;
    border: none;
}

/* Foco en Botones de Detalle */
#back-btn:focus,
#play-action-btn:focus,
#fav-btn:focus {
    transform: scale(1.05);
    box-shadow: 0 0 18px var(--focus-color);
    outline: 3px solid var(--focus-color);
}

.detail-content {
    padding: 20px 30px;
}

.episode-btn {
    padding: 16px;
    font-size: 16px;
    border-radius: 10px;
    transition: background-color 0.2s, outline 0.2s;
    outline: 3px solid transparent;
}

/* Foco en Botones de Episodio */
.episode-btn:focus {
    outline: 3px solid var(--focus-color);
    background: var(--secondary-bg);
    transform: scale(1.02);
}

/* El resto del CSS se mantiene igual. */
</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@4.0.0/dist/hls.min.js"></script>
</head>
<body>

<div id="loader" class="loader-container">
    <div class="loader"></div>
</div>

<div id="menu-overlay"></div>
<nav id="side-menu">
    <div class="search-container">
        <input id="search" type="text" placeholder="Buscar..." tabindex="-1"/> 
    </div>
    <a href="#" class="nav-link" data-screen="home" tabindex="-1">üè† Inicio</a>
    <a href="#" class="nav-link" data-screen="favorites" tabindex="-1">‚≠ê Favoritos</a>
    <a href="#" class="nav-link" data-screen="watched" tabindex="-1">‚úîÔ∏è Vistos</a>
</nav>

<header>
    <button id="hamburger-btn" class="hamburger-btn" tabindex="0">‚ò∞</button>
    <div class="logo-container">
        <h1 id="header-title">Kawaii Play TV</h1>
    </div>
</header>

<main>
    <div id="banner" class="banner">
      <img id="banner-bg" class="banner-bg" src="" alt="Live channel background">
      <h2 id="banner-title"></h2>
      <a id="btn-live" style="padding: 10px 16px; background: var(--accent-pink); color: white; border: none; border-radius: 6px; cursor: pointer; z-index: 2; font-weight: bold; align-self: flex-start; transition: background-color 0.2s; text-decoration: none; display: inline-block;" href="#" target="_blank" rel="noopener noreferrer" tabindex="0">Ver en directo</a>
    </div>
    
    <div id="home" class="screen active" tabindex="0"> 
        </div>
    
    <div id="detail" class="screen" tabindex="0"> 
        <div class="detail-hero">
            <img id="detail-poster" class="detail-poster" src="" alt="Poster">
            <div class="detail-hero-overlay"></div>
            <div class="detail-header">
                <button id="back-btn" tabindex="-1">‚¨Ö Atr√°s</button>
            </div>
            <div class="detail-info">
                <h2 id="detail-title"></h2>
                <div class="detail-actions">
                    <button id="play-action-btn" tabindex="-1">‚ñ∂ Ver Episodio 1</button>
                    <button id="fav-btn" tabindex="-1">‚≠ê A√±adir a Favoritos</button>
                </div>
                <p id="detail-description"></p>
            </div>
        </div>
        <div id="detail-content" class="detail-content">
            </div>
    </div>
    
    <div id="favorites" class="screen" tabindex="0"></div>
    <div id="watched" class="screen" tabindex="0"></div>
</main>

<script>
// Key Codes para D-Pad de TV
const KEY_CODES = {
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    ENTER: 13,
    ESC: 27
};

const DATA_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
const M3U_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/toro.m3u8";
const ITEMS_PER_PAGE = 30; // Carga de 30 en 30

// DOM Elements (se mantienen)
const loader = document.getElementById("loader");
const home = document.getElementById("home");
const detail = document.getElementById("detail");
const favoritesScreen = document.getElementById("favorites");
const watchedScreen = document.getElementById("watched");

const bannerTitle = document.getElementById("banner-title");
const btnLive = document.getElementById("btn-live");
const searchInput = document.getElementById("search");
const backBtn = document.getElementById("back-btn");
const detailContent = document.getElementById("detail-content");
const favBtn = document.getElementById("fav-btn");
const hamburgerBtn = document.getElementById('hamburger-btn');
const sideMenu = document.getElementById('side-menu');
const menuOverlay = document.getElementById('menu-overlay');

// State (se mantiene)
let allData = { movies: [], series: [], channels: [] };
let liveChannels = [];
let liveIndex = 0;
let liveInterval = null;
let observers = [];
let currentDetailItem = null;
let currentFocusedElement = null; 

// Local Storage (se mantiene)
let favorites = JSON.parse(localStorage.getItem('kawaii_favorites')) || [];
let watched = JSON.parse(localStorage.getItem('kawaii_watched')) || {};
let continueWatching = JSON.parse(localStorage.getItem('kawaii_continue')) || [];
let progress = JSON.parse(localStorage.getItem('kawaii_progress')) || {};

// --- UTILITY FUNCTIONS (se mantienen) ---
const generateItemId = (item) => item.title;
const generateEpisodeId = (item, epIndex) => `${item.title}-ep-${epIndex}`;
const updateFavorites = () => localStorage.setItem('kawaii_favorites', JSON.stringify(favorites));
const updateWatched = () => localStorage.setItem('kawaii_watched', JSON.stringify(watched));
const updateProgress = () => localStorage.setItem('kawaii_progress', JSON.stringify(progress));

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if(screen) screen.classList.add('active');
    
    const link = document.querySelector(`.nav-link[data-screen="${screenId}"]`);
    document.getElementById('header-title').textContent = link ? link.textContent.trim().substring(2) : (screenId === 'detail' ? 'Detalles' : "Kawaii Play TV");
    document.getElementById('banner').style.display = screenId === 'home' ? 'flex' : 'none';

    // TV Focus Logic: Set initial focus
    setTimeout(() => {
        let initialFocusTarget;
        if (screenId === 'home') {
             initialFocusTarget = document.getElementById('btn-live') || document.querySelector('.card') || hamburgerBtn;
        } else if (screenId === 'detail') {
            initialFocusTarget = backBtn;
        } else { // favorites, watched
            initialFocusTarget = screen.querySelector('.card') || hamburgerBtn;
        }
        
        if (initialFocusTarget) {
            initialFocusTarget.focus();
            currentFocusedElement = initialFocusTarget;
        }
    }, 100);
}

// ... [funciones de carga de datos, banner, card creators, etc. se mantienen] ...

function createSection(title, items, cardCreator, parentElement, limit = ITEMS_PER_PAGE) {
    const section = document.createElement("div");
    section.className = "section";
    
    const h2 = document.createElement("h2");
    h2.textContent = title;
    section.appendChild(h2);
    
    const row = document.createElement("div");
    row.className = "row";
    section.appendChild(row);
    parentElement.appendChild(section);

    let loadedCount = 0;

    function loadMore() {
        const fragment = document.createDocumentFragment();
        const nextItems = items.slice(loadedCount, loadedCount + limit);
        nextItems.forEach(item => fragment.appendChild(cardCreator(item)));
        row.appendChild(fragment);
        loadedCount += nextItems.length;

        // Si hay m√°s elementos para cargar, usar IntersectionObserver para scroll horizontal
        if (loadedCount < items.length && row.offsetWidth < row.scrollWidth) {
            setupIntersectionObserver(row, loadMore);
        }
    }
    loadMore();
}

// Optimizaci√≥n: el observer debe observar si el final del contenido entra en vista.
function setupIntersectionObserver(row, callback) {
    const lastCard = row.lastElementChild;
    if (!lastCard) return;

    // Crear un sentinel m√°s peque√±o para activarse antes
    const sentinel = document.createElement('div');
    sentinel.style.width = '1px';
    sentinel.style.height = '1px';
    sentinel.style.flexShrink = '0';
    sentinel.style.marginLeft = '100px'; 
    row.appendChild(sentinel);

    const observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) {
            observer.disconnect();
            sentinel.remove();
            callback();
        }
    }, { root: row, rootMargin: '0px 200px 0px 0px', threshold: 0.1 }); // Se activa 200px antes del final

    observer.observe(sentinel);
    observers.push(observer);
}


// --- TV FOCUS NAVIGATION (D-Pad) LOGIC ---

document.addEventListener('keydown', (e) => {
    const isMenuOpen = sideMenu.classList.contains('open');
    
    if (e.keyCode === KEY_CODES.ESC) {
        e.preventDefault();
        if (isMenuOpen) {
            menuOverlay.click();
        } else if (document.getElementById('detail').classList.contains('active')) {
            backBtn.click();
        }
        return;
    }

    if (isMenuOpen) {
        handleMenuFocus(e);
        return;
    }
    
    if (document.getElementById('detail').classList.contains('active')) {
        // En detalle, s√≥lo navega entre elementos enfocables de arriba a abajo
        handleVerticalFocus(e, '#detail .detail-header button, #detail .detail-actions button, #detail .episode-btn');
        return;
    }

    if (document.getElementById('home').classList.contains('active') ||
        document.getElementById('favorites').classList.contains('active') ||
        document.getElementById('watched').classList.contains('active')) {
        
        handleGridFocus(e);
    }
});


function handleVerticalFocus(e, selector) {
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        e.preventDefault();
        // Filtra elementos enfocables y visibles
        const focusableElements = Array.from(document.querySelectorAll(selector))
            .filter(el => el.getAttribute('tabindex') !== '-1' && el.offsetParent !== null); 
        
        const currentIndex = focusableElements.indexOf(document.activeElement);
        let nextIndex = currentIndex;

        if (e.keyCode === KEY_CODES.UP) {
            nextIndex = Math.max(0, currentIndex - 1);
        } else if (e.keyCode === KEY_CODES.DOWN) {
            nextIndex = Math.min(focusableElements.length - 1, currentIndex + 1);
        }

        if (nextIndex !== currentIndex && focusableElements[nextIndex]) {
            focusableElements[nextIndex].focus();
            currentFocusedElement = focusableElements[nextIndex];
            // Asegura que el foco est√© visible verticalmente
            focusableElements[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}

/**
 * Funci√≥n para manejar el foco D-Pad en las cuadr√≠culas (carruseles)
 * Optimizado para movimiento suave entre filas.
 */
function handleGridFocus(e) {
    const currentActive = document.activeElement;
    const focusableCards = Array.from(document.querySelectorAll('.card'));
    const bannerElements = [document.getElementById('hamburger-btn'), document.getElementById('btn-live')];
    
    // Obtener todas las filas de cards visibles
    const rowElements = Array.from(document.querySelectorAll('.row'));
    const allFocusable = [...bannerElements, ...focusableCards];
    let newFocusElement = null;

    if (!allFocusable.includes(currentActive)) {
        e.preventDefault();
        // Fallback al bot√≥n de men√∫ o banner
        (bannerElements[1] || bannerElements[0]).focus();
        currentFocusedElement = (bannerElements[1] || bannerElements[0]);
        return;
    }

    if ([KEY_CODES.LEFT, KEY_CODES.RIGHT, KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        e.preventDefault();
    }
    
    const elementRect = currentActive.getBoundingClientRect();

    // 1. Movimiento Horizontal (LEFT / RIGHT)
    if ([KEY_CODES.LEFT, KEY_CODES.RIGHT].includes(e.keyCode)) {
        for (const row of rowElements) {
            const rowCards = Array.from(row.querySelectorAll('.card'));
            const currentIndex = rowCards.indexOf(currentActive);
            
            if (currentIndex !== -1) {
                let nextCard;
                if (e.keyCode === KEY_CODES.LEFT) {
                    nextCard = rowCards[currentIndex - 1];
                } else {
                    nextCard = rowCards[currentIndex + 1];
                }
                
                if (nextCard) {
                    newFocusElement = nextCard;
                    // Scroll del contenedor de la fila para mantener el foco visible
                    row.scrollLeft += (nextCard.offsetLeft - currentActive.offsetLeft); 
                    break;
                }
                // Si llegamos al final/principio de la fila, no salimos de la fila horizontalmente
            }
        }
    }
    
    // 2. Movimiento Vertical (UP / DOWN)
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        
        let currentRowIndex = -1;
        let currentCardIndex = -1;

        // a) Identificar en qu√© fila o elemento de banner estamos
        if (currentActive === bannerElements[0] || currentActive === bannerElements[1]) {
            currentRowIndex = currentActive === bannerElements[0] ? -2 : -1;
        } else {
            rowElements.forEach((row, i) => {
                const rowCards = Array.from(row.querySelectorAll('.card'));
                const index = rowCards.indexOf(currentActive);
                if (index !== -1) {
                    currentRowIndex = i;
                    currentCardIndex = index;
                }
            });
        }

        let targetRowIndex = currentRowIndex;
        let targetCardIndex = currentCardIndex;

        if (e.keyCode === KEY_CODES.UP) {
            targetRowIndex = Math.max(-1, currentRowIndex - 1);
        } else if (e.keyCode === KEY_CODES.DOWN) {
            targetRowIndex = Math.min(rowElements.length - 1, currentRowIndex + 1);
        }

        // b) Calcular nuevo foco
        if (targetRowIndex === -2 && e.keyCode === KEY_CODES.UP) {
            // No hacer nada (tope de arriba)
            return;
        } else if (targetRowIndex === -2 && e.keyCode === KEY_CODES.DOWN) {
            newFocusElement = bannerElements[1];
        } else if (targetRowIndex === -1 && e.keyCode === KEY_CODES.UP) {
            newFocusElement = bannerElements[0]; // Hamburguesa
        } else if (targetRowIndex === -1 && e.keyCode === KEY_CODES.DOWN) {
            // Del banner a la primera fila
            if (rowElements.length > 0) {
                 // **BUG FIX:** Asegura que el foco vertical mantenga la posici√≥n horizontal (m√°s o menos)
                newFocusElement = rowElements[0].querySelector('.card');
            }
        } else if (targetRowIndex >= 0 && rowElements[targetRowIndex]) {
            // Entre filas de cards: intentar mantener el √≠ndice horizontal
            const targetRowCards = Array.from(rowElements[targetRowIndex].querySelectorAll('.card'));
            
            // Si venimos de una fila de cards, mantener el √≠ndice
            if (currentCardIndex !== -1) {
                 targetCardIndex = Math.min(currentCardIndex, targetRowCards.length - 1);
            } else {
                // Si venimos de un banner, enfocar el primer elemento de la fila
                 targetCardIndex = 0;
            }
            
            newFocusElement = targetRowCards[targetCardIndex];
        }
    }
    
    // 3. Aplicar nuevo foco
    if (newFocusElement) {
        newFocusElement.focus();
        currentFocusedElement = newFocusElement;
        
        // Asegurar la visibilidad vertical (scroll de la p√°gina)
        newFocusElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    }
}


// --- INITIALIZATION ---
async function init() {
    loader.classList.remove('hidden');
    // Carga paralela y espera
    await Promise.all([loadData(), loadM3U()]); 
    renderHome();
    loader.classList.add('hidden');
    
    // Deshabilitar navegaci√≥n en elementos ocultos al inicio
    [searchInput, ...document.querySelectorAll('.nav-link'), backBtn, document.getElementById('play-action-btn'), favBtn].forEach(el => el.setAttribute('tabindex', '-1'));
    
    // Foco inicial en el bot√≥n del men√∫
    hamburgerBtn.focus();
    currentFocusedElement = hamburgerBtn;
}

init();
</script>
</body>
</html>
