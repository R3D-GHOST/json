<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrimeBox+ Elite</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* BASE & RESET */
        *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
        :root{
            --bg: #0f171e; --bg-card: #1a242f; --accent: #00a8e1; --text: #ffffff;
            --muted: #aeb4c6; --yt-red: #ff0000; --check: #2ecc71; --progress: #f1c40f;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body, html{ font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100%; overflow: hidden; }
        main { height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 100px; scroll-behavior: smooth; }

        /* ANIMACIONES */
        .view { display: none; animation: fadeInUp 0.4s ease-out; }
        .view.active { display: block; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* HEADER */
        #heroBanner { position: relative; width: 100%; height: 400px; overflow: hidden; background: #000; }
        #heroBanner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg) 5%, transparent 80%); padding: 25px; display: flex; flex-direction: column; justify-content: flex-end; }
        .hero-overlay h1 { font-size: 2.2rem; margin-bottom: 15px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* BADGES */
        .badge { padding: 6px 14px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; width: fit-content; margin-bottom: 10px; text-transform: uppercase; }
        .tag-series { background: #6c5ce7; }
        .tag-movie { background: var(--accent); }
        .tag-live { background: var(--yt-red); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .section-title { padding: 25px 15px 10px; font-size: 1.3rem; font-weight: bold; }
        .h-scroll { display: flex; overflow-x: auto; gap: 15px; padding: 0 15px 15px; }
        .h-scroll::-webkit-scrollbar { display: none; }

        /* CARDS */
        .card { background: var(--bg-card); border-radius: 10px; overflow: hidden; position: relative; flex: 0 0 150px; transition: transform 0.2s; }
        .card:active { transform: scale(0.95); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card-info { padding: 12px; font-size: 0.85rem; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.9)); position: absolute; bottom: 0; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* SELECTOR DE EPISODIOS PREMIUM */
        #epList { padding: 10px 0; }
        .ep-card { display: flex; background: #1e2936; border-radius: 12px; margin-bottom: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; position: relative; }
        .ep-card:active { background: #2a3746; }
        .ep-thumb { width: 140px; height: 80px; flex-shrink: 0; position: relative; }
        .ep-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ep-info { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .ep-info h4 { font-size: 0.95rem; margin-bottom: 4px; color: #eee; }
        
        /* INDICADORES DE VISTO */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-text { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: flex; align-items: center; }
        .dot-visto { background: var(--check); box-shadow: 0 0 8px var(--check); }
        .dot-mitad { background: var(--progress); box-shadow: 0 0 8px var(--progress); }
        .dot-nuevo { background: #555; }

        /* REPRODUCTOR MASTER */
        #playerView { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; align-items: center; justify-content: center; }
        #mainVideo { width: 100%; height: 100%; }
        .player-ui { position: absolute; inset: 0; background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 50%, rgba(0,0,0,0.9) 100%); display: flex; flex-direction: column; justify-content: space-between; padding: 35px; transition: opacity 0.5s ease; z-index: 10; }
        .player-ui.hidden { opacity: 0; cursor: none; pointer-events: none; }
        .ui-center { display: flex; justify-content: center; align-items: center; gap: 60px; font-size: 3.5rem; }
        .prog-container { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; }
        .prog-bar { height: 100%; background: var(--accent); width: 0%; border-radius: 4px; position: relative; }

        /* NAV */
        nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(15, 23, 30, 0.95); backdrop-filter: blur(20px); display: flex; border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); font-size: 0.75rem; transition: 0.3s; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.5rem; margin-bottom: 6px; }

        #detailView { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; padding-bottom: 40px; }
        .btn-action { background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; padding: 18px; border-radius: 10px; font-weight: bold; width: 100%; border: none; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(0, 168, 225, 0.4); }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 15px; }
    </style>
</head>
<body>

    <div id="playerView">
        <video id="mainVideo" playsinline></video>
        <div class="player-ui" id="playerUI">
            <div class="ui-top">
                <button onclick="exitPlayer()" style="background:none; border:none; color:white; font-size:2rem;"><i class="fas fa-chevron-left"></i></button>
                <span id="playerTitle" style="font-weight:bold; margin-left:20px; font-size: 1.3rem;"></span>
            </div>
            <div class="ui-center">
                <i class="fas fa-backward" onclick="skipVideo(-10)"></i>
                <i class="fas fa-play" id="playIcon" onclick="togglePlay()"></i>
                <i class="fas fa-forward" onclick="skipVideo(10)"></i>
            </div>
            <div class="ui-bottom">
                <div class="prog-container" id="progCont" onclick="seek(event)"><div class="prog-bar" id="progFill"></div></div>
                <div style="display:flex; justify-content:space-between; font-size:1rem; margin-top:15px; color: #bbb;">
                    <span id="curTime">00:00</span><span id="durTime">00:00</span>
                </div>
            </div>
        </div>
    </div>

    <main id="mainScroll">
        <div id="homeView" class="view active">
            <div id="heroBanner"></div>
            <div id="homeSections"></div>
        </div>
        <div id="gridView" class="view">
            <h2 id="gridTitle" class="section-title"></h2>
            <div id="dynamicGrid" class="grid"></div>
        </div>
        <div id="searchView" class="view">
            <div style="padding:15px; position:sticky; top:0; background:var(--bg); z-index:100;">
                <input type="text" id="searchInput" placeholder="Películas, series, canales..." style="width:100%; padding:16px; border-radius:12px; background:var(--bg-card); color:white; border:none; outline:none; font-size:1rem;">
            </div>
            <div id="searchGrid" class="grid"></div>
        </div>
    </main>

    <div id="detailView">
        <button onclick="closeDetail()" style="position:absolute; top:20px; left:20px; z-index:10; background:rgba(0,0,0,0.6); border:none; color:white; width:45px; height:45px; border-radius:50%;"><i class="fas fa-times"></i></button>
        <div style="width:100%; height:380px; position:relative;">
            <img id="detImg" style="width:100%; height:100%; object-fit:cover;">
            <div style="position:absolute; inset:0; background:linear-gradient(0deg, var(--bg) 15%, transparent);"></div>
        </div>
        <div style="padding:20px; transform: translateY(-50px);">
            <div id="detBadgeArea"></div>
            <h2 id="detTitle" style="font-size:2.2rem; margin-top:10px;"></h2>
            <p id="detDesc" style="color:var(--muted); margin:20px 0; line-height:1.6; font-size:1rem;"></p>
            <div id="mainAction"></div>
            <h3 class="section-title" id="epTitle" style="padding-left:0; display:none;">Episodios</h3>
            <div id="epList"></div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="switchTab('home', this)"><i class="fas fa-home"></i><span>Inicio</span></div>
        <div class="nav-item" onclick="switchTab('series', this)"><i class="fas fa-tv"></i><span>Series</span></div>
        <div class="nav-item" onclick="switchTab('movies', this)"><i class="fas fa-film"></i><span>Cine</span></div>
        <div class="nav-item" onclick="switchTab('channels', this)"><i class="fas fa-broadcast-tower"></i><span>En Vivo</span></div>
        <div class="nav-item" onclick="switchTab('search', this)"><i class="fas fa-search"></i><span>Buscar</span></div>
    </nav>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const DATA_JSON = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        const M3U_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";

        let db = { all: [], series: [], movies: [], channels: [] };
        let activeTab = 'home', currentItem = null, currentEpIdx = 0, uiTimer;
        let loadedCount = 0;
        let userData = JSON.parse(localStorage.getItem('pb_user_progress') || '{}');
        
        const video = document.getElementById('mainVideo');
        const pView = document.getElementById('playerView');
        const hls = new Hls();

        async function init() {
            try {
                const [r1, r2] = await Promise.all([
                    fetch(DATA_JSON).then(r=>r.json()),
                    fetch(M3U_URL).then(r=>r.text())
                ]);
                db.series = r1.filter(i => i.episodes).map(i => ({...i, type:'Serie'}));
                db.movies = r1.filter(i => !i.episodes).map(i => ({...i, type:'Peli'}));
                db.channels = parseM3U(r2);
                db.all = [...db.series, ...db.movies, ...db.channels];
                renderHero();
                renderHome();
                setupScroll();
            } catch(e) { console.error(e); }
        }

        function parseM3U(text) {
            const lines = text.split('\n');
            let res = [], cur = null;
            lines.forEach(l => {
                if(l.includes('#EXTINF')) {
                    cur = { title: l.split(',')[1]?.trim(), img: l.match(/tvg-logo="([^"]*)"/)?.[1], isChannel: true, isEvent: l.toLowerCase().includes('group-title="evento"'), type: 'Live' };
                } else if(l.startsWith('http') && cur) {
                    cur.url = l.trim(); res.push(cur); cur = null;
                }
            });
            return res;
        }

        function saveProgress() {
            if(!currentItem) return;
            const id = currentItem.isNowPlayingSeries ? `${currentItem.title}_ep${currentEpIdx}` : currentItem.title;
            const progress = video.currentTime / video.duration;
            userData[id] = {
                time: video.currentTime,
                total: video.duration,
                status: progress > 0.9 ? 'visto' : (progress > 0.1 ? 'mitad' : 'nuevo')
            };
            localStorage.setItem('pb_user_progress', JSON.stringify(userData));
        }

        function playMedia(url, title, isSeries = false, epIdx = 0) {
            currentItem.isNowPlayingSeries = isSeries;
            currentEpIdx = epIdx;
            document.getElementById('playerTitle').textContent = title;
            pView.style.display = 'flex';
            
            if (pView.requestFullscreen) pView.requestFullscreen();
            else if (pView.webkitRequestFullscreen) pView.webkitRequestFullscreen();

            if (Hls.isSupported() && (url.includes('.m3u8') || url.includes('.ts'))) {
                hls.loadSource(url); hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => startAtSaved(isSeries, epIdx));
            } else {
                hls.detachMedia(); video.src = url; 
                video.onloadedmetadata = () => startAtSaved(isSeries, epIdx);
            }
            showUI();
        }

        function startAtSaved(isSeries, epIdx) {
            const id = isSeries ? `${currentItem.title}_ep${epIdx}` : currentItem.title;
            if(userData[id]) video.currentTime = userData[id].time;
            video.play();
        }

        function togglePlay() {
            if (video.paused) { video.play(); document.getElementById('playIcon').className = 'fas fa-pause'; }
            else { video.pause(); document.getElementById('playIcon').className = 'fas fa-play'; }
            showUI();
        }

        function exitPlayer() {
            saveProgress();
            video.pause();
            pView.style.display = 'none';
            if (document.fullscreenElement) document.exitFullscreen();
            if(currentItem.episodes) openDetail(currentItem); // Refrescar indicadores
        }

        function showUI() {
            const ui = document.getElementById('playerUI');
            ui.classList.remove('hidden');
            clearTimeout(uiTimer);
            uiTimer = setTimeout(() => { if (!video.paused) ui.classList.add('hidden'); }, 3000);
        }

        video.onended = () => {
            saveProgress();
            if (currentItem.isNowPlayingSeries && currentItem.episodes[currentEpIdx + 1]) {
                const next = currentEpIdx + 1;
                playMedia(currentItem.episodes[next].video_url, `Cap ${next + 1} - ${currentItem.title}`, true, next);
            } else { exitPlayer(); }
        };

        video.ontimeupdate = () => {
            const perc = (video.currentTime / video.duration) * 100;
            document.getElementById('progFill').style.width = (perc || 0) + '%';
            document.getElementById('curTime').textContent = formatTime(video.currentTime);
            document.getElementById('durTime').textContent = formatTime(video.duration);
            if(Math.floor(video.currentTime) % 10 === 0) saveProgress();
        };

        function formatTime(secs) {
            if (isNaN(secs)) return "00:00";
            const m = Math.floor(secs / 60), s = Math.floor(secs % 60);
            return (m < 10 ? "0" + m : m) + ":" + (s < 10 ? "0" + s : s);
        }

        function skipVideo(val) { video.currentTime += val; showUI(); }
        function seek(e) {
            const rect = document.getElementById('progCont').getBoundingClientRect();
            video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
        }

        // --- RENDERIZADO Y SCROLL DE 30 EN 30 ---
        function renderHero() {
            const h = document.getElementById('heroBanner');
            const event = db.channels.find(c => c.isEvent) || db.movies[0];
            h.innerHTML = `
                <img src="${event.img || event.coverImage}">
                <div class="hero-overlay">
                    <div class="badge ${event.isEvent?'tag-live':'tag-movie'}">${event.isEvent?'EN VIVO':'DESTACADO'}</div>
                    <h1>${event.title}</h1>
                    <button onclick="heroAction()" class="btn-action" style="width:fit-content; padding:12px 35px;">VER AHORA</button>
                </div>`;
            window.heroAction = () => { currentItem = event; playMedia(event.url || event.video_url, event.title); };
        }

        function renderHome() {
            const container = document.getElementById('homeSections'); container.innerHTML = '';
            const sections = [{t:"En Vivo", d:db.channels}, {t:"Series", d:db.series}, {t:"Películas", d:db.movies}];
            sections.forEach(s => {
                const wrap = document.createElement('div');
                wrap.innerHTML = `<h2 class="section-title">${s.t}</h2><div class="h-scroll"></div>`;
                s.d.slice(0,15).forEach(item => wrap.querySelector('.h-scroll').appendChild(createCard(item)));
                container.appendChild(wrap);
            });
        }

        function createCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<img src="${item.img || item.coverImage}"><div class="card-info">${item.title}</div>`;
            card.onclick = () => openDetail(item);
            return card;
        }

        function openDetail(item) {
            currentItem = item;
            document.getElementById('detTitle').textContent = item.title;
            document.getElementById('detImg').src = item.img || item.coverImage;
            document.getElementById('detDesc').textContent = item.description || "Contenido disponible en PrimeBox+ Elite.";
            document.getElementById('detBadgeArea').innerHTML = `<span class="badge ${item.episodes?'tag-series':'tag-movie'}">${item.type}</span>`;
            
            const action = document.getElementById('mainAction');
            const list = document.getElementById('epList');
            const epTitle = document.getElementById('epTitle');
            action.innerHTML = ''; list.innerHTML = '';

            if(item.episodes) {
                epTitle.style.display = 'block';
                action.innerHTML = `<button onclick="playMedia('${item.episodes[0].video_url}', 'Cap 1 - ${item.title}', true, 0)" class="btn-action"><i class="fas fa-play"></i>  COMENZAR SERIE</button>`;
                item.episodes.forEach((ep, i) => {
                    const id = `${item.title}_ep${i}`;
                    const prog = userData[id] || {status: 'nuevo'};
                    const div = document.createElement('div'); 
                    div.className = 'ep-card';
                    div.onclick = () => playMedia(ep.video_url, `Cap ${i+1} - ${item.title}`, true, i);
                    div.innerHTML = `
                        <div class="ep-thumb"><img src="${item.img || item.coverImage}"></div>
                        <div class="ep-info">
                            <h4>Capítulo ${i+1}</h4>
                            <div class="status-text">
                                <span class="status-dot dot-${prog.status}"></span>
                                <span style="color:${prog.status==='visto'?'var(--check)':(prog.status==='mitad'?'var(--progress)':'#777')}">${prog.status}</span>
                            </div>
                        </div>`;
                    list.appendChild(div);
                });
            } else {
                epTitle.style.display = 'none';
                const id = item.title;
                const prog = userData[id] || {status: 'nuevo'};
                action.innerHTML = `
                    <button onclick="playMedia('${item.url || item.video_url}', '${item.title}')" class="btn-action">
                        <i class="fas fa-play"></i>  ${prog.status === 'mitad' ? 'CONTINUAR' : 'REPRODUCIR'}
                    </button>
                    <div class="status-text" style="justify-content:center; margin-top:15px;">
                        <span class="status-dot dot-${prog.status}"></span> ${prog.status}
                    </div>`;
            }
            document.getElementById('detailView').style.display = 'block';
        }

        function switchTab(tab, el) {
            activeTab = tab; loadedCount = 0;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            
            if(tab === 'home') document.getElementById('homeView').classList.add('active');
            else if(tab === 'search') document.getElementById('searchView').classList.add('active');
            else {
                document.getElementById('gridView').classList.add('active');
                document.getElementById('gridTitle').textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
                document.getElementById('dynamicGrid').innerHTML = '';
                loadMore();
            }
        }

        function loadMore() {
            const grid = document.getElementById('dynamicGrid');
            const data = db[activeTab];
            const nextBatch = data.slice(loadedCount, loadedCount + 30);
            nextBatch.forEach(item => grid.appendChild(createCard(item)));
            loadedCount += nextBatch.length;
        }

        function setupScroll() {
            document.getElementById('mainScroll').onscroll = (e) => {
                const el = e.target;
                if(activeTab !== 'home' && el.scrollTop + el.clientHeight >= el.scrollHeight - 400) {
                    if (loadedCount < db[activeTab].length) loadMore();
                }
            };
        }

        function closeDetail() { document.getElementById('detailView').style.display = 'none'; }
        
        document.getElementById('searchInput').oninput = (e) => {
            const q = e.target.value.toLowerCase();
            const grid = document.getElementById('searchGrid'); grid.innerHTML = '';
            if(q.length < 2) return;
            db.all.filter(i => i.title.toLowerCase().includes(q)).forEach(item => grid.appendChild(createCard(item)));
        };

        pView.addEventListener('mousemove', showUI);
        pView.addEventListener('touchstart', showUI);
        init();
    </script>
</body>
</html>
