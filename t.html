<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeBox+ | TV Edition</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f171e;
            --bg-card: #1a242f;
            --accent: #00a8e1;
            --text: #ffffff;
            --muted: #aeb4c6;
            --nav-height: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
        }

        /* Enfoque para Mando TV */
        :focus {
            transform: scale(1.08);
            box-shadow: 0 0 0 4px var(--accent) !important;
            z-index: 99;
            background-color: var(--bg-card) !important;
        }

        /* Contenedores Principales */
        #app-container { height: 100vh; display: flex; flex-direction: column; }
        main { flex: 1; overflow-y: auto; padding-bottom: var(--nav-height); scroll-behavior: smooth; }

        .view { display: none; padding: 20px 4%; }
        .view.active { display: block; }

        /* Navegación Inferior (Menú Inicio) */
        nav {
            position: fixed; bottom: 0; width: 100%; height: var(--nav-height);
            background: #000; display: flex; justify-content: center; align-items: center;
            gap: 20px; z-index: 1000;
        }
        .nav-item {
            color: var(--muted); padding: 10px 20px; border-radius: 8px;
            text-align: center; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; font-size: 0.8rem;
        }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--accent); }

        /* Grid de Contenido */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; margin-top: 20px;
        }

        .card {
            background: var(--bg-card); border-radius: 8px; overflow: hidden;
            transition: 0.2s; cursor: pointer; position: relative;
        }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card-info { padding: 10px; font-size: 0.9rem; font-weight: bold; }

        /* Vista Detalle (Inmersiva) */
        #detailView {
            position: fixed; inset: 0; background: var(--bg-primary);
            z-index: 2000; overflow-y: auto; padding: 40px;
        }
        .detail-layout { display: flex; gap: 40px; }
        .detail-poster { width: 300px; border-radius: 12px; }
        .detail-info { flex: 1; }
        .detail-title { font-size: 3rem; margin-bottom: 10px; }
        
        /* Lista de Capítulos Vertical (Mando TV style) */
        .episode-list { margin-top: 30px; display: flex; flex-direction: column; gap: 10px; }
        .episode-item {
            background: var(--bg-card); padding: 15px 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }

        .btn-play {
            background: var(--accent); color: white; border: none;
            padding: 15px 30px; border-radius: 5px; font-weight: bold;
            font-size: 1.2rem; cursor: pointer; margin-bottom: 20px;
        }

        /* Buscador */
        #search-input {
            width: 100%; padding: 20px; background: var(--bg-card);
            border: 2px solid transparent; color: white; font-size: 1.5rem;
            border-radius: 10px; margin-bottom: 30px;
        }

        #loading { text-align: center; padding: 20px; color: var(--accent); }
    </style>
</head>
<body>

<div id="app-container">
    <main id="scroll-container">
        <div id="home" class="view active">
            <h1 id="section-title">Inicio</h1>
            <div id="main-grid" class="grid"></div>
            <div id="loading" style="display:none;"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>
        </div>

        <div id="search" class="view">
            <input type="text" id="search-input" placeholder="Escribe para buscar películas o series...">
            <div id="search-grid" class="grid"></div>
        </div>
    </main>

    <div id="detailView" style="display: none;">
        <button class="btn-play" id="btn-back-detail" onclick="closeDetail()">❮ Volver (Esc)</button>
        <div class="detail-layout">
            <img id="det-img" class="detail-poster" src="" alt="">
            <div class="detail-info">
                <h1 id="det-title" class="detail-title"></h1>
                <p id="det-desc" style="color: var(--muted); margin-bottom: 20px;"></p>
                <div id="action-buttons">
                    <button class="btn-play" id="btn-main-action"><i class="fas fa-play"></i> Reproducir</button>
                    <button class="btn-play" id="btn-fav" style="background:#333;"><i class="fas fa-heart"></i> Favoritos</button>
                </div>
                
                <div id="episodes-container">
                    <h3>Capítulos</h3>
                    <div id="det-episodes" class="episode-list"></div>
                </div>
            </div>
        </div>
    </div>

    <nav id="navbar">
        <div class="nav-item active" data-view="home" tabindex="0" onclick="changeTab('home')">
            <i class="fas fa-house"></i><span>Inicio</span>
        </div>
        <div class="nav-item" data-view="series" tabindex="0" onclick="changeTab('series')">
            <i class="fas fa-tv"></i><span>Series</span>
        </div>
        <div class="nav-item" data-view="movies" tabindex="0" onclick="changeTab('movies')">
            <i class="fas fa-film"></i><span>Películas</span>
        </div>
        <div class="nav-item" data-view="favorites" tabindex="0" onclick="changeTab('favorites')">
            <i class="fas fa-heart"></i><span>Favoritos</span>
        </div>
        <div class="nav-item" data-view="search" tabindex="0" onclick="changeTab('search')">
            <i class="fas fa-search"></i><span>Buscar</span>
        </div>
    </nav>
</div>

<script>
    const DATA_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
    let allData = [];
    let currentFiltered = [];
    let page = 0;
    const step = 30;
    let currentTab = 'home';
    let favorites = JSON.parse(localStorage.getItem('favs')) || [];

    // --- CARGA DE DATOS ---
    async function init() {
        try {
            const res = await fetch(DATA_URL);
            allData = await res.json();
            renderGrid();
        } catch (e) { console.error("Error cargando datos"); }
    }

    // --- NAVEGACIÓN ---
    function changeTab(tab) {
        currentTab = tab;
        page = 0;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        
        const activeNav = document.querySelector(`[data-view="${tab}"]`);
        if(activeNav) activeNav.classList.add('active');

        if(tab === 'search') {
            document.getElementById('search').classList.add('active');
            document.getElementById('search-input').focus();
        } else {
            document.getElementById('home').classList.add('active');
            filterData(tab);
        }
    }

    function filterData(tab) {
        if(tab === 'home') currentFiltered = allData;
        else if(tab === 'series') currentFiltered = allData.filter(i => i.episodes?.length > 0);
        else if(tab === 'movies') currentFiltered = allData.filter(i => !i.episodes || i.episodes.length === 0);
        else if(tab === 'favorites') currentFiltered = favorites;
        
        document.getElementById('section-title').innerText = tab.toUpperCase();
        document.getElementById('main-grid').innerHTML = "";
        renderGrid();
    }

    function renderGrid() {
        const grid = currentTab === 'search' ? document.getElementById('search-grid') : document.getElementById('main-grid');
        const start = page * step;
        const toLoad = currentFiltered.slice(start, start + step);

        toLoad.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.tabIndex = 0;
            card.innerHTML = `
                <img src="${item.coverImage}" loading="lazy">
                <div class="card-info">${item.title}</div>
            `;
            card.onclick = () => openDetail(item);
            card.onkeydown = (e) => { if(e.key === 'Enter') openDetail(item); };
            grid.appendChild(card);
        });
    }

    // --- VISTA DETALLE ---
    function openDetail(item) {
        const dv = document.getElementById('detailView');
        dv.style.display = 'block';
        document.getElementById('det-img').src = item.coverImage;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.description || "Sin descripción disponible.";
        
        const epContainer = document.getElementById('det-episodes');
        const epSection = document.getElementById('episodes-container');
        epContainer.innerHTML = "";

        if(item.episodes && item.episodes.length > 0) {
            epSection.style.display = "block";
            item.episodes.forEach((ep, idx) => {
                const epDiv = document.createElement('div');
                epDiv.className = 'episode-item';
                epDiv.tabIndex = 0;
                epDiv.innerHTML = `<span>Capítulo ${idx + 1}: ${ep.title}</span> <i class="fas fa-play"></i>`;
                epDiv.onclick = () => window.open(ep.video_url, '_blank');
                epContainer.appendChild(epDiv);
            });
            document.getElementById('btn-main-action').onclick = () => epContainer.firstChild.click();
        } else {
            epSection.style.display = "none";
            document.getElementById('btn-main-action').onclick = () => window.open(item.video_url, '_blank');
        }

        // Favoritos logic
        const isFav = favorites.some(f => f.title === item.title);
        const fBtn = document.getElementById('btn-fav');
        fBtn.style.color = isFav ? "var(--accent)" : "white";
        fBtn.onclick = () => toggleFav(item);

        document.getElementById('btn-main-action').focus();
    }

    function closeDetail() {
        document.getElementById('detailView').style.display = 'none';
        const activeView = document.querySelector('.view.active');
        const firstCard = activeView.querySelector('.card');
        if(firstCard) firstCard.focus();
    }

    function toggleFav(item) {
        const index = favorites.findIndex(f => f.title === item.title);
        if(index > -1) favorites.splice(index, 1);
        else favorites.push(item);
        localStorage.setItem('favs', JSON.stringify(favorites));
        openDetail(item); // Refresh UI
    }

    // --- BUSCADOR ---
    document.getElementById('search-input').oninput = (e) => {
        const q = e.target.value.toLowerCase();
        document.getElementById('search-grid').innerHTML = "";
        page = 0;
        if(q.length > 2) {
            currentFiltered = allData.filter(i => i.title.toLowerCase().includes(q));
            renderGrid();
        }
    };

    // --- CONTROL DE MANDO (BACK / ESC) ---
    window.addEventListener('keydown', (e) => {
        if (e.key === "Escape" || e.key === "Backspace" || e.keyCode === 10009 || e.keyCode === 461) {
            if (document.getElementById('detailView').style.display === 'block') {
                e.preventDefault();
                closeDetail();
            } else if (currentTab !== 'home') {
                e.preventDefault();
                changeTab('home');
            }
        }
        
        // Scroll infinito al llegar al final del grid
        const container = document.getElementById('scroll-container');
        if (container.scrollTop + container.clientHeight >= container.scrollHeight - 100) {
            if((page + 1) * step < currentFiltered.length) {
                page++;
                renderGrid();
            }
        }
    });

    init();
</script>

</body>
</html>
