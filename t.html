<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeBox+ | Streaming Premium</title>
    <meta name="theme-color" content="#0f171e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-app-capable" content="yes">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        /* ------------------------------------------- */
        /* üé® CSS GLOBAL Y VARIABLES - ESTILO AMAZON PRIME VIDEO */
        /* ------------------------------------------- */
        *{ box-sizing:border-box; margin:0; padding:0; }
        :root{
            /* Colores de Amazon Prime Video */
            --bg-primary: #0f171e;
            --bg-card: #1a242f;
            --bg-darker: #000000;
            --text: #ffffff;
            --muted: #aeb4c6;
            --accent: #00a8e1;
            --accent-2: #4ec2e7;
            --shadow-dark: rgba(0, 0, 0, 0.9);
            --shadow-accent: rgba(0, 168, 225, 0.5);
            --nav-height: 60px;
            --watched-color: #3b4d61;
        }
        /* üöÄ BASE: ¬°CLAVE! Desactivar todo scroll en el body y html */
        body, html{
            font-family:'Inter','Poppins',sans-serif;
            background:var(--bg-primary);
            color:var(--text);
            height: 100%;
            width: 100%;
            overflow: hidden;
            scroll-behavior:smooth;
            line-height:1.45;
        }
        /* üíª Contenedores de Vistas */
        main{
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding-bottom: 0;
            overflow: hidden;
        }
        #mainView, #searchView, #detailView {
            height: 100%;
            width: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
            padding-bottom: calc(var(--nav-height) + 10px);
            scroll-behavior: smooth;
        }

        /* ------------------------------------------- */
        /* --- üé• ESTILOS DEL REPRODUCTOR DE VIDEO --- */
        /* ------------------------------------------- */
        #playerView {
            position: fixed;
            inset: 0;
            background: var(--bg-darker);
            z-index: 500;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-height: 100%;
            aspect-ratio: 16 / 9;
            background-color: var(--bg-darker);
            overflow: hidden;
            cursor: pointer;
        }

        #videoPlayer {
            width: 100%;
            height: 100%;
            display: block;
            background-color: transparent;
        }
        /* Icono de Play/Pause Central */
        #playPauseOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--text);
            font-size: 3rem;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
            pointer-events: none; /* Importante para que el clic pase al video */
            background: rgba(0, 0, 0, 0.4);
            border-radius: 50%;
            padding: 20px;
        }
        #videoContainer:hover #playPauseOverlay {
            opacity: 1;
        }
        .player-controls {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.0);
            opacity: 1;
            transition: opacity 0.3s ease-in-out, background 0.5s;
            padding: 15px;
            pointer-events: none; /* Permite clic a trav√©s por defecto */
        }

        .player-controls.hidden {
            opacity: 0;
        }
        .controls-top, .controls-bottom {
            pointer-events: auto; /* Activar interacci√≥n en barras */
        }

        /* Barra Superior (T√≠tulo y Bot√≥n de Salida) */
        .controls-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(0deg, transparent, rgba(0, 0, 0, 0.5) 70%);
            padding: 10px 0;
            margin: -15px;
            padding: 15px;
        }

        #playerBackBtn {
            font-size: 1.5rem;
            color: var(--text);
            cursor: pointer;
            transition: color 0.2s;
            pointer-events: auto;
        }

        #playerTitle {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            flex-grow: 1;
            padding-left: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Barra Inferior (Progreso y Botones) */
        .controls-bottom {
            background: linear-gradient(180deg, transparent, rgba(0, 0, 0, 0.5) 70%);
            padding: 15px 0;
            margin: -15px;
            padding: 15px;
        }

        /* Barra de Progreso */
        #progressBarContainer {
            width: 100%;
            height: 6px;
            background: var(--bg-card);
            cursor: pointer;
            margin-bottom: 15px;
            border-radius: 3px;
            position: relative;
            pointer-events: auto;
        }

        #progressBar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            border-radius: 3px;
            transition: width 0.1s linear;
        }

        #progressHandle {
            position: absolute;
            top: 50%;
            right: 0;
            transform: translate(50%, -50%);
            width: 16px;
            height: 16px;
            background: var(--accent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.1s;
        }

        #progressBarContainer:hover #progressHandle {
            opacity: 1;
        }

        /* Tiempo y Botones de Cap√≠tulo */
        .controls-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
        }

        #currentTime, #durationTime {
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .chapter-info {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
            flex-grow: 1;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 0 15px;
        }

        #nextChapterBtn {
            background: var(--accent);
            color: var(--text);
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, transform 0.2s;
            opacity: 0;
            pointer-events: none;
        }

        #nextChapterBtn.show {
            opacity: 1;
            pointer-events: auto;
        }

        #nextChapterBtn:hover {
            background: var(--accent-2);
            transform: translateY(-1px);
        }

        /* Ocultar controles nativos */
        #videoPlayer::-webkit-media-controls { display: none !important; }
        #videoPlayer { pointer-events: auto; }

        /* Estilos del resto de componentes (Minimizado para ahorrar espacio) */
        #searchView { position: fixed; inset: 0; background: var(--bg-primary); z-index: 55; padding-top: 24px; display: none; padding-bottom: calc(24px + var(--nav-height)); animation: fadeIn .3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes fadeIn {from{opacity:0; transform: translateY(10px);} to{opacity:1; transform: translateY(0);}}
        #searchHeader { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 0 3vw; position: sticky; top: 0; background: var(--bg-primary); z-index: 60; padding-top: 20px; padding-bottom: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5); }
        #backFromSearch { font-size: 1.5rem; color: var(--muted); cursor: pointer; display: none; }
        #searchInput { flex-grow: 1; padding: 12px 18px; border-radius: 6px; border: 2px solid var(--bg-card); font-size: 1.05rem; background: var(--bg-card); color: var(--text); transition: border-color .3s, box-shadow .3s; }
        #searchInput:focus { border-color: var(--accent); box-shadow: 0 0 8px var(--shadow-accent); outline: none; }
        #searchResultsTitle { font-size: 1.4rem; padding: 0 3vw; margin-bottom: 15px; color: var(--text); font-weight: 600; }
        #searchResultsGrid { padding: 0 3vw; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        #mainView { padding-top: 0; transition: opacity 0.3s ease-out; }
        .content-section { padding: 15px 0 5px 0; margin-bottom: 0px; }
        .section-title { font-size: 1.6rem; font-weight: 700; padding: 0 3vw; margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 14px; }
        .horizontal-scroll { display: flex; overflow-x: scroll; padding: 10px 3vw; gap: 15px; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .horizontal-scroll::-webkit-scrollbar { display: none; }
        .card{ flex: 0 0 140px; background:var(--bg-card); border-radius:4px; overflow:hidden; cursor:pointer; transition:transform .3s cubic-bezier(0.25, 0.46, 0.45, 0.94), box-shadow .3s ease-out, opacity .5s; opacity:0; box-shadow:0 1px 4px rgba(0,0,0,.5); }
        .card.show{ opacity:1; transform: scale(0.98); }
        .card:hover{ transform:scale(1.08); box-shadow:0 10px 20px var(--shadow-accent); z-index: 10; outline: none; }
        .card img{ display:block; width:100%; height:200px; object-fit:cover; transition:transform .3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .card:hover img{ transform: scale(1.05); }
        .info{padding:8px 6px;min-height:55px; background: rgba(0,0,0,0.2);}
        .info h3{ font-size:0.95rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .info span{display:block;margin-top:2px;color:var(--muted);font-size:.8rem;font-weight:300;}
        .hero-static-container { position: relative; width: 100%; margin-bottom: 20px; height: 350px; overflow: hidden; }
        .detail-hero-container { position: relative; width: 100%; height: 300px; overflow: hidden; z-index: 2; }
        .detail-hero-container img, .hero-static-container img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.65); transition: filter 0.3s; }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg-primary) 0%, rgba(15,23,30,0.5) 50%, rgba(15,23,30,0) 100%); display: flex; flex-direction: column; justify-content: flex-end; padding: 30px 3vw; }
        .detail-hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg-primary) 0%, rgba(15,23,30,0) 50%); padding: 30px 3vw; display: flex; align-items: flex-end; }
        .hero-overlay h1, .detail-hero-overlay h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 8px; max-height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .hero-overlay p { color: var(--muted); font-size: 1rem; margin-bottom: 18px; max-height: 2.8em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .detail-hero-overlay h1 { font-size: 2rem; margin-bottom: 0; }
        .play-button-hero { background: var(--text); color: var(--bg-primary); padding: 12px 25px; border-radius: 4px; font-weight: 700; font-size: 1.05rem; cursor: pointer; transition: background-color .2s, transform .2s, box-shadow .2s; border: none; display: flex; align-items: center; gap: 8px; width: fit-content; }
        .play-button-hero:hover { background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.5); }
        #bottomNav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--bg-darker); border-top: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 -4px 15px var(--shadow-dark); display: flex; justify-content: space-around; align-items: center; z-index: 100; padding: 0 5px; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px 0; flex: 1; color: var(--muted); font-size: 0.7rem; font-weight: 500; cursor: pointer; user-select: none; min-width: 0; transition: color 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.1s; }
        .nav-item i { font-size: 1.2rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--text); }
        .nav-item:hover { color: var(--text); transform: translateY(-2px); outline: none; }
        #dynamicGrid { padding: 0 3vw; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; margin-top: 20px; transition: opacity 0.5s ease-out; }
        #loadingIndicator { display: none; text-align: center; padding: 20px; color: var(--muted); font-size: 1.1rem; opacity: 0; transition: opacity 0.4s ease-in-out; }
        #loadingIndicator.show { opacity: 1; display: block; }
        #loadingIndicator i { margin-right: 10px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #detailView{ position:fixed; inset:0; background:var(--bg-primary); overflow-y:auto; display:none; z-index:200; animation:fade .3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes fade {from{opacity:0;} to{opacity:1;}}
        #detailBackground { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; transition: opacity 0.4s ease-in-out; opacity: 0; }
        #detailBackground.show { opacity: 1; }
        #detailBackground img { width: 100%; height: 100%; object-fit: cover; filter: blur(25px) brightness(0.4); opacity: 0.3; transition: all 0.4s ease-in-out; transform: scale(1.1); }
        #detailView::before { content: ''; position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at center, transparent 0%, var(--bg-primary) 80%); }
        .detail-header{ position:sticky; top:0; z-index:10; display:flex; align-items:center; gap:16px; padding:16px 3vw; background:rgba(15, 23, 30, 0.85); backdrop-filter:blur(10px); box-shadow:0 2px 10px rgba(0,0,0,.5); transition: all 0.3s ease; }
        .btn{ border:0; background:var(--accent); color:var(--text); padding:10px 18px; border-radius:4px; font-weight:600; cursor:pointer; transition: transform .2s, background-color .2s; }
        .btn:hover{background:var(--accent-2);transform:translateY(-1px);box-shadow: 0 4-5px 10px rgba(0,0,0,0.3); outline: none;}
        .detail-title{ flex:1; font-size:1.4rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; }
        .detail-main{ display:flex; flex-wrap:wrap; gap:35px; padding:35px 3vw; padding-top: 10px; position: relative; z-index: 5; background: transparent; }
        .details{flex:1 1 560px; position: relative;}
        .details h2{display:none;}
        .details p#detailDesc{ color:var(--muted); line-height:1.6; margin:10px 0; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .details p#detailGenres{color:var(--accent);font-weight:600;margin-top:15px}
        #detailActionButtons { display: flex; gap: 15px; margin-top: 20px; margin-bottom: 30px; align-items: center; }
        #reproduceBtn { background: var(--accent); color: var(--text); padding: 12px 25px; font-weight: 700; font-size: 1.05rem; display: flex; align-items: center; gap: 8px; border-radius: 4px; border: none; cursor: pointer; transition: background-color .3s, transform .3s, box-shadow .3s; }
        #reproduceBtn:hover { background: var(--accent-2); transform: translateY(-2px); box-shadow: 0 6px 12px var(--shadow-accent); outline: none; }
        #favoriteBtn { background: var(--bg-card); border: 2px solid var(--muted); border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; font-size: 1.1rem; cursor: pointer; color: var(--muted); transition: color 0.3s, background-color 0.3s, transform 0.3s, border-color 0.3s; }
        #favoriteBtn:hover { background-color: var(--accent); color: var(--text); border-color: var(--accent); transform: scale(1.1); outline: none; }
        #favoriteBtn.active { color: var(--text); background-color: var(--accent); border-color: var(--accent); transform: scale(1.15); }
        .episodes{ margin-top:26px; padding-top:18px; border-top:1px solid rgba(255,255,255,.15); }
        .episodes h3{ margin-bottom:12px; text-transform:uppercase; font-size:1.2rem; padding: 0 3vw 0 0; }
        .episodes-list{ display: flex; overflow-x: scroll; padding: 10px 3vw; gap: 15px; padding-bottom: 10px; -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        .episodes-list::-webkit-scrollbar { display: none; }
        .detail-main { padding-left: 3vw; padding-right: 3vw; }
        .episodes { margin-left: -3vw; margin-right: -3vw; padding-left: 3vw; }
        .episode-item{ flex-shrink: 0; width: 320px; background: var(--bg-card); border-radius: 8px; padding: 10px; cursor: pointer; transition: background-color .2s, transform .3s, border-color .2s, box-shadow .3s; border: 2px solid transparent; scroll-snap-align: start; display: flex; flex-direction: column; overflow: hidden; }
        .episode-item:hover, .episode-item.active { transform: scale(1.05); box-shadow: 0 0 0 4px var(--accent-2), 0 10px 20px rgba(0, 0, 0, 0.5); background-color: #2a385f; z-index: 5; outline: none; }
        .episode-item.watched { background-color: var(--watched-color); border-color: transparent; opacity: 0.9; }
        .episode-item.watched:hover { opacity: 1; }
        .episode-thumb{ width: 100%; height: 180px; overflow: hidden; border-radius: 6px; position: relative; margin-bottom: 10px; }
        .episode-thumb img{ width: 100%; height: 100%; object-fit: cover; display: block; }
        .episode-info{ flex-grow: 1; min-width: 0; padding: 0 5px; }
        .episode-info strong{ display: block; font-size: 1.1rem; font-weight: 700; color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: normal; max-height: 2.5em; line-height: 1.2; }
        .episode-info span{ display: block; font-size: 0.9rem; color: var(--muted); margin-top: 5px; }
        .play-icon{ position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.5rem; color: var(--accent); opacity: 0.8; transition: opacity 0.3s; background: rgba(0,0,0,0.5); border-radius: 50%; padding: 10px; }
        .episode-item.watched .play-icon { color: #4CAF50; font-size: 2rem; background: none; opacity: 1; }
        .episode-item:hover .play-icon { opacity: 1; }
        @media (max-width:900px){ .episode-item { width: 250px; } .episode-thumb { height: 140px; } }
        @media (max-width:680px){ .card{ flex: 1 1 auto; } .card img{ height:170px; } #dynamicGrid, #searchResultsGrid { grid-template-columns: repeat(3, 1fr); gap: 8px; } .horizontal-scroll .card { flex: 0 0 120px; } .horizontal-scroll .card img{ height:180px; } }
        @media (max-width:480px){ #dynamicGrid, #searchResultsGrid { grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); } .episode-item { width: 90vw; } .episodes-list { padding-right: 3vw; } }
    </style>
</head>
<body>
    <main>
        <div id="mainView">
            <div id="content"> </div>
            <div id="gridContainer" style="min-height: 100px;">
                <h2 id="gridTitle" class="section-title" style="display:none; padding-top: 20px;"></h2>
                <div id="dynamicGrid"></div>
            </div>
            <div id="loadingIndicator">
                <i class="fas fa-spinner"></i> Cargando m√°s contenido...
            </div>
        </div>
        <div id="searchView">
            <div id="searchHeader">
                <i class="fas fa-arrow-left" id="backFromSearch"></i>
                <input type="text" id="searchInput" placeholder="Buscar contenido, g√©nero...">
            </div>
            <h2 id="searchResultsTitle"></h2>
            <div id="searchResultsGrid">
                <p style="color:var(--muted); padding: 50px 3vw; text-align: center;">Empieza a escribir para buscar (t√≠tulo o g√©nero)...</p>
            </div>
        </div>
    </main>

    <div id="playerView">
        <div id="videoContainer">
            <video id="videoPlayer" playsinline></video>
            <i id="playPauseOverlay" class="fas fa-play"></i>
            
            <div class="player-controls" id="playerControls">
                <div class="controls-top">
                    <i class="fas fa-arrow-left" id="playerBackBtn" title="Salir del reproductor"></i>
                    <span id="playerTitle">Cargando...</span>
                </div>

                <div class="controls-bottom">
                    <div id="progressBarContainer">
                        <div id="progressBar">
                            <div id="progressHandle"></div>
                        </div>
                    </div>
                    <div class="controls-main">
                        <span id="currentTime">0:00</span>
                        
                        <span class="chapter-info" id="chapterInfo"></span>
                        <button id="nextChapterBtn" style="display:none;">
                            Siguiente Cap. <i class="fas fa-forward"></i>
                        </button>

                        <span id="durationTime">--:--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="detailBackground">
        <img id="detailBackgroundImage" src="" alt="Fondo de la portada">
    </div>
    <div id="detailView">
        <div class="detail-header">
            <button id="backBtn" class="btn">‚ùÆ Volver</button>
            <h2 id="detailTitle" class="detail-title"></h2>
        </div>
        <div id="detailHeroContainer" class="detail-hero-container">
            <img id="detailHeroImage" src="" alt="Portada de la serie/pel√≠cula">
            <div class="detail-hero-overlay">
                <h1 id="detailHeroTitle"></h1>
            </div>
        </div>
        <div class="detail-main">
            <div class="details">
                <h2 id="detailName"></h2>
                <div id="detailActionButtons">
                    <button id="reproduceBtn" style="display:none;"></button>
                    <button id="favoriteBtn"><i class="fas fa-heart"></i></button>
                </div>
                <p id="detailDesc"></p>
                <p id="detailGenres"></p>
            </div>
        </div>
        <div id="detailEpisodes" class="episodes content-section">
            <h3>Cap√≠tulos</h3>
            <div class="episodes-list horizontal-scroll"> </div>
        </div>
        <div id="recommendationsSection" class="content-section">
            <h2 class="section-title">Recomendaciones</h2>
            <div class="horizontal-scroll" id="recommendationsScroll"> </div>
        </div>
    </div>
    <nav id="bottomNav">
        <div class="nav-item active" data-tab="home">
            <i class="fas fa-house-chimney"></i> <span>Inicio</span>
        </div>
        <div class="nav-item" data-tab="series">
            <i class="fas fa-clapperboard"></i> <span>Series</span>
        </div>
        <div class="nav-item" data-tab="movies">
            <i class="fas fa-film"></i> <span>Pel√≠culas</span>
        </div>
        <div class="nav-item" data-tab="channels">
            <i class="fas fa-tv"></i> <span>Canales</span>
        </div>
        <div class="nav-item" data-tab="favorites">
            <i class="fas fa-heart"></i> <span>Favoritos</span>
        </div>
        <div class="nav-item" data-tab="search">
            <i class="fas fa-search"></i> <span>Buscar</span>
        </div>
    </nav>
    <script>
        // --- CONSTANTES Y VARIABLES ---
        // üö® CORRECCI√ìN CR√çTICA: URL de JSON para garantizar la carga.
        const ANIME_JSON = "https://raw.githubusercontent.com/R3D-GHOST/json/main/data.json";
        const M3U8_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";
        let contentData = [], series = [], movies = [], channels = [];
        let currentTab = 'home', currentItem = null;
        let allContent = [];
        const itemsPerLoad = 30;
        let currentPage = 0;
        let currentList = [];
        let isPaginating = false;

        // Referencias del DOM de Vistas
        const content = document.getElementById('content');
        const detailView = document.getElementById('detailView');
        const detailBackground = document.getElementById('detailBackground');
        const mainView = document.getElementById('mainView');
        const searchView = document.getElementById('searchView');
        const bottomNavItems = document.querySelectorAll('.nav-item');
        const dynamicGrid = document.getElementById('dynamicGrid');
        const backBtn = document.getElementById('backBtn');
        const favoriteBtn = document.getElementById('favoriteBtn');
        const reproduceBtn = document.getElementById('reproduceBtn');
        const episodesListContainer = document.querySelector('.episodes-list');

        // ** üé• Referencias del DOM del Reproductor **
        const playerView = document.getElementById('playerView');
        const videoPlayer = document.getElementById('videoPlayer');
        const playerTitle = document.getElementById('playerTitle');
        const playerBackBtn = document.getElementById('playerBackBtn');
        const progressBarContainer = document.getElementById('progressBarContainer');
        const progressBar = document.getElementById('progressBar');
        const currentTimeEl = document.getElementById('currentTime');
        const durationTimeEl = document.getElementById('durationTime');
        const chapterInfoEl = document.getElementById('chapterInfo');
        const nextChapterBtn = document.getElementById('nextChapterBtn');
        const playerControls = document.getElementById('playerControls');
        const playPauseOverlay = document.getElementById('playPauseOverlay');

        // ** üé• Variables del Reproductor **
        let hls = null;
        let currentSeries = null;
        let currentEpisodeIndex = -1;
        let progressInterval = null;
        let controlsTimeout = null;
        
        // --- FUNCIONES DE ESTADO (CACHE) ---
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return '0:00';
            const totalSeconds = Math.floor(seconds);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const remainingSeconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function getProgressKey(seriesId, episodeIndex) {
            return `animebox_progress_${seriesId}_${episodeIndex}`;
        }

        function getLastWatchedEpisodeIndex(seriesId, episodeIndex = undefined) {
            try {
                const progress = localStorage.getItem('animebox_progress');
                let progressData = progress ? JSON.parse(progress) : {};
                if (episodeIndex !== undefined) {
                    progressData[seriesId] = episodeIndex;
                    localStorage.setItem('animebox_progress', JSON.stringify(progressData));
                    return episodeIndex;
                } else {
                    return progressData[seriesId];
                }
            } catch(e) { return undefined; }
        }

        function loadPlayerProgress(seriesId, episodeIndex) {
            const key = getProgressKey(seriesId, episodeIndex);
            try {
                const progress = localStorage.getItem(key);
                return progress ? parseFloat(progress) : 0;
            } catch(e) { return 0; }
        }

        function savePlayerProgress(seriesId, episodeIndex, time) {
            const key = getProgressKey(seriesId, episodeIndex);
            try {
                if (!videoPlayer.duration || isNaN(videoPlayer.duration) || videoPlayer.duration === 0) return;
                
                // Si el tiempo restante es menor a 10 segundos, marcamos como visto
                if (videoPlayer.duration - time <= 10) {
                    saveWatchedEpisode(seriesId, episodeIndex);
                    localStorage.removeItem(key);
                } 
                // Si el tiempo es mayor a 5 segundos (no es inicio), guardamos la posici√≥n
                else if (time > 5) {
                    localStorage.setItem(key, time.toFixed(2));
                }
            } catch(e) { console.error("Error al guardar progreso:", e); }
        }

        function getWatchedEpisodes() {
            try {
                const watched = localStorage.getItem('animebox_watched');
                return watched ? JSON.parse(watched) : {};
            } catch(e) { return {}; }
        }

        function isEpisodeWatched(seriesId, episodeIndex) {
            const watched = getWatchedEpisodes();
            // La b√∫squeda debe ser robusta, ya que los √≠ndices se guardan como n√∫meros
            return watched[seriesId] && watched[seriesId].includes(episodeIndex);
        }

        function saveWatchedEpisode(seriesId, episodeIndex) {
            let watched = getWatchedEpisodes();
            if (!watched[seriesId]) { watched[seriesId] = []; }
            if (!watched[seriesId].includes(episodeIndex)) {
                watched[seriesId].push(episodeIndex);
                localStorage.setItem('animebox_watched', JSON.stringify(watched));
            }
        }
        
        function isFavorite(item) {
            try {
                const favorites = localStorage.getItem('animebox_favorites');
                const favs = favorites ? JSON.parse(favorites) : [];
                return favs.includes(item.id || item.title);
            } catch (e) { return false; }
        }

        function toggleFavorite(item) {
            try {
                const itemId = item.id || item.title;
                let favorites = localStorage.getItem('animebox_favorites');
                let favs = favorites ? JSON.parse(favorites) : [];

                if (favs.includes(itemId)) {
                    favs = favs.filter(id => id !== itemId);
                    favoriteBtn.classList.remove('active');
                } else {
                    favs.push(itemId);
                    favoriteBtn.classList.add('active');
                }
                localStorage.setItem('animebox_favorites', JSON.stringify(favs));
            } catch (e) { console.error("Error toggling favorite:", e); }
        }

        // --- FUNCIONES DE VISTAS Y NAVEGACI√ìN ---

        function showView(viewId) { 
            const views = [mainView, searchView, detailView, playerView];
            views.forEach(v => v.style.display = 'none');
            const targetView = document.getElementById(viewId);
            if (targetView) targetView.style.display = viewId === 'playerView' ? 'flex' : 'block';
        }

        function closeDetailAndUpdate() {
            if (currentItem) {
                // Forzamos la re-renderizaci√≥n del detalle (para actualizar progreso)
                // y luego volvemos a la vista principal.
                const tempItem = currentItem;
                currentItem = null; // Evitar loop
                detailView.style.display='none';
                detailBackground.classList.remove('show');
                
                // Re-renderizamos para actualizar el estado VISTO
                openDetail(tempItem); 
                setTimeout(() => {
                    detailView.style.display='none';
                    detailBackground.classList.remove('show');
                    renderCurrentTab();
                }, 100);

            } else {
                detailView.style.display='none';
                detailBackground.classList.remove('show');
                renderCurrentTab();
            }
        }

        // Eventos de Navegaci√≥n Inferior
        bottomNavItems.forEach(btn => btn.onclick = () => { 
            currentTab = btn.dataset.tab; 
            renderCurrentTab(); 
            // Cerrar detalle/player si est√° abierto
            if (detailView.style.display !== 'none') detailView.style.display = 'none';
            if (playerView.style.display !== 'none') playerBackBtn.click();
        });

        // Evento Bot√≥n Volver de Detalle
        backBtn.onclick = () => {
            detailView.style.display='none';
            detailBackground.classList.remove('show');
            renderCurrentTab();
            currentItem = null;
        };

        // --- RENDERIZADO PRINCIPAL ---

        function renderCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            card.tabIndex = 0;
            
            const coverUrl = item.coverImage || item.logo || 'https://via.placeholder.com/140x200?text=PrimeBox';

            card.innerHTML = `
                <img src="${coverUrl}" alt="${item.title}" loading="lazy" onerror="this.onerror=null;this.src='https://via.placeholder.com/140x200?text=PrimeBox';" />
                <div class="info">
                    <h3>${item.title}</h3>
                    <span>${item.year || ''}</span>
                </div>
            `;
            
            card.onclick = () => openDetail(item);

            // Efecto de carga
            setTimeout(() => card.classList.add('show'), Math.random() * 500);
            return card;
        }

        function renderSection(title, list, container) {
            const section = document.createElement('div');
            section.className = 'content-section';
            section.innerHTML = `<h2 class="section-title">${title}</h2>`;
            const scrollContainer = document.createElement('div');
            scrollContainer.className = 'horizontal-scroll';
            
            list.slice(0, 15).forEach(item => {
                scrollContainer.appendChild(renderCard(item));
            });
            section.appendChild(scrollContainer);
            container.appendChild(section);
        }
        
        function renderHomePage() {
            content.innerHTML = ''; // Limpiar el contenido

            // 1. Renderizar Carrusel Principal (Simulaci√≥n)
            const hero = document.createElement('div');
            hero.className = 'hero-static-container';
            const featuredItem = series[0] || movies[0];
            if (featuredItem) {
                hero.innerHTML = `
                    <img src="${featuredItem.coverImage}" alt="${featuredItem.title}">
                    <div class="hero-overlay">
                        <h1>${featuredItem.title}</h1>
                        <p>${featuredItem.description.substring(0, 100)}...</p>
                        <button class="play-button-hero" onclick="openDetail(allContent.find(i => i.id === '${featuredItem.id}' || i.title === '${featuredItem.title}'))">
                            <i class="fas fa-play"></i> Reproducir
                        </button>
                    </div>
                `;
                content.appendChild(hero);
            }
            
            // 2. Renderizar Secciones
            renderSection('Series en Tendencia', series.filter(i => i.genre.includes('Acci√≥n')), content);
            renderSection('Pel√≠culas Destacadas', movies.filter(i => i.genre.includes('Drama')), content);
            renderSection('Canales en Vivo', channels, content);
            renderSection('Comedias que te encantar√°n', contentData.filter(i => i.genre.includes('Comedia')), content);

            // Necesario para que el scroll se resetee correctamente
            mainView.scrollTo({top: 0, behavior: 'smooth'});
        }

        function setupGridPage(list, title) {
            document.getElementById('gridTitle').textContent = title;
            document.getElementById('gridTitle').style.display = 'block';
            dynamicGrid.innerHTML = '';
            currentList = list;
            currentPage = 0;
            loadMoreContent(); // Cargar la primera p√°gina
        }
        
        function loadMoreContent() {
            if (isPaginating) return;
            isPaginating = true;
            
            const start = currentPage * itemsPerLoad;
            const end = start + itemsPerLoad;
            const chunk = currentList.slice(start, end);

            if (chunk.length > 0) {
                const fragment = document.createDocumentFragment();
                chunk.forEach(item => fragment.appendChild(renderCard(item)));
                dynamicGrid.appendChild(fragment);
                currentPage++;
                
                // Mostrar un peque√±o retraso para simular carga
                setTimeout(() => { isPaginating = false; }, 300);
            } else {
                // No hay m√°s contenido
                isPaginating = false;
            }
            document.getElementById('loadingIndicator').classList.remove('show');
        }

        // --- Paginaci√≥n y Detecci√≥n de Scroll ---
        mainView.onscroll = () => {
            if (mainView.scrollHeight - mainView.scrollTop <= mainView.clientHeight + 100 && !isPaginating && (currentTab === 'series' || currentTab === 'movies')) {
                document.getElementById('loadingIndicator').classList.add('show');
                loadMoreContent();
            }
        };

        function renderCurrentTab(){ 
            document.querySelector('.nav-item.active')?.classList.remove('active');
            const activeNavButton = document.querySelector(`.nav-item[data-tab="${currentTab}"]`);
            if (activeNavButton) { activeNavButton.classList.add('active'); }
            
            showView('mainView');
            document.getElementById('gridContainer').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            document.getElementById('gridTitle').style.display = 'none';

            if(currentTab === 'home'){ 
                renderHomePage(); 
            } else if (currentTab === 'series') { 
                document.getElementById('content').style.display = 'none';
                document.getElementById('gridContainer').style.display = 'block';
                setupGridPage(series, 'Todas las Series');
            } else if (currentTab === 'movies') { 
                document.getElementById('content').style.display = 'none';
                document.getElementById('gridContainer').style.display = 'block';
                setupGridPage(movies, 'Todas las Pel√≠culas');
            } else if (currentTab === 'channels') { 
                document.getElementById('content').style.display = 'none';
                document.getElementById('gridContainer').style.display = 'block';
                setupGridPage(channels, 'Canales de TV');
            } else if (currentTab === 'favorites') { 
                const favoriteIds = getFavorites();
                const favoriteItems = allContent.filter(item => favoriteIds.includes(item.id || item.title));
                document.getElementById('content').style.display = 'none';
                document.getElementById('gridContainer').style.display = 'block';
                setupGridPage(favoriteItems, 'Mis Favoritos');
            } else if (currentTab === 'search') {
                showView('searchView');
            }
            
            mainView.scrollTo({top: 0, behavior: 'smooth'});
        }
        
        function getFavorites() {
            try {
                const favorites = localStorage.getItem('animebox_favorites');
                return favorites ? JSON.parse(favorites) : [];
            } catch (e) { return []; }
        }

        // --- L√ìGICA DEL REPRODUCTOR DE VIDEO (CORREGIDA Y COMPLETA) ---

        // Funci√≥n para cambiar el estado del Play/Pause
        function togglePlayPause() {
            if (videoPlayer.paused) {
                videoPlayer.play().catch(e => console.error("Error al reanudar:", e));
            } else {
                videoPlayer.pause();
            }
            updatePlayPauseOverlay();
        }

        function updatePlayPauseOverlay() {
            if (videoPlayer.paused) {
                playPauseOverlay.className = 'fas fa-play';
                playPauseOverlay.style.opacity = '1';
                playerControls.classList.remove('hidden'); // Siempre mostrar controles si est√° pausado
            } else {
                playPauseOverlay.className = 'fas fa-pause';
                // La opacidad se maneja por el temporizador de inactividad
            }
        }

        playerBackBtn.onclick = () => {
            // Detener el video y guardar el progreso
            if (currentSeries && currentEpisodeIndex !== -1) {
                savePlayerProgress(currentSeries.id || currentSeries.title, currentEpisodeIndex, videoPlayer.currentTime);
            }
            if (hls) { hls.destroy(); hls = null; }
            videoPlayer.pause();
            videoPlayer.removeAttribute('src'); // Limpiar la fuente
            clearInterval(progressInterval);
            clearTimeout(controlsTimeout);
            // Volver al detalle y actualizar la vista de progreso
            closeDetailAndUpdate();
        };

        function setupVideoPlayer(seriesItem, episodeIndex, videoUrl) {
            currentSeries = seriesItem;
            currentEpisodeIndex = episodeIndex;
            videoPlayer.pause();
            
            // Limpiar cualquier instancia HLS anterior
            if (hls) {
                hls.destroy();
                hls = null;
            }

            // Inicializaci√≥n de HLS
            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(videoUrl);
                hls.attachMedia(videoPlayer);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    loadResumePositionAndPlay(seriesItem, episodeIndex);
                });
                hls.on(Hls.Events.ERROR, function (event, data) {
                    if (data.fatal) {
                        console.error(`Error fatal de HLS: ${data.details}.`, data);
                        alert(`Error fatal de HLS: ${data.details}. Intenta recargar.`);
                        playerBackBtn.click();
                    }
                });
            } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                // Soporte nativo (Safari, iOS)
                videoPlayer.src = videoUrl;
                videoPlayer.load();
                videoPlayer.addEventListener('loadedmetadata', function() {
                    loadResumePositionAndPlay(seriesItem, episodeIndex);
                }, { once: true });
            } else {
                alert('Tu navegador no soporta HLS. No se puede reproducir el video.');
                playerBackBtn.click();
                return;
            }

            // Iniciar el temporizador para la barra de progreso y guardado
            clearInterval(progressInterval);
            progressInterval = setInterval(updatePlayerUI, 500); // Actualizaci√≥n m√°s frecuente

            // Eventos de control de UI
            videoPlayer.addEventListener('pause', updatePlayPauseOverlay);
            videoPlayer.addEventListener('play', updatePlayPauseOverlay);
        }

        function loadResumePositionAndPlay(seriesItem, episodeIndex) {
            const seriesId = seriesItem.id || seriesItem.title;
            const savedTime = loadPlayerProgress(seriesId, episodeIndex);

            if (savedTime > 0) {
                // Asegurarse de que el tiempo no exceda la duraci√≥n (con un margen de 10s)
                if (videoPlayer.duration && savedTime < videoPlayer.duration - 10) {
                    videoPlayer.currentTime = savedTime;
                }
            }
            
            // Intentar autoplay
            videoPlayer.play().then(() => {
                // Si el autoplay tiene √©xito, ocultar el overlay de pausa
                updatePlayPauseOverlay();
                showControls(); // Mostrar controles al inicio y luego ocultar
            }).catch(e => {
                console.warn("Autoplay bloqueado. El usuario debe interactuar.", e);
                updatePlayPauseOverlay();
                showControls(); // Mostrar controles si el autoplay falla
            });
            
            // Mostrar la duraci√≥n cuando los metadatos est√©n cargados
            durationTimeEl.textContent = formatTime(videoPlayer.duration);
        }

        function updatePlayerUI() {
            const duration = videoPlayer.duration;
            const currentTime = videoPlayer.currentTime;
            
            if (!duration || isNaN(duration)) return;

            // 1. Guardar progreso
            const seriesId = currentSeries.id || currentSeries.title;
            savePlayerProgress(seriesId, currentEpisodeIndex, currentTime);

            // 2. Actualizar barra de progreso
            const progress = (currentTime / duration) * 100;
            progressBar.style.width = `${progress}%`;
            
            // 3. Actualizar tiempos
            currentTimeEl.textContent = formatTime(currentTime);
            durationTimeEl.textContent = formatTime(duration);

            // 4. L√≥gica de Autoplay/Siguiente Cap√≠tulo
            const isSeries = currentSeries.episodes && currentSeries.episodes.length > 0;
            if (isSeries && currentEpisodeIndex < currentSeries.episodes.length - 1) {
                const nextIndex = currentEpisodeIndex + 1;
                
                // Mostrar bot√≥n de Siguiente Cap√≠tulo cuando falten 30 segundos
                if (duration - currentTime < 30 && duration - currentTime > 5) {
                    nextChapterBtn.textContent = `Siguiente Cap. ${nextIndex + 1}`;
                    nextChapterBtn.classList.add('show');
                    nextChapterBtn.onclick = () => playEpisode(currentSeries, nextIndex);
                } else {
                    nextChapterBtn.classList.remove('show');
                }

                // Autoplay al terminar (√∫ltimos 5 segundos)
                if (duration - currentTime <= 5 && duration - currentTime > 0) {
                    // Evita bucle si se llama varias veces al mismo tiempo
                    if (!videoPlayer.ended && !videoPlayer.paused) { 
                       videoPlayer.pause(); 
                       playEpisode(currentSeries, nextIndex);
                    }
                    return;
                }
            } else {
                nextChapterBtn.classList.remove('show');
            }

            // 5. Final de la reproducci√≥n (√∫ltimo cap√≠tulo o pel√≠cula)
            if (videoPlayer.ended) {
                saveWatchedEpisode(seriesId, currentEpisodeIndex);
                playerBackBtn.click();
            }
        }

        // L√≥gica de Controles (Mostrar/Ocultar con Inactividad y clic)
        document.getElementById('videoContainer').addEventListener('mousemove', showControls);
        document.getElementById('videoContainer').addEventListener('click', (e) => {
             // Si el clic no fue en la barra de progreso o botones, hace play/pause
             if (!e.target.closest('.controls-bottom') && e.target.id !== 'playerBackBtn' && e.target.id !== 'videoContainer') {
                togglePlayPause();
             }
             showControls(); // Mostrar controles tras la interacci√≥n
        });

        function showControls() {
            playerControls.classList.remove('hidden');
            clearTimeout(controlsTimeout);
            // Ocultar controles despu√©s de 3 segundos de inactividad, solo si NO est√° pausado
            controlsTimeout = setTimeout(() => {
                if (!videoPlayer.paused) {
                    playerControls.classList.add('hidden');
                }
            }, 3000);
        }

        // Manejar b√∫squeda en la barra de progreso
        progressBarContainer.addEventListener('click', (e) => {
            const rect = progressBarContainer.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            if (videoPlayer.duration) {
                videoPlayer.currentTime = videoPlayer.duration * pos;
            }
            showControls();
        });


        function openPlayer(seriesItem, episodeIndex) {
            const isSeries = seriesItem.episodes && seriesItem.episodes.length > 0;
            const episodeData = isSeries ? seriesItem.episodes[episodeIndex] : seriesItem;
            const videoUrl = episodeData?.video_url;

            if (!videoUrl) {
                alert('No se encontr√≥ una URL de video v√°lida para reproducir.');
                playerBackBtn.click();
                return;
            }

            showView('playerView');

            // 1. Configurar T√≠tulo del Reproductor e Info del Cap√≠tulo
            if (isSeries) {
                playerTitle.textContent = `${seriesItem.title} - Cap. ${episodeIndex + 1}`;
                chapterInfoEl.textContent = `Cap√≠tulo ${episodeIndex + 1} / ${seriesItem.episodes.length}`;
            } else {
                playerTitle.textContent = seriesItem.title;
                chapterInfoEl.textContent = seriesItem.isChannel ? 'Streaming en vivo' : 'Pel√≠cula';
                nextChapterBtn.classList.remove('show'); 
            }

            // 2. Inicializar el reproductor
            setupVideoPlayer(seriesItem, episodeIndex, videoUrl);
        }

        function playEpisode(seriesItem, index) {
            // Guardar progreso del cap√≠tulo actual antes de cambiar (solo si ya estaba reproduciendo)
            if (currentSeries && currentEpisodeIndex !== -1 && videoPlayer.currentTime > 0) {
                savePlayerProgress(currentSeries.id || currentSeries.title, currentEpisodeIndex, videoPlayer.currentTime);
            }
            openPlayer(seriesItem, index);
        }

        // --- L√≥gica de Carga de Datos y Canales ---

        async function fetchData(){ 
            document.getElementById('loadingIndicator').classList.add('show'); 
            try { 
                contentData = await (await fetch(ANIME_JSON)).json(); 
                series = contentData.filter(item => item.episodes && item.episodes.length > 0); 
                movies = contentData.filter(item => !item.episodes || item.episodes.length === 0); 
                await fetchChannels(); // Cargar canales
                allContent = [...contentData, ...channels]; 
                
            } catch(e){ 
                console.error("Error al cargar los datos:", e); 
                document.getElementById('content').innerHTML = `<p style="color:var(--accent); padding: 50px 3vw; text-align: center;">‚ùå Error al cargar los datos. Revisa la consola y la URL del JSON.</p>`; 
            } 
            document.getElementById('loadingIndicator').classList.remove('show'); 
            renderCurrentTab(); 
        }

        async function fetchChannels(){ 
            try { 
                const res = await fetch(M3U8_URL); 
                const text = await res.text(); 
                const lines = text.split(/\r?\n/); 
                let current = null; 
                channels=[]; 
                
                for(const lineRaw of lines){ 
                    const line = lineRaw.trim(); 
                    if(!line.startsWith('#') && line.length > 0 && line.includes('://')) { 
                        if (current) { 
                            current.video_url = line; 
                            channels.push(current); 
                        } 
                        current = null; 
                        continue; 
                    } 
                    if(line.startsWith('#EXTINF:')){ 
                        const logo = (line.match(/tvg-logo="([^"]*)"/)||[])[1]||null; 
                        const name = (line.match(/,(.*)$/)||[])[1]?.trim()||'Canal'; 
                        const coverImage = logo || 'https://via.placeholder.com/140x200?text=TV'; 
                        current = {id:name,title:name,coverImage,logo,type:'channel',isChannel:true, video_url:'', genre: ['En Vivo', 'Canal']};
                    } 
                } 
            } catch(e){ 
                console.warn("Error al cargar canales:", e); 
                channels=[]; 
            } 
        }

        // --- L√≥gica de Detalle (CORREGIDA) ---
        function openDetail(item){
            currentItem=item;
            const coverUrl = item.coverImage || item.logo || 'https://via.placeholder.com/140x200?text=Portada';
            const seriesId = item.id || item.title;

            document.getElementById('detailBackgroundImage').src = coverUrl;
            detailBackground.classList.add('show');
            showView('detailView');
            document.getElementById('detailTitle').textContent=item.title;
            document.getElementById('detailHeroImage').src = coverUrl;
            document.getElementById('detailHeroTitle').textContent = item.title;
            
            document.getElementById('detailDesc').textContent=item.description||'No hay descripci√≥n disponible para este contenido.';
            document.getElementById('detailGenres').textContent=Array.isArray(item.genre)&&item.genre.length?'üé≠ '+item.genre.join(', '):'';

            favoriteBtn.onclick = () => toggleFavorite(item);
            if (isFavorite(item)) { favoriteBtn.classList.add('active'); } else { favoriteBtn.classList.remove('active'); }

            episodesListContainer.innerHTML='';
            reproduceBtn.style.display = 'none';
            document.getElementById('detailEpisodes').style.display = 'block';
            const isSeries = item.episodes && item.episodes.length > 0;

            if(isSeries){
                let lastWatchedIndex = getLastWatchedEpisodeIndex(seriesId);
                let nextEpisodeIndex = 0;
                
                if (lastWatchedIndex !== undefined) {
                    if (lastWatchedIndex < item.episodes.length - 1) {
                        // Continuar al siguiente si el anterior no ha sido marcado como visto
                        const progress = loadPlayerProgress(seriesId, lastWatchedIndex);
                        if (progress > 0) {
                            nextEpisodeIndex = lastWatchedIndex; // Si tiene progreso, reanudar
                        } else {
                            nextEpisodeIndex = lastWatchedIndex + 1; // Si no tiene progreso, ir al siguiente
                        }
                    } else {
                        nextEpisodeIndex = item.episodes.length - 1; // √öltimo episodio
                    }
                } else {
                    nextEpisodeIndex = 0;
                }
                
                const indexToPlayOnButton = nextEpisodeIndex;
                const hasStarted = lastWatchedIndex !== undefined;

                document.getElementById('detailEpisodes').querySelector('h3').textContent = 'Cap√≠tulos';
                reproduceBtn.style.display = 'flex';

                if (hasStarted && indexToPlayOnButton === lastWatchedIndex && loadPlayerProgress(seriesId, indexToPlayOnButton) > 0) {
                    reproduceBtn.innerHTML = `<i class="fas fa-play"></i> Continuar viendo (Cap. ${indexToPlayOnButton + 1})`;
                } else if (hasStarted && indexToPlayOnButton < item.episodes.length) {
                    reproduceBtn.innerHTML = `<i class="fas fa-forward"></i> Ver siguiente (Cap. ${indexToPlayOnButton + 1})`;
                } else if (isEpisodeWatched(seriesId, item.episodes.length - 1)) {
                    reproduceBtn.innerHTML = `<i class="fas fa-check"></i> Visto, Ver √∫ltimo (Cap. ${item.episodes.length})`;
                } else {
                    reproduceBtn.innerHTML = `<i class="fas fa-play"></i> Ver Ahora (Cap. 1)`;
                }

                reproduceBtn.onclick = () => { 
                    // Si es 'Continuar viendo', pasamos el √≠ndice con progreso. 
                    // Si es 'Ver siguiente' o 'Ver Ahora', pasamos el √≠ndice de inicio
                    playEpisode(item, indexToPlayOnButton); 
                };

                item.episodes.forEach((ep,i)=>{
                    const episodeIndex = i;
                    const isWatched = isEpisodeWatched(seriesId, episodeIndex);
                    const episodeItem = document.createElement('div');
                    const isActive = isSeries && episodeIndex === indexToPlayOnButton;
                    
                    const savedTime = loadPlayerProgress(seriesId, episodeIndex);
                    let progressPercent = 0;
                    if (savedTime > 0) {
                        const estimatedDuration = 1200; 
                        progressPercent = Math.min(100, (savedTime / estimatedDuration) * 100).toFixed(0);
                    }

                    episodeItem.className = `episode-item ${isWatched ? 'watched' : ''} ${isActive ? 'active' : ''}`;
                    const thumbUrl = ep.thumb || item.coverImage || 'https://via.placeholder.com/320x180?text=Episodio';
                    const episodeTitle = `Episodio ${i+1}: ${ep.title || item.title}`;
                    const iconClass = isWatched ? 'fas fa-check-circle' : 'fas fa-play-circle';
                    
                    episodeItem.innerHTML = `
                        <div class="episode-thumb">
                            <img src="${thumbUrl}" alt="Ep. ${i+1}" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x180?text=Episodio';">
                            <i class="${iconClass} play-icon"></i>
                            ${savedTime > 0 && !isWatched ? `
                                <div style="position:absolute; bottom:0; left:0; width:100%; height:4px; background:rgba(255,255,255,0.4);">
                                    <div id="progressMinibar_${i}" style="width:${progressPercent}%; height:100%; background:var(--accent);"></div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="episode-info">
                            <strong>${episodeTitle}</strong> 
                            <span>${ep.description || 'Sinopsis del episodio...'}</span>
                        </div>
                    `;

                    episodeItem.onclick = (e) => {
                        document.querySelectorAll('.episode-item').forEach(x => x.classList.remove('active'));
                        episodeItem.classList.add('active');
                        getLastWatchedEpisodeIndex(seriesId, episodeIndex);
                        playEpisode(item, episodeIndex);
                    };

                    episodesListContainer.appendChild(episodeItem);
                    if(isActive) {
                        // Scroll al episodio activo/siguiente
                        setTimeout(() => {
                            const scrollPos = episodeItem.offsetLeft - episodesListContainer.clientWidth / 2 + episodeItem.clientWidth / 2;
                            episodesListContainer.scrollTo({ left: scrollPos, behavior: 'smooth' });
                        }, 50);
                    }
                });
            } else if(item.video_url){
                // Caso de Pel√≠cula o Canal en Vivo
                document.getElementById('detailEpisodes').style.display = 'none';
                reproduceBtn.style.display = 'flex';
                reproduceBtn.innerHTML = `<i class="fas fa-play"></i> ${item.isChannel ? 'Ver Canal en Vivo' : 'Reproducir Ahora'}`;
                
                reproduceBtn.onclick = () => { openPlayer(item, 0); };
            } else {
                document.getElementById('detailEpisodes').style.display = 'none';
                reproduceBtn.style.display = 'none';
            }

            document.getElementById('detailView').scrollTo({top: 0, behavior: 'smooth'});
        }

        // --- Inicializaci√≥n ---
        document.addEventListener('DOMContentLoaded',async()=>{
            await fetchData();
            // Iniciar la pesta√±a de inicio despu√©s de cargar los datos
            renderCurrentTab();
        });
    </script>
</body>
</html>
