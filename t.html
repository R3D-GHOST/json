<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kawaii Play TV</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<meta name="theme-color" content="#1A1A2E">
<style>
/* --- 2. CSS Completamente Revisado y Optimizado para TV --- */
:root {
  --primary-bg: #1A1A2E; /* Azul oscuro elegante */
  --secondary-bg: #272842; /* Tono de fondo secundario */
  --card-bg: #323354;
  --text-primary: #E8EAF6; /* Blanco azulado */
  --text-secondary: #9FA8DA; /* Gris azulado suave */
  --accent-pink: #FF69B4; /* Rosa chill√≥n */
  --accent-yellow: #FFD700; /* Dorado para foco */
  --border-color: #4A4A6E;
  --watched-color: #4CAF50;
  --focus-color: var(--accent-yellow); 
  --focus-scale: 1.12; /* Mayor escala para TV */
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: var(--primary-bg);
  color: var(--text-primary);
  overflow-y: scroll; 
  scroll-behavior: smooth; 
}

/* --- Accesibilidad y Foco (Esencial para TV) --- */
/* Reset de foco en elementos no interactivos para evitar saltos */
*:not(button, a, input, [tabindex="0"]):focus {
    outline: none !important;
}

/* --- Loader (Estilos de carga) --- */
.loader-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--primary-bg);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  transition: opacity 0.5s ease;
}

.loader {
  border: 4px solid var(--border-color);
  border-top: 4px solid var(--accent-pink);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loader-container.hidden {
  opacity: 0;
  pointer-events: none;
}

/* --- Header & Navigation --- */
header {
  background: var(--secondary-bg);
  padding: 15px 30px; 
  display: flex;
  align-items: center;
  gap: 20px;
  position: sticky;
  top: 0;
  z-index: 10;
  border-bottom: 2px solid var(--border-color);
}

.hamburger-btn {
    background: none;
    border: none;
    color: var(--text-primary);
    font-size: 32px;
    cursor: pointer;
    padding: 0 15px;
    z-index: 1002;
    outline: none; 
    transition: transform 0.2s, color 0.2s;
}

.hamburger-btn:focus {
    color: var(--focus-color);
    transform: scale(1.1);
    outline: 2px solid var(--focus-color);
    border-radius: 4px;
}

header h1 {
  margin: 0;
  font-size: 24px;
  font-weight: 700;
}

#side-menu {
    position: fixed;
    top: 0;
    left: 0;
    height: 100%;
    width: 320px;
    background: var(--secondary-bg);
    z-index: 1001;
    transform: translateX(-100%);
    transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    padding-top: 90px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border-right: 3px solid var(--accent-pink);
    box-shadow: 5px 0 15px rgba(0,0,0,0.5);
}

#side-menu.open {
    transform: translateX(0);
}

#menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease-in-out;
}

#menu-overlay.open {
    opacity: 1;
    pointer-events: auto;
}

.search-container {
    padding: 0 20px;
}

#side-menu input {
  padding: 15px;
  border-radius: 12px;
  font-size: 18px;
  background-color: var(--card-bg);
  color: var(--text-primary);
  border: 2px solid var(--border-color);
  outline: none;
  width: 100%;
}
#side-menu input:focus {
    border-color: var(--accent-pink);
    box-shadow: 0 0 10px rgba(255, 105, 180, 0.7);
}

.nav-link {
    color: var(--text-primary);
    text-decoration: none;
    padding: 18px 25px; 
    font-size: 20px;
    font-weight: 600;
    transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
    outline: none;
}

/* Foco en Menu Links */
.nav-link:focus {
    background-color: var(--card-bg);
    color: var(--focus-color);
    box-shadow: inset 6px 0 0 var(--focus-color);
}

/* --- Main & Screens --- */
main {
  position: relative;
  padding: 20px 0;
}

.screen {
  display: none;
  animation: fadeIn 0.3s ease;
  padding-bottom: 50px;
}

.screen.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* --- Banner --- */
.banner {
  position: relative;
  height: 50vh;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  padding: 50px;
  color: white;
  overflow: hidden;
}

.banner-bg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: brightness(0.4);
  transition: opacity 0.5s ease-in-out;
}

.banner h2 {
  position: relative;
  z-index: 1;
  font-size: 44px;
  font-weight: 900;
  margin: 0 0 20px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.banner #btn-live {
  position: relative;
  padding: 18px 30px;
  background: var(--accent-pink);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  z-index: 2;
  font-weight: bold;
  align-self: flex-start;
  transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
  text-decoration: none;
  display: inline-block;
  outline: none;
}

/* Foco en Bot√≥n de Banner */
.banner #btn-live:focus {
    background-color: var(--focus-color);
    color: var(--primary-bg);
    box-shadow: 0 0 20px var(--focus-color);
    transform: scale(1.05);
}

/* --- Content Sections --- */
.section {
  padding: 15px 30px;
}

.section h2 {
  margin: 25px 0 20px;
  font-size: 28px;
  font-weight: 700;
  color: var(--accent-pink);
}

.row {
  display: flex;
  overflow-x: scroll;
  gap: 30px;
  padding-bottom: 25px;
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.row::-webkit-scrollbar {
  display: none;
}

.card {
  flex: 0 0 240px; 
  background: var(--card-bg);
  border-radius: 16px;
  cursor: pointer;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,.4);
  transition: transform 0.3s ease, box-shadow 0.3s ease, outline 0.3s ease;
  outline: 6px solid transparent; 
  outline-offset: 4px;
}

.card img {
  width: 100%;
  height: 360px;
  object-fit: cover;
  display: block;
  border-radius: 16px 16px 0 0;
}

.card h3 {
  margin: 12px;
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  white-space: normal;
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: 2.4em;
  line-height: 1.2;
}

/* Foco para Tarjetas - Esencial para TV */
.card:focus {
    transform: scale(var(--focus-scale));
    box-shadow: 0 15px 40px rgba(0,0,0,.8);
    outline: 6px solid var(--focus-color); 
    z-index: 5;
}

.tv-card {
    flex: 0 0 280px;
}

.tv-card img {
    height: 160px;
    object-fit: contain;
    background-color: #000;
}

/* --- Detail Screen --- */
.detail-hero {
    position: relative;
    min-height: 60vh;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    color: white;
}

.detail-poster {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: 1;
}

.detail-hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to top, var(--primary-bg) 10%, rgba(0,0,0,0.6) 50%, transparent 100%);
    z-index: 2;
}

.detail-header {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    padding: 30px;
    z-index: 3;
    background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
}

.detail-info {
    position: relative;
    z-index: 3;
    padding: 30px;
}

#back-btn,
#play-action-btn,
#fav-btn {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 15px 25px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    outline: none;
}
#play-action-btn {
    background: var(--accent-pink);
    border-color: var(--accent-pink);
}

/* Foco en Botones de Detalle */
#back-btn:focus,
#play-action-btn:focus,
#fav-btn:focus {
    transform: scale(1.05);
    box-shadow: 0 0 18px var(--focus-color);
    outline: 3px solid var(--focus-color);
}

#detail-title {
    margin: 0 0 20px 0;
    font-size: 36px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
}

.detail-actions {
    padding: 0;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
}

#detail-description {
    font-size: 16px;
    line-height: 1.6;
    max-width: 800px;
}

.detail-content {
    padding: 20px 30px 50px;
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px;
}
.episode-btn {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 16px;
    border-radius: 10px;
    cursor: pointer;
    text-align: left;
    width: 100%;
    transition: background-color 0.2s, border-color 0.2s, outline 0.2s, transform 0.2s;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 15px;
    position: relative;
    overflow: hidden;
    outline: 3px solid transparent;
}
.episode-btn.watched {
    border-left: 5px solid var(--watched-color);
}

.episode-btn:focus {
    outline: 3px solid var(--focus-color);
    background: var(--secondary-bg);
    transform: scale(1.02);
}

.ep-number {
    font-weight: bold;
    font-size: 1.1em;
}
.ep-desc {
    font-size: 0.9em;
    color: var(--text-secondary);
    grid-column: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.progress-bar-container {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: rgba(0,0,0,0.4);
}
.progress-bar {
    height: 100%;
    background-color: var(--accent-pink);
    width: 0%;
    transition: width 0.3s ease;
}

/* --- Other Screens --- */
#favorites, #watched {
    padding: 30px;
}

.empty-message {
    color: var(--text-secondary);
    text-align: center;
    padding: 80px 0;
    font-size: 1.2em;
}

</style>
<script src="https://cdn.jsdelivr.net/npm/hls.js@4.0.0/dist/hls.min.js"></script>
</head>
<body>

<div id="loader" class="loader-container">
    <div class="loader"></div>
</div>

<div id="menu-overlay"></div>
<nav id="side-menu">
    <div class="search-container">
        <input id="search" type="text" placeholder="Buscar..." tabindex="-1"/> 
    </div>
    <a href="#" class="nav-link" data-screen="home" tabindex="-1">üè† Inicio</a>
    <a href="#" class="nav-link" data-screen="favorites" tabindex="-1">‚≠ê Favoritos</a>
    <a href="#" class="nav-link" data-screen="watched" tabindex="-1">‚úîÔ∏è Vistos</a>
</nav>

<header>
    <button id="hamburger-btn" class="hamburger-btn" tabindex="0">‚ò∞</button>
    <div class="logo-container">
        <h1 id="header-title">Kawaii Play TV</h1>
    </div>
</header>

<main>
    <div id="banner" class="banner">
      <img id="banner-bg" class="banner-bg" src="" alt="Live channel background">
      <h2 id="banner-title"></h2>
      <a id="btn-live" style="padding: 18px 30px; background: var(--accent-pink); color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 2; font-weight: bold; align-self: flex-start; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; text-decoration: none; display: inline-block; outline: none;" href="#" target="_blank" rel="noopener noreferrer" tabindex="0">Ver en directo</a>
    </div>
    
    <div id="home" class="screen active" tabindex="0"> 
        </div>
    
    <div id="detail" class="screen" tabindex="0"> 
        <div class="detail-hero">
            <img id="detail-poster" class="detail-poster" src="" alt="Poster">
            <div class="detail-hero-overlay"></div>
            <div class="detail-header">
                <button id="back-btn" tabindex="-1">‚¨Ö Atr√°s</button>
            </div>
            <div class="detail-info">
                <h2 id="detail-title"></h2>
                <div class="detail-actions">
                    <button id="play-action-btn" tabindex="-1">‚ñ∂ Ver Episodio 1</button>
                    <button id="fav-btn" tabindex="-1">‚≠ê A√±adir a Favoritos</button>
                </div>
                <p id="detail-description"></p>
            </div>
        </div>
        <div id="detail-content" class="detail-content">
            </div>
    </div>
    
    <div id="favorites" class="screen" tabindex="0"></div>
    <div id="watched" class="screen" tabindex="0"></div>
</main>

<script>
// Key Codes para D-Pad de TV
const KEY_CODES = {
    LEFT: 37,
    UP: 38,
    RIGHT: 39,
    DOWN: 40,
    ENTER: 13,
    ESC: 27
};

const DATA_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
const M3U_URL="https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/toro.m3u8";
const ITEMS_PER_PAGE = 30; 

// DOM Elements
const loader = document.getElementById("loader");
const home = document.getElementById("home");
const detail = document.getElementById("detail");
const favoritesScreen = document.getElementById("favorites");
const watchedScreen = document.getElementById("watched");

const bannerTitle = document.getElementById("banner-title");
const btnLive = document.getElementById("btn-live");
const searchInput = document.getElementById("search");
const backBtn = document.getElementById("back-btn");
const detailContent = document.getElementById("detail-content");
const favBtn = document.getElementById("fav-btn");
const hamburgerBtn = document.getElementById('hamburger-btn');
const sideMenu = document.getElementById('side-menu');
const menuOverlay = document.getElementById('menu-overlay');
const headerTitle = document.getElementById('header-title');
const playActionBtn = document.getElementById('play-action-btn');


// State y Local Storage (se mantienen)
let allData = { movies: [], series: [], channels: [] };
let liveChannels = [];
let liveIndex = 0;
let liveInterval = null;
let observers = [];
let currentDetailItem = null;
let currentFocusedElement = null; 

let favorites = JSON.parse(localStorage.getItem('kawaii_favorites')) || [];
let watched = JSON.parse(localStorage.getItem('kawaii_watched')) || {};
let continueWatching = JSON.parse(localStorage.getItem('kawaii_continue')) || [];
let progress = JSON.parse(localStorage.getItem('kawaii_progress')) || {};


// --- UTILITY FUNCTIONS ---
const generateItemId = (item) => item.title;
const generateEpisodeId = (item, epIndex) => `${item.title}-ep-${epIndex}`;
const updateFavorites = () => localStorage.setItem('kawaii_favorites', JSON.stringify(favorites));
const updateWatched = () => localStorage.setItem('kawaii_watched', JSON.stringify(watched));
const updateProgress = () => localStorage.setItem('kawaii_progress', JSON.stringify(progress));

function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const screen = document.getElementById(screenId);
    if(screen) screen.classList.add('active');
    
    const link = document.querySelector(`.nav-link[data-screen="${screenId}"]`);
    headerTitle.textContent = link ? link.textContent.trim().substring(2) : (screenId === 'detail' ? 'Detalles' : "Kawaii Play TV");
    document.getElementById('banner').style.display = screenId === 'home' ? 'flex' : 'none';

    // TV Focus Logic: Set initial focus
    setTimeout(() => {
        let initialFocusTarget;
        if (screenId === 'home') {
             // Prioridad: Banner > Primera tarjeta > Hamburguesa
             initialFocusTarget = document.getElementById('btn-live') || document.querySelector('.card') || hamburgerBtn;
        } else if (screenId === 'detail') {
            // Prioridad: Bot√≥n Atr√°s
            initialFocusTarget = backBtn;
        } else { // favorites, watched
            // Prioridad: Primera tarjeta > Hamburguesa
            initialFocusTarget = screen.querySelector('.card') || hamburgerBtn;
        }
        
        if (initialFocusTarget) {
            initialFocusTarget.focus();
            currentFocusedElement = initialFocusTarget;
        }
    }, 100);
}

// Data loading and parsing (Mantengo la l√≥gica de tu c√≥digo)
async function fetchData(url) { /* ... */
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Failed to fetch ${url}`);
        return res;
    } catch (error) {
        console.error("Fetch Error:", error);
        return null;
    }
}

async function loadData() {
    const res = await fetchData(DATA_URL);
    if (!res) return;
    const jsonData = await res.json();
    allData.movies = jsonData.filter(i => i.video_url && !i.episodes);
    allData.series = jsonData.filter(i => i.episodes && i.episodes.length > 0);
}

async function loadM3U() {
    const res = await fetchData(M3U_URL);
    if(!res) return;
    const txt = await res.text();
    parseM3U(txt);
    liveChannels = allData.channels.filter(c => c.group && c.group.toUpperCase() === "EN DIRECTO");
    renderBannerLive();
}

function parseM3U(text) {
    const lines = text.split("\n");
    let currentName = "", currentLogo = "", currentGroup = "";
    const channels = [];
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.startsWith("#EXTINF")) {
            const g = line.match(/group-title="([^"]+)"/);
            const l = line.match(/tvg-logo="([^"]+)"/);
            const n = line.split(",").pop();
            currentGroup = g ? g[1] : "Otros";
            currentLogo = l ? l[1] : "";
            currentName = n || "Canal";
        } else if (line && !line.startsWith("#")) {
            channels.push({ name: currentName, logo: currentLogo, url: line, group: currentGroup });
        }
    }
    allData.channels = channels;
}

function renderBannerLive() { /* ... */
    if (!liveChannels.length) return;
    liveIndex = Math.floor(Math.random() * liveChannels.length);
    const bannerBg = document.getElementById('banner-bg');

    const showChannel = (index) => {
        const ch = liveChannels[index];
        bannerTitle.textContent = ch.name;
        
        if (bannerBg) {
            bannerBg.style.opacity = '0';
            setTimeout(() => {
                bannerBg.src = ch.logo || '';
                bannerBg.style.opacity = '1';
            }, 500);
        }
        document.getElementById('btn-live').href = ch.url;
    };
    
    showChannel(liveIndex);

    if (liveInterval) clearInterval(liveInterval);
    liveInterval = setInterval(() => {
        liveIndex = (liveIndex + 1) % liveChannels.length;
        showChannel(liveIndex);
    }, 5000);
}


// Home screen rendering y carga infinita (Optimizada la detecci√≥n de scroll)
function renderHome(filter = "") {
    home.innerHTML = "";
    observers.forEach(obs => obs.disconnect());
    observers = [];

    const lowerFilter = filter.toLowerCase();

    if (!filter) {
        // L√≥gica de "Continuar Viendo"
        const continueWatching = JSON.parse(localStorage.getItem('kawaii_continue')) || [];
        if (continueWatching.length > 0) {
            const continueData = continueWatching.map(storedItem => {
                return allData.movies.find(i => generateItemId(i) === generateItemId(storedItem)) || 
                       allData.series.find(i => generateItemId(i) === generateItemId(storedItem));
            }).filter(Boolean);
            if (continueData.length > 0) {
                 createSection("Continuar Viendo", continueData, (item) => {
                    return item.episodes ? createSeriesCard(item) : createMovieCard(item);
                }, home, 10);
            }
        }
    }

    const filteredMovies = allData.movies.filter(item => item.title.toLowerCase().includes(lowerFilter));
    const filteredSeries = allData.series.filter(item => item.title.toLowerCase().includes(lowerFilter));
    const filteredChannels = allData.channels
        .filter(c => c.group.toUpperCase() !== "EN DIRECTO")
        .filter(ch => ch.name.toLowerCase().includes(lowerFilter));

    if (filteredMovies.length) createSection("Pel√≠culas", filteredMovies, createMovieCard, home);
    if (filteredSeries.length) createSection("Series", filteredSeries, createSeriesCard, home);
    if (filteredChannels.length) createSection("Canales", filteredChannels, createChannelCard, home);
}

function createSection(title, items, cardCreator, parentElement, limit = ITEMS_PER_PAGE) {
    const section = document.createElement("div");
    section.className = "section";
    
    const h2 = document.createElement("h2");
    h2.textContent = title;
    section.appendChild(h2);
    
    const row = document.createElement("div");
    row.className = "row";
    section.appendChild(row);
    parentElement.appendChild(section);

    let loadedCount = 0;

    function loadMore() {
        const fragment = document.createDocumentFragment();
        const nextItems = items.slice(loadedCount, loadedCount + limit);
        nextItems.forEach(item => fragment.appendChild(cardCreator(item)));
        row.appendChild(fragment);
        loadedCount += nextItems.length;

        // **BUG FIX:** S√≥lo intentar cargar m√°s si es una fila principal y tiene m√°s contenido
        if (loadedCount < items.length && parentElement === home) {
            setupIntersectionObserver(row, loadMore);
        }
    }
    loadMore();
}

function setupIntersectionObserver(row, callback) {
    // Asegurar que haya cards en la fila antes de intentar agregar el sentinel
    const rowCards = Array.from(row.querySelectorAll('.card'));
    if (rowCards.length === 0) return;
    
    // Crear un elemento invisible al final de la fila para detectar el scroll horizontal
    const sentinel = document.createElement('div');
    sentinel.style.width = '1px';
    sentinel.style.height = '1px';
    sentinel.style.flexShrink = '0';
    sentinel.style.marginLeft = '100px'; 
    row.appendChild(sentinel);

    const observer = new IntersectionObserver(entries => {
        if (entries[0].isIntersecting) {
            observer.disconnect();
            sentinel.remove();
            callback();
        }
    }, { 
        root: row, // Observar dentro del contenedor de la fila
        rootMargin: '0px 200px 0px 0px', // Se activa 200px antes del borde derecho
        threshold: 0.1 
    });

    observer.observe(sentinel);
    observers.push(observer);
}


// Card Creators (Se mantiene la l√≥gica de enfoque y click)
function createMovieCard(item) {
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute('tabindex', '0'); 
    card.onclick = () => playVideo(item, null);
    card.innerHTML = `<img src="${item.coverImage || ""}" alt="${item.title}" loading="lazy"><h3>${item.title || ""}</h3>`;
    card.addEventListener('keyup', (e) => {
        if (e.keyCode === KEY_CODES.ENTER) card.click();
    });
    return card;
}

function createSeriesCard(item) {
    const card = document.createElement("div");
    card.className = "card";
    card.setAttribute('tabindex', '0');
    card.onclick = () => openItem(item);
    card.innerHTML = `<img src="${item.coverImage || ""}" alt="${item.title}" loading="lazy"><h3>${item.title || ""}</h3>`;
    card.addEventListener('keyup', (e) => {
        if (e.keyCode === KEY_CODES.ENTER) card.click();
    });
    return card;
}

function createChannelCard(ch) {
    const card = document.createElement("div");
    card.className = "card tv-card";
    card.setAttribute('tabindex', '0');
    const channelUrl = ch.v2_url || ch.url;
    card.onclick = () => window.open(channelUrl, '_blank');
    card.innerHTML = `<img src="${ch.logo || "https://via.placeholder.com/280x160.png?text=No+Logo"}" alt="${ch.name}" loading="lazy"><h3>${ch.name}</h3>`;
    card.addEventListener('keyup', (e) => {
        if (e.keyCode === KEY_CODES.ENTER) card.click();
    });
    return card;
}


// Detalle y Player (Se mantiene la l√≥gica funcional)
function openItem(item) {
    currentDetailItem = item;
    const itemId = generateItemId(item);
    
    document.getElementById('detail-title').textContent = item.title;
    document.getElementById('detail-poster').src = item.coverImage || '';
    document.getElementById('detail-description').textContent = item.description || 'No hay descripci√≥n disponible para esta serie.';
    detailContent.innerHTML = "";
    
    favBtn.textContent = favorites.includes(itemId) ? '‚≠ê Quitar de Favoritos' : '‚≠ê A√±adir a Favoritos';

    // Update play/continue button
    const seriesProgress = progress[itemId];
    const firstEpisodeIndex = 0;
    
    if (seriesProgress) {
        const epIndex = item.episodes.findIndex(ep => generateEpisodeId(item, ep.episode_number - 1) === seriesProgress.episodeId);
        if (epIndex !== -1) {
            playActionBtn.textContent = `‚ñ∂Ô∏è Continuar Ep. ${epIndex + 1}`;
            playActionBtn.onclick = () => playVideo(item, epIndex, seriesProgress.time);
        } else {
             playActionBtn.textContent = `‚ñ∂Ô∏è Ver Episodio 1`;
             playActionBtn.onclick = () => playVideo(item, firstEpisodeIndex);
        }
    } else {
        playActionBtn.textContent = `‚ñ∂Ô∏è Ver Episodio 1`;
        playActionBtn.onclick = () => playVideo(item, firstEpisodeIndex);
    }

    // Renderizar lista de episodios
    item.episodes.forEach((ep, i) => {
        const epId = generateEpisodeId(item, i);
        const btn = document.createElement("button");
        btn.className = "episode-btn";
        btn.setAttribute('tabindex', '0'); 
        if (watched[epId]) btn.classList.add('watched');
        
        let progressPercent = 0;
        if (seriesProgress && seriesProgress.episodeId === epId && seriesProgress.duration) {
            progressPercent = (seriesProgress.time / seriesProgress.duration) * 100;
        } else if (watched[epId]) {
            progressPercent = 100;
        }

        btn.innerHTML = `
            <div>
                <span class="ep-number">Episodio ${i + 1}</span>
                <span class="ep-desc">${ep.description || ''}</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${progressPercent}%"></div>
            </div>
        `;
        
        const seekTime = (seriesProgress && seriesProgress.episodeId === epId) ? seriesProgress.time : 0;
        btn.onclick = (e) => {
            e.stopPropagation();
            playVideo(item, i, seekTime);
        };
        btn.addEventListener('keyup', (e) => {
            if (e.keyCode === KEY_CODES.ENTER) btn.click();
        });
        
        detailContent.appendChild(btn);
    });

    // Habilitar elementos de detalle
    [backBtn, playActionBtn, favBtn].forEach(el => el.setAttribute('tabindex', '0'));
    document.querySelectorAll('.episode-btn').forEach(el => el.setAttribute('tabindex', '0'));

    // Guardar la pantalla anterior para el bot√≥n Atr√°s
    document.querySelector('.screen.active')?.classList.add('from-detail'); 
    switchScreen('detail');
}

function playVideo(item, episodeIndex = null, startTime = 0) {
    let url;
    
    if (episodeIndex !== null) { 
        url = item.episodes[episodeIndex].video_url;
        const id = generateEpisodeId(item, episodeIndex);
        watched[id] = true;
        updateWatched();
    } else if (item.video_url) { 
        url = item.video_url;
        const id = generateItemId(item);
        watched[id] = true;
        updateWatched();
    } else { 
        url = item.url; // Live Channel
    }
    
    // A√±adir a continuar viendo (s√≥lo series/pel√≠culas)
    if(item.video_url || item.episodes) {
        // L√≥gica de `addToContinueWatching` simplificada aqu√≠:
        const itemId = generateItemId(item);
        continueWatching = continueWatching.filter(i => generateItemId(i) !== itemId);
        continueWatching.unshift(item);
        if (continueWatching.length > 10) continueWatching.pop();
        localStorage.setItem('kawaii_continue', JSON.stringify(continueWatching));
    }

    // Abrir v√≠deo en nueva ventana/tab
    window.open(url, '_blank');
    
    // Volver a la pantalla de detalle despu√©s de abrir el v√≠deo (si aplica)
    if(currentDetailItem) {
        openItem(currentDetailItem);
    } else {
        switchScreen('home');
    }
}


// Handlers de men√∫ y favoritos/vistos (se mantienen)
favBtn.addEventListener('click', () => { /* ... */
    if (!currentDetailItem) return;
    const itemId = generateItemId(currentDetailItem);
    const index = favorites.indexOf(itemId);
    if (index > -1) {
        favorites.splice(index, 1);
        favBtn.textContent = '‚≠ê A√±adir a Favoritos';
    } else {
        favorites.push(itemId);
        favBtn.textContent = '‚≠ê Quitar de Favoritos';
    }
    updateFavorites();
});

backBtn.addEventListener("click", () => {
    // Deshabilitar elementos interactivos al salir
    [backBtn, playActionBtn, favBtn].forEach(el => el.setAttribute('tabindex', '-1'));
    document.querySelectorAll('.episode-btn').forEach(el => el.setAttribute('tabindex', '-1'));
    
    const fromScreen = document.querySelector('.screen.from-detail');
    if (fromScreen) {
        switchScreen(fromScreen.id);
        fromScreen.classList.remove('from-detail');
    } else {
        switchScreen('home');
    }
});

hamburgerBtn.addEventListener('click', () => { /* ... */
    const isOpen = sideMenu.classList.toggle('open');
    menuOverlay.classList.toggle('open');
    
    const navElements = [searchInput, ...document.querySelectorAll('#side-menu .nav-link')];

    if (isOpen) {
        navElements.forEach(el => el.setAttribute('tabindex', '0'));
        searchInput.focus();
    } else {
        navElements.forEach(el => el.setAttribute('tabindex', '-1'));
        hamburgerBtn.focus(); 
    }
    currentFocusedElement = document.activeElement;
});

menuOverlay.addEventListener('click', () => { /* ... */
    sideMenu.classList.remove('open');
    menuOverlay.classList.remove('open');
    const navElements = [searchInput, ...document.querySelectorAll('#side-menu .nav-link')];
    navElements.forEach(el => el.setAttribute('tabindex', '-1'));
    hamburgerBtn.focus();
    currentFocusedElement = hamburgerBtn;
});

document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const screen = e.target.dataset.screen;
        
        if (screen === 'favorites') renderFavorites();
        if (screen === 'watched') renderWatched();
        
        switchScreen(screen);
        sideMenu.classList.remove('open');
        menuOverlay.classList.remove('open');
        [searchInput, ...document.querySelectorAll('.nav-link')].forEach(el => el.setAttribute('tabindex', '-1'));
    });
    link.addEventListener('keyup', (e) => {
        if (e.keyCode === KEY_CODES.ENTER) link.click();
    });
});

function renderFavorites() { /* ... */
    favoritesScreen.innerHTML = '';
    const favData = favorites.map(id => {
        return allData.movies.find(i => generateItemId(i) === id) || 
               allData.series.find(i => generateItemId(i) === id);
    }).filter(Boolean);

    if (favData.length) {
        createSection("Mis Favoritos", favData, (item) => {
            return item.episodes ? createSeriesCard(item) : createMovieCard(item);
        }, favoritesScreen);
    } else {
        favoritesScreen.innerHTML = '<p class="empty-message">No has a√±adido nada a favoritos.</p>';
    }
}

function renderWatched() { /* ... */
    watchedScreen.innerHTML = '';
    const watchedItems = Object.keys(watched);
    const watchedData = watchedItems.map(id => {
        const title = id.split('-ep-')[0];
        return allData.movies.find(i => generateItemId(i) === title) || 
               allData.series.find(i => generateItemId(i) === title);
    }).filter(Boolean);
    
    const uniqueWatchedData = [...new Map(watchedData.map(item => [generateItemId(item), item])).values()];

    if (uniqueWatchedData.length) {
        createSection("Historial", uniqueWatchedData.reverse(), (item) => {
             return item.episodes ? createSeriesCard(item) : createMovieCard(item);
        }, watchedScreen);
    } else {
        watchedScreen.innerHTML = '<p class="empty-message">A√∫n no has visto nada.</p>';
    }
}


// --- TV FOCUS NAVIGATION (D-Pad) L√ìGICA FINAL Y ARREGLADA ---

function handleMenuFocus(e) {
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        e.preventDefault();
        const navElements = [searchInput, ...document.querySelectorAll('#side-menu .nav-link')].filter(el => el.offsetParent !== null);
        const currentIndex = navElements.indexOf(document.activeElement);
        let nextIndex = currentIndex;

        if (e.keyCode === KEY_CODES.UP) {
            nextIndex = (currentIndex - 1 + navElements.length) % navElements.length;
        } else if (e.keyCode === KEY_CODES.DOWN) {
            nextIndex = (currentIndex + 1) % navElements.length;
        }

        navElements[nextIndex]?.focus();
    }
}

function handleVerticalFocus(e, selector) {
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        e.preventDefault();
        // Filtrar elementos enfocables y visibles
        const focusableElements = Array.from(document.querySelectorAll(selector))
            .filter(el => el.getAttribute('tabindex') !== '-1' && el.offsetParent !== null); 
        
        const currentIndex = focusableElements.indexOf(document.activeElement);
        let nextIndex = currentIndex;

        if (e.keyCode === KEY_CODES.UP) {
            nextIndex = Math.max(0, currentIndex - 1);
        } else if (e.keyCode === KEY_CODES.DOWN) {
            nextIndex = Math.min(focusableElements.length - 1, currentIndex + 1);
        }

        if (nextIndex !== currentIndex && focusableElements[nextIndex]) {
            focusableElements[nextIndex].focus();
            focusableElements[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
}


/**
 * BUG FIX CR√çTICO: L√≥gica mejorada para la navegaci√≥n vertical en cuadr√≠culas (carruseles) 
 * que intenta mantener la posici√≥n horizontal.
 */
function handleGridFocus(e) {
    const currentActive = document.activeElement;
    const focusableCards = Array.from(document.querySelectorAll('.card'));
    const bannerElements = [document.getElementById('hamburger-btn'), document.getElementById('btn-live')];
    const rowElements = Array.from(document.querySelectorAll('.row'));
    const allFocusable = [...bannerElements, ...focusableCards];
    let newFocusElement = null;

    if (!allFocusable.includes(currentActive)) {
        e.preventDefault();
        (bannerElements[1] || bannerElements[0])?.focus();
        return;
    }

    if ([KEY_CODES.LEFT, KEY_CODES.RIGHT, KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        e.preventDefault();
    }
    
    // 1. Movimiento Horizontal (LEFT / RIGHT)
    if ([KEY_CODES.LEFT, KEY_CODES.RIGHT].includes(e.keyCode)) {
        for (const row of rowElements) {
            const rowCards = Array.from(row.querySelectorAll('.card'));
            const currentIndex = rowCards.indexOf(currentActive);
            
            if (currentIndex !== -1) {
                let nextCard;
                if (e.keyCode === KEY_CODES.LEFT) {
                    nextCard = rowCards[currentIndex - 1];
                } else {
                    nextCard = rowCards[currentIndex + 1];
                }
                
                if (nextCard) {
                    newFocusElement = nextCard;
                    // Scroll suave para mantener el foco en el carrusel
                    row.scrollLeft += (nextCard.offsetLeft - currentActive.offsetLeft); 
                    break;
                }
            }
        }
    }
    
    // 2. Movimiento Vertical (UP / DOWN)
    if ([KEY_CODES.UP, KEY_CODES.DOWN].includes(e.keyCode)) {
        
        let currentRowIndex = -3; // -3: Hamburger, -2: Live Btn, -1: No Card Row, 0+: Card Row Index
        let currentCardRect = currentActive.getBoundingClientRect();
        let currentCardCenter = currentCardRect.left + currentCardRect.width / 2;
        let bestMatch = null;
        let minDistance = Infinity;

        // Determinar el √≠ndice de la fila actual
        if (currentActive === bannerElements[0]) currentRowIndex = -3;
        else if (currentActive === bannerElements[1]) currentRowIndex = -2;
        else {
            rowElements.forEach((row, i) => {
                const rowCards = Array.from(row.querySelectorAll('.card'));
                if (rowCards.includes(currentActive)) currentRowIndex = i;
            });
        }

        let targetRowIndex = currentRowIndex + (e.keyCode === KEY_CODES.DOWN ? 1 : -1);

        // a) Navegaci√≥n en el √°rea del Banner/Header
        if (targetRowIndex === -3) { // Ir al Hamburger
            newFocusElement = bannerElements[0];
        } else if (targetRowIndex === -2) { // Ir al Live Btn
            newFocusElement = bannerElements[1];
        } else if (targetRowIndex === -1 && e.keyCode === KEY_CODES.DOWN) { 
            // Del Live Btn a la primera fila de cards
            if (rowElements.length > 0) targetRowIndex = 0;
            else newFocusElement = null; // No hay filas de cards
        } else if (targetRowIndex < -2) {
            newFocusElement = null; // Detenerse en la hamburguesa
        }


        // b) Navegaci√≥n entre filas de Cards (Row Indices 0+)
        if (targetRowIndex >= 0 && targetRowIndex < rowElements.length) {
            const targetRowCards = Array.from(rowElements[targetRowIndex].querySelectorAll('.card'));
            
            // Buscar el card en la fila de destino que est√© mejor alineado verticalmente
            for (const card of targetRowCards) {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + cardRect.width / 2;
                const distance = Math.abs(currentCardCenter - cardCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    bestMatch = card;
                }
            }
            newFocusElement = bestMatch;
        }
    }
    
    // 3. Aplicar nuevo foco
    if (newFocusElement) {
        newFocusElement.focus();
        currentFocusedElement = newFocusElement;
        
        // Asegurar la visibilidad vertical
        newFocusElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
    }
}

// --- INITIALIZATION ---
async function init() {
    loader.classList.remove('hidden');
    await Promise.all([loadData(), loadM3U()]); 
    renderHome();
    loader.classList.add('hidden');
    
    // Deshabilitar navegaci√≥n en elementos ocultos al inicio
    [searchInput, ...document.querySelectorAll('.nav-link'), backBtn, playActionBtn, favBtn].forEach(el => el.setAttribute('tabindex', '-1'));
    
    // Foco inicial en el bot√≥n del men√∫
    hamburgerBtn.focus();
    currentFocusedElement = hamburgerBtn;
}

init();
</script>
</body>
</html>
