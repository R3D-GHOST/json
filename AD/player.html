<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --yt-red: #f00; --accent: #00e1b5; }
        body { margin: 0; background: #000; height: 100vh; width: 100vw; overflow: hidden; font-family: sans-serif; }

        #video-wrapper { 
            width: 100%; height: 100%; opacity: 0; 
            transition: opacity 1s; display: flex; 
            align-items: center; justify-content: center;
        }

        video { width: 100%; height: 100%; object-fit: contain; }

        /* Pantalla de Inicio / Play Central */
        #start-screen {
            position: fixed; inset: 0; z-index: 500;
            display: flex; align-items: center; justify-content: center;
            background: #000;
        }
        .play-ring {
            width: 90px; height: 90px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 2px solid var(--accent);
            display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; color: #fff; cursor: pointer;
            transition: 0.3s; box-shadow: 0 0 20px rgba(0,225,181,0.3);
        }
        .play-ring:active { transform: scale(0.9); }

        /* UI Overlay YouTube */
        .ui-overlay { 
            position: absolute; inset: 0; z-index: 50; 
            background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%, rgba(0,0,0,0.6) 100%); 
            display: flex; flex-direction: column; justify-content: space-between;
            transition: opacity 0.3s;
        }
        .ui-overlay.hidden { opacity: 0; pointer-events: none; }

        .top-bar { padding: 20px; display: flex; align-items: center; gap: 15px; color: white; }
        .bottom-ctrls { width: 100%; padding: 0 15px 15px; box-sizing: border-box; }
        
        .yt-progress-container { width: 100%; height: 4px; background: rgba(255,255,255,0.3); margin-bottom: 15px; position: relative; }
        .yt-bar-fill { height: 100%; background: var(--yt-red); width: 0%; }

        .ctrl-row { display: flex; align-items: center; justify-content: space-between; color: #fff; }
        .left-side { display: flex; align-items: center; gap: 20px; }
        .time-display { font-size: 0.8rem; color: #ccc; }

        .loader { position: absolute; inset: 0; margin: auto; border: 3px solid rgba(255,255,255,0.1); border-left-color: var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #next-notice { position: absolute; bottom: 80px; right: 20px; background: #fff; color: #000; padding: 10px; font-weight: bold; display: none; z-index: 100; border-left: 4px solid var(--yt-red); }
    </style>
</head>
<body>

    <div class="loader" id="loader"></div>

    <div id="start-screen">
        <div class="play-ring" onclick="iniciarTodo()">
            <i class="fas fa-play"></i>
        </div>
    </div>

    <div id="next-notice">Siguiente episodio en 3...</div>
    
    <div id="video-wrapper" onclick="toggleUI()">
        <video id="vid" playsinline></video>
        
        <div class="ui-overlay" id="ui">
            <div class="top-bar">
                <i class="fas fa-chevron-down" onclick="history.back()"></i>
                <div id="v-title" style="font-size: 0.9rem;">Cargando...</div>
            </div>

            <div class="bottom-ctrls" onclick="event.stopPropagation()">
                <div class="yt-progress-container" onclick="manualSeek(event)">
                    <div class="yt-bar-fill" id="fill"></div>
                </div>
                <div class="ctrl-row">
                    <div class="left-side">
                        <i class="fas fa-play" id="pp" onclick="togglePlay()"></i>
                        <div class="time-display"><span id="curr">0:00</span> / <span id="rem">-0:00</span></div>
                    </div>
                    <i class="fas fa-expand" onclick="forceFull()"></i>
                </div>
            </div>
        </div>
    </div>

    <script>
        const vid = document.getElementById('vid');
        const wrapper = document.getElementById('video-wrapper');
        const startScreen = document.getElementById('start-screen');
        let isAutoplay = localStorage.getItem('pbox_autoplay_active') === 'true';

        function cargarConfig() {
            vid.src = localStorage.getItem('pbox_url');
            document.getElementById('v-title').innerText = localStorage.getItem('pbox_title');
            
            // Si es autoplay, ocultamos el botón de inicio y reproducimos directo
            if(isAutoplay) {
                startScreen.style.display = 'none';
                localStorage.setItem('pbox_autoplay_active', 'false'); // Reset para la próxima vez
                vid.play().then(() => forceFull()).catch(e => {
                    // Si el navegador bloquea el autoplay, mostramos el botón
                    startScreen.style.display = 'flex';
                });
            }
        }

        function iniciarTodo() {
            startScreen.style.opacity = '0';
            setTimeout(() => startScreen.style.display = 'none', 500);
            vid.play();
            forceFull();
        }

        function forceFull() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen();
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
            
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(() => {});
            }
        }

        vid.oncanplay = () => {
            if(isAutoplay) forceFull(); 
        };

        vid.ontimeupdate = () => {
            if (vid.currentTime > 0.5) {
                wrapper.style.opacity = "1";
                document.getElementById('loader').style.display = 'none';
            }
            
            // Guardar progreso
            const epKey = localStorage.getItem('pbox_current_ep_key');
            if(epKey && vid.duration > 0) {
                const progress = JSON.parse(localStorage.getItem('pbox_progress')) || {};
                progress[epKey] = { cur: vid.currentTime, dur: vid.duration };
                localStorage.setItem('pbox_progress', JSON.stringify(progress));
            }

            const p = (vid.currentTime / vid.duration) * 100;
            document.getElementById('fill').style.width = p + '%';
            document.getElementById('curr').innerText = formatTime(vid.currentTime);
            document.getElementById('rem').innerText = "-" + formatTime(vid.duration - vid.currentTime);
        };

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = Math.floor(s % 60);
            return `${m}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function togglePlay() {
            const btn = document.getElementById('pp');
            if(vid.paused) { vid.play(); btn.className = 'fas fa-pause'; }
            else { vid.pause(); btn.className = 'fas fa-play'; }
        }

        function toggleUI() { document.getElementById('ui').classList.toggle('hidden'); }

        function manualSeek(e) {
            const rect = e.currentTarget.getBoundingClientRect();
            vid.currentTime = ((e.clientX - rect.left) / rect.width) * vid.duration;
        }

        vid.onended = () => {
            const serieData = JSON.parse(localStorage.getItem('pbox_serie'));
            const epKey = localStorage.getItem('pbox_current_ep_key');
            if(serieData && epKey) {
                const currentNum = parseInt(epKey.split('_E')[1]);
                if(serieData.episodes[currentNum]) {
                    document.getElementById('next-notice').style.display = 'block';
                    setTimeout(() => {
                        const nextEp = serieData.episodes[currentNum];
                        localStorage.setItem('pbox_url', nextEp.video_url);
                        localStorage.setItem('pbox_title', serieData.title + " E" + (currentNum + 1));
                        localStorage.setItem('pbox_current_ep_key', serieData.title + "_E" + (currentNum + 1));
                        localStorage.setItem('pbox_autoplay_active', 'true'); // Indicamos que el siguiente es autoplay
                        location.reload();
                    }, 3000);
                    return;
                }
            }
            history.back();
        };

        cargarConfig();
    </script>
</body>
</html>
