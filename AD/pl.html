<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --accent: #00b4ff; --bg: #000; }
        body { 
            margin: 0; background: var(--bg); height: 100vh; width: 100vw; 
            overflow: hidden; font-family: 'Segoe UI', sans-serif; 
            display: flex; align-items: center; justify-content: center;
        }

        #video-container { position: relative; width: 100%; height: 100%; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* Interfaz */
        .ui-overlay { 
            position: absolute; inset: 0; z-index: 10; 
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 50%, rgba(0,0,0,0.7) 100%);
            display: flex; flex-direction: column; justify-content: space-between;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; }

        .top { padding: 15px; display: flex; align-items: center; gap: 10px; color: white; }
        .bottom { padding: 15px 25px 35px; }
        
        /* Barra de Progreso */
        .progress-area { width: 100%; height: 5px; background: rgba(255,255,255,0.2); cursor: pointer; margin-bottom: 15px; border-radius: 5px; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; border-radius: 5px; position: relative; }
        .progress-bar::after { content: ''; position: absolute; right: -5px; top: -4px; width: 13px; height: 13px; background: #fff; border-radius: 50%; }

        .controls { display: flex; align-items: center; justify-content: space-between; color: white; }
        .btn { cursor: pointer; font-size: 1.5rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.9); }

        /* Loader */
        .loader { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1);
            border-top-color: var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; z-index: 20; display: none;
        }
        @keyframes spin { to { transform: translate(-50%, -50%) rotate(360deg); } }

        #error-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; background: rgba(255,0,0,0.6); padding: 10px 20px;
            border-radius: 5px; display: none; z-index: 30; font-size: 0.8rem;
        }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="video-container">
        <div class="loader" id="loader"></div>
        <div id="error-msg">Error al cargar el video</div>
        
        <video id="main-video" playsinline webkit-playsinline crossorigin="anonymous"></video>

        <div class="ui-overlay" id="ui" onclick="handleTap(event)">
            <div class="top">
                <i class="fas fa-arrow-left btn" onclick="history.back()"></i>
                <span id="video-title">Cargando...</span>
            </div>

            <div class="bottom" onclick="event.stopPropagation()">
                <div class="progress-area" id="progress-area">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="controls">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <i class="fas fa-play btn" id="play-btn" onclick="togglePlay()"></i>
                        <span style="font-size: 0.8rem; font-family: monospace;" id="time">0:00 / 0:00</span>
                    </div>
                    <i class="fas fa-expand btn" onclick="toggleFull()"></i>
                </div>
            </div>
        </div>
    </div>

<script>
    const video = document.getElementById('main-video');
    const ui = document.getElementById('ui');
    const loader = document.getElementById('loader');
    const playBtn = document.getElementById('play-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressArea = document.getElementById('progress-area');
    let hls = null;
    let hideTimeout;

    function initPlayer() {
        const url = localStorage.getItem('pbox_url') || "";
        const title = localStorage.getItem('pbox_title') || "Video";
        document.getElementById('video-title').innerText = title;

        if (!url) return;

        // Lógica de "Dos en Uno": HLS para streams/TS y Native para MP4/MKV
        if (url.includes('.m3u8') || url.includes('.ts')) {
            if (Hls.isSupported()) {
                if (hls) hls.destroy();
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true
                });
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        console.error("Error Fatal HLS:", data.type);
                        document.getElementById('error-msg').style.display = 'block';
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Soporte nativo para Safari/iOS
                video.src = url;
            }
        } else {
            // Carga estándar para MP4, MKV, etc.
            video.src = url;
        }

        video.load();
    }

    // Controles de UI
    function togglePlay() {
        if (video.paused) {
            video.play();
            playBtn.className = "fas fa-pause";
            resetTimer();
        } else {
            video.pause();
            playBtn.className = "fas fa-play";
            clearTimeout(hideTimeout);
            ui.classList.remove('hidden');
        }
    }

    function handleTap(e) {
        if (ui.classList.contains('hidden')) {
            ui.classList.remove('hidden');
            resetTimer();
        } else {
            if (e.target === ui) ui.classList.add('hidden');
        }
    }

    function resetTimer() {
        clearTimeout(hideTimeout);
        if (!video.paused) {
            hideTimeout = setTimeout(() => ui.classList.add('hidden'), 3500);
        }
    }

    // Eventos de carga
    video.onwaiting = () => loader.style.display = 'block';
    video.onplaying = () => { loader.style.display = 'none'; resetTimer(); };
    video.onerror = () => { document.getElementById('error-msg').style.display = 'block'; };

    // Barra de progreso y tiempo
    video.ontimeupdate = () => {
        const percent = (video.currentTime / video.duration) * 100;
        progressBar.style.width = percent + '%';
        
        const cur = formatTime(video.currentTime);
        const dur = formatTime(video.duration);
        document.getElementById('time').innerText = `${cur} / ${dur}`;

        // Guardar progreso
        const epKey = localStorage.getItem('pbox_current_ep_key');
        if (epKey && video.currentTime > 0) {
            const prog = JSON.parse(localStorage.getItem('pbox_progress') || "{}");
            prog[epKey] = { cur: video.currentTime, dur: video.duration };
            localStorage.setItem('pbox_progress', JSON.stringify(prog));
        }
    };

    function formatTime(s) {
        if (isNaN(s)) return "0:00";
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = Math.floor(s % 60);
        return (h > 0 ? h + ":" : "") + (m < 10 && h > 0 ? "0" : "") + m + ":" + (sec < 10 ? "0" : "") + sec;
    }

    progressArea.onclick = (e) => {
        const rect = progressArea.getBoundingClientRect();
        const pos = (e.clientX - rect.left) / rect.width;
        video.currentTime = pos * video.duration;
    };

    function toggleFull() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            screen.orientation.lock('landscape').catch(() => {});
        } else {
            document.exitFullscreen();
        }
    }

    // Auto-Play al iniciar y resumir
    video.onloadedmetadata = () => {
        const epKey = localStorage.getItem('pbox_current_ep_key');
        const resume = localStorage.getItem('pbox_resume_action');
        if (resume === 'yes' && epKey) {
            const prog = JSON.parse(localStorage.getItem('pbox_progress') || "{}");
            if (prog[epKey]) video.currentTime = prog[epKey].cur;
        }
        localStorage.removeItem('pbox_resume_action');
        video.play().catch(() => {
            ui.classList.remove('hidden'); // Mostrar controles si el navegador bloquea autoplay
        });
        playBtn.className = "fas fa-pause";
    };

    // Siguiente episodio
    video.onended = () => {
        const data = JSON.parse(localStorage.getItem('pbox_serie'));
        const key = localStorage.getItem('pbox_current_ep_key');
        if (data && key) {
            const curIdx = parseInt(key.split('_E')[1]) - 1;
            const next = data.episodes[curIdx + 1];
            if (next) {
                localStorage.setItem('pbox_url', next.video_url);
                localStorage.setItem('pbox_title', data.title + " E" + (curIdx + 2));
                localStorage.setItem('pbox_current_ep_key', data.title + "_E" + (curIdx + 2));
                location.reload();
                return;
            }
        }
        history.back();
    };

    initPlayer();
</script>
</body>
</html>
