<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --bg: #000; --accent: #00e1b5; --card: #121212; --nav-bg: rgba(10,10,10,0.98); }
        
        body { 
            font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; 
            margin: 0; padding-bottom: 80px; overflow-x: hidden;
        }

        /* --- HEADER ESTÁTICO --- */
        header { 
            position: sticky; top: 0; z-index: 1000; background: var(--bg);
            padding: 15px; border-bottom: 1px solid #1a1a1a;
        }
        .search-box { position: relative; width: 100%; }
        .search-box input { 
            width: 100%; background: #161616; border: 1px solid #222; padding: 12px 40px; 
            border-radius: 10px; color: #fff; outline: none; box-sizing: border-box;
        }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #555; }

        /* --- CONTENEDORES DE SECCIÓN --- */
        .page-content { display: none; animation: fadeIn 0.3s ease; }
        .page-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title { font-size: 0.75rem; padding: 20px 15px 10px; text-transform: uppercase; color: var(--accent); letter-spacing: 2px; font-weight: 800; }

        /* --- DISEÑO DE GRIDS (CATALOGO 3x3 / CANALES 2x2) --- */
        .grid-catalogo { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 10px; }
        .grid-canales { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 0 15px; }

        .poster { aspect-ratio: 2/3; background: var(--card); border-radius: 6px; overflow: hidden; position: relative; }
        .poster img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-ch { aspect-ratio: 16/9; background: var(--card); border: 1px solid #1f1f1f; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        .card-ch img { width: 70%; height: 70%; object-fit: contain; }

        .fav-indicator { position: absolute; top: 5px; right: 5px; color: var(--accent); font-size: 0.7rem; text-shadow: 0 0 5px #000; }

        /* --- NAVBAR --- */
        nav { 
            position: fixed; bottom: 0; width: 100%; height: 70px; 
            background: var(--nav-bg); display: flex; border-top: 1px solid #1a1a1a; z-index: 2000; 
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; color: #555; text-decoration: none; font-weight: bold; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        #loading { text-align: center; padding: 20px; color: var(--accent); font-size: 0.8rem; }
    </style>
</head>
<body>

    <header>
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="q" placeholder="Buscar en toda la app..." oninput="ejecutarBusqueda()">
        </div>
    </header>

    <section id="page-catalogo" class="page-content active">
        <h2 class="section-title">Películas y Series</h2>
        <div id="grid-movies" class="grid-catalogo"></div>
    </section>

    <section id="page-canales" class="page-content">
        <h2 class="section-title">Canales en Vivo</h2>
        <div id="grid-tv" class="grid-canales"></div>
    </section>

    <section id="page-favs" class="page-content">
        <h2 class="section-title">Mis Favoritos</h2>
        <div id="grid-favoritos" class="grid-catalogo"></div>
    </section>

    <div id="loading">Cargando...</div>

    <nav>
        <a href="#" class="nav-item active" onclick="navegar(event, 'catalogo')"><i class="fas fa-th-large"></i>CATÁLOGO</a>
        <a href="#" class="nav-item" onclick="navegar(event, 'canales')"><i class="fas fa-tv"></i>CANALES</a>
        <a href="#" class="nav-item" onclick="navegar(event, 'favs')"><i class="fas fa-heart"></i>FAVORITOS</a>
    </nav>

    <script>
        const API_MOVIES = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        const API_TV = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";

        let db = { movies: [], tv: [], favs: JSON.parse(localStorage.getItem('pbox_favs')) || [] };
        let indexMovies = 0;
        let indexTV = 0;
        const STEP = 30;

        // --- CARGAR DATOS ---
        async function cargarTodo() {
            try {
                const [resM, resT] = await Promise.all([fetch(API_MOVIES), fetch(API_TV)]);
                db.movies = await resM.json();
                
                const textTV = await resT.text();
                const lines = textTV.split('\n');
                lines.forEach((l, i) => {
                    if(l.includes('#EXTINF:')) {
                        db.tv.push({
                            title: l.split(',')[1]?.trim() || 'Canal',
                            logo: l.match(/tvg-logo="(.*?)"/)?.[1] || '',
                            url: lines[i+1]?.trim(),
                            isTV: true
                        });
                    }
                });
                
                renderMovies();
                renderTV();
                renderFavs();
                document.getElementById('loading').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        // --- RENDERIZADO POR SECCIONES ---
        function renderMovies() {
            const grid = document.getElementById('grid-movies');
            const chunk = db.movies.slice(indexMovies, indexMovies + STEP);
            chunk.forEach(item => grid.appendChild(crearCard(item, 'poster')));
            indexMovies += STEP;
        }

        function renderTV() {
            const grid = document.getElementById('grid-tv');
            const chunk = db.tv.slice(indexTV, indexTV + STEP);
            chunk.forEach(item => grid.appendChild(crearCard(item, 'card-ch')));
            indexTV += STEP;
        }

        function renderFavs() {
            const grid = document.getElementById('grid-favoritos');
            grid.innerHTML = '';
            db.favs.forEach(item => grid.appendChild(crearCard(item, item.isTV ? 'card-ch' : 'poster')));
        }

        function crearCard(item, clase) {
            const div = document.createElement('div');
            div.className = clase;
            const esFav = db.favs.some(f => f.title === item.title);
            
            div.innerHTML = `
                <img src="${item.coverImage || item.logo}" loading="lazy" onclick='abrir(${JSON.stringify(item)})'>
                ${esFav ? '<i class="fas fa-bookmark fav-indicator"></i>' : ''}
            `;
            
            // Favorito con click sostenido (o doble click)
            div.ondblclick = () => gestionarFav(item);
            return div;
        }

        // --- NAVEGACIÓN SPA ---
        function navegar(e, id) {
            e.preventDefault();
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('page-' + id).classList.add('active');
            e.currentTarget.classList.add('active');
            window.scrollTo(0,0);
        }

        // --- BUSCADOR ---
        function ejecutarBusqueda() {
            const q = document.getElementById('q').value.toLowerCase();
            const gMovies = document.getElementById('grid-movies');
            const gTV = document.getElementById('grid-tv');

            if(q.length > 0) {
                gMovies.innerHTML = ''; gTV.innerHTML = '';
                db.movies.filter(m => m.title.toLowerCase().includes(q)).slice(0,50).forEach(m => gMovies.appendChild(crearCard(m, 'poster')));
                db.tv.filter(t => t.title.toLowerCase().includes(q)).slice(0,50).forEach(t => gTV.appendChild(crearCard(t, 'card-ch')));
            } else {
                indexMovies = 0; indexTV = 0;
                gMovies.innerHTML = ''; gTV.innerHTML = '';
                renderMovies(); renderTV();
            }
        }

        function gestionarFav(item) {
            const idx = db.favs.findIndex(f => f.title === item.title);
            if(idx > -1) db.favs.splice(idx, 1);
            else db.favs.push(item);
            localStorage.setItem('pbox_favs', JSON.stringify(db.favs));
            renderFavs();
            alert(idx > -1 ? "Quitado de favoritos" : "Añadido a favoritos (Doble Click)");
        }

        function abrir(item) {
            if(item.episodes) {
                localStorage.setItem('pbox_serie', JSON.stringify(item));
                window.location.href = "capitulos.html";
            } else {
                localStorage.setItem('pbox_url', item.url || item.video_url);
                localStorage.setItem('pbox_title', item.title);
                localStorage.removeItem('pbox_serie');
                window.location.href = "player.html";
            }
        }

        // Scroll Infinito por sección
        window.onscroll = () => {
            const activePage = document.querySelector('.page-content.active').id;
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
                if(activePage === 'page-catalogo') renderMovies();
                if(activePage === 'page-canales') renderTV();
            }
        };

        cargarTodo();
    </script>
</body>
</html>
