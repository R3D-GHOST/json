<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root { --bg: #000; --accent: #00e1b5; --card: #111; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: white; margin: 0; padding-bottom: 90px; overflow-x: hidden; }
        header { height: 65px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; background: #000; border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 100; }
        .logo { font-weight: 900; font-size: 1.3rem; }
        .logo span { color: var(--accent); }
        .section-title { font-size: 0.8rem; padding: 20px 15px 10px; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; }
        .scroll-x { display: flex; overflow-x: auto; padding: 0 15px 15px; gap: 12px; scrollbar-width: none; }
        .scroll-x::-webkit-scrollbar { display: none; }
        .card-ch { flex: 0 0 140px; height: 80px; background: var(--card); border: 1px solid #222; cursor: pointer; }
        .card-ch img { width: 100%; height: 100%; object-fit: cover; }
        .poster { flex: 0 0 130px; aspect-ratio: 2/3; background: var(--card); border: 1px solid #222; position: relative; }
        .poster img { width: 100%; height: 100%; object-fit: cover; }
        #fav-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; }
        .modal-content { background:#151515; padding:30px; border:2px solid var(--accent); text-align:center; width:80%; }
        nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; display: flex; border-top: 1px solid #222; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.6rem; color: #555; text-decoration: none; }
        .nav-item.active { color: var(--accent); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 4px; }
        .fav-icon { position:absolute; top:5px; right:5px; color:var(--accent); font-size:0.7rem; }
    </style>
</head>
<body>
    <div id="fav-modal"><div class="modal-content"><p>Máximo de favoritos permitido superado (6)</p><button onclick="this.parentElement.parentElement.style.display='none'" style="background:var(--accent); border:none; padding:10px 20px; font-weight:bold;">OK</button></div></div>
    <header><div class="logo">BOX<span>PLUS</span></div><i class="fas fa-search" onclick="location.href='buscar.html'"></i></header>
    <main>
        <div id="sec-ch"><h2 class="section-title">Canales destacados</h2><div id="list-ch" class="scroll-x"></div></div>
        <div id="sec-favs" style="display:none"><h2 class="section-title">Mis Favoritos</h2><div id="list-favs" class="scroll-x"></div></div>
        <div id="genres-container"></div>
    </main>
    <nav>
        <a href="index.html" class="nav-item active"><i class="fas fa-home"></i>INICIO</a>
        <a href="canales.html" class="nav-item"><i class="fas fa-tv"></i>CANALES</a>
        <a href="catalogo.html" class="nav-item"><i class="fas fa-th-large"></i>CATÁLOGO</a>
    </nav>
    <script>
        const M3U = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";
        const DATA = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        let favs = JSON.parse(localStorage.getItem('pbox_favs')) || [];
        let globalData = [];
        async function init() {
            try {
                const [rM3u, rData] = await Promise.all([fetch(M3U).then(res => res.text()), fetch(DATA).then(res => res.json())]);
                globalData = rData;
                const chBox = document.getElementById('list-ch');
                const lines = rM3u.split('\n');
                let count = 0;
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes('#EXTINF:') && count < 15) {
                        let url = lines[i+1]?.trim();
                        if(url && url.startsWith('http')) {
                            const d = document.createElement('div');
                            d.className = 'card-ch';
                            d.innerHTML = `<img src="${lines[i].match(/tvg-logo="(.*?)"/)?.[1] || ''}">`;
                            d.onclick = () => { localStorage.setItem('pbox_url', url); window.location.href="player.html"; };
                            chBox.appendChild(d);
                            count++;
                        }
                    }
                }
                renderAllSections();
            } catch(e) { console.error(e); }
        }
        function renderAllSections() {
            document.getElementById('list-favs').innerHTML = "";
            document.getElementById('genres-container').innerHTML = "";
            if(favs.length > 0) {
                document.getElementById('sec-favs').style.display = 'block';
                const fList = globalData.filter(i => favs.includes(i.title));
                fList.forEach(i => document.getElementById('list-favs').appendChild(renderItem(i)));
            } else { document.getElementById('sec-favs').style.display = 'none'; }
            ["Estreno", "Acción", "Anime","Romance","Terror","Infantil",].forEach(g => {
                const filtered = globalData.filter(i => i.genre?.includes(g) || g === "Estreno").slice(0, 15);
                if(filtered.length > 0) {
                    const sec = document.createElement('div');
                    sec.innerHTML = `<h2 class="section-title">${g}</h2><div class="scroll-x"></div>`;
                    filtered.forEach(i => sec.querySelector('.scroll-x').appendChild(renderItem(i)));
                    document.getElementById('genres-container').appendChild(sec);
                }
            });
        }
        function renderItem(item) {
            const d = document.createElement('div'); 
            d.className = 'poster';
            const isFav = favs.includes(item.title);
            d.innerHTML = `<img src="${item.coverImage}">${isFav ? '<i class="fas fa-bookmark fav-icon"></i>' : ''}`;
            d.onclick = () => { 
                localStorage.setItem(item.episodes ? 'pbox_serie' : 'pbox_url', item.episodes ? JSON.stringify(item) : item.video_url); 
                window.location.href = item.episodes ? 'capitulos.html' : 'player.html'; 
            };
            let t; 
            d.ontouchstart = () => {
                t = setTimeout(() => {
                    if(favs.includes(item.title)) { favs = favs.filter(f => f !== item.title); }
                    else if(favs.length < 6) { favs.push(item.title); }
                    else { document.getElementById('fav-modal').style.display = 'flex'; return; }
                    localStorage.setItem('pbox_favs', JSON.stringify(favs));
                    renderAllSections();
                }, 800);
            };
            d.ontouchend = () => clearTimeout(t);
            return d;
        }
        init();
    </script>
</body>
</html>
