<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AnimeBox+ | Streaming Premium</title>

<meta name="theme-color" content="#0e1635">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-app-capable" content="yes">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<style>
/* ------------------------------------------- */
/* üé® CSS GLOBAL Y VARIABLES */
/* ------------------------------------------- */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}
:root{
  --bg-primary: #0e1635;
  --bg-card: #1c264a;
  --bg-darker: #090f2b;
  --text: #ffffff;
  --muted: #aeb4c6;
  --accent: #ff477e;
  --accent-2: #ff72a1;
  --shadow-dark: rgba(0, 0, 0, 0.7);
  --shadow-accent: rgba(255, 71, 126, 0.5);
  --nav-height: 60px;
  --watched-color: #58679b; /* Color para cap√≠tulos vistos */
}

/* üíª Base */
body{
  font-family:'Inter','Poppins',sans-serif;
  background:var(--bg-primary);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  scroll-behavior:smooth;
  line-height:1.45;
  padding-top: 0;
}


/* üöÄ Contenido Principal */
main{
  padding:0;
  padding-bottom: var(--nav-height);
  position: relative;
}

/* üîé VISTA DE BUSCADOR */
#searchView {
    position: fixed; 
    inset: 0;
    background: var(--bg-primary);
    z-index: 55;
    padding-top: 24px; 
    display: none;
    overflow-y: auto;
    padding-bottom: calc(24px + var(--nav-height));
    animation: fadeIn .3s ease-out;
}
@keyframes fadeIn {from{opacity:0;} to{opacity:1;}}

#searchHeader {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 0 3vw;
}
#backFromSearch {
    font-size: 1.5rem;
    color: var(--muted);
    cursor: pointer;
    display: none; 
}
#searchInput {
    flex-grow: 1;
    padding: 12px 18px;
    border-radius: 10px;
    border: 2px solid transparent;
    font-size: 1.05rem;
    background: var(--bg-card);
    color: var(--text);
    transition: border-color .3s, box-shadow .3s;
}
#searchInput:focus {
    border-color: var(--accent);
    box-shadow: 0 0 12px rgba(255, 71, 126, 0.4);
    outline: none;
}
#searchResultsTitle {
    font-size: 1.4rem;
    padding: 0 3vw;
    margin-bottom: 15px;
    color: var(--accent-2);
}
/* MODIFICADO: Cuadr√≠cula de B√∫squeda ahora usa minmax(120px, 1fr) para m√°s columnas */
#searchResultsGrid {
    padding: 0 3vw;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
    gap: 10px;
}

/* üé¨ SECCIONES DE CONTENIDO */
#mainView {
    padding-top: 0; 
}
.content-section {
    padding: 15px 0 25px 0;
    margin-bottom: 5px;
}
.section-title {
    font-size: 1.6rem;
    font-weight: 700;
    padding: 0 3vw;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent);
    padding-left: 14px;
}
/* SLIDER DE SCROLL HORIZONTAL (Manual) */
.horizontal-scroll {
    display: flex;
    overflow-x: scroll; /* Scroll manual activado */
    padding: 10px 3vw;
    gap: 15px;
    -webkit-overflow-scrolling: touch;
}
.horizontal-scroll::-webkit-scrollbar {
    display: none; /* Oculta la barra de scroll en navegadores Webkit */
}

/* üÉè Tarjeta (Card) - AJUSTADA */
.card{
  flex: 0 0 140px; /* ANCHO M√çNIMO DE 140px para la vista Home y el scroll horizontal */
  background:var(--bg-card);
  border-radius:6px;
  overflow:hidden;
  cursor:pointer;
  transition:transform .3s,box-shadow .3s,opacity .5s;
  opacity:0;
  box-shadow:0 2px 8px rgba(0,0,0,.5);
}
.card.show{opacity:1}
.card:hover{transform:translateY(-5px);box-shadow:0 10px 20px var(--shadow-accent);}
.card img{
  display:block;
  width:100%;
  /* ‚û°Ô∏è MODIFICADO: Altura reducida a 200px (m√°s peque√±a) */
  height:200px; 
  object-fit:cover;
  transition:transform .3s;
}
.card:hover img{transform: scale(1.03);}
.info{padding:8px 6px;min-height:55px;}
.info h3{
    font-size:0.95rem;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
}
.info span{display:block;margin-top:2px;color:var(--muted);font-size:.8rem;font-weight:300;}

/* üåü HERO/HEADER DE NOVEDADES (Estatica) */
.hero-static-container {
    position: relative;
    width: 100%;
    margin-bottom: 20px;
    height: 300px; /* Altura del hero */
    overflow: hidden;
}

.hero-static-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    filter: brightness(0.6);
}
.hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(0deg, var(--bg-primary) 0%, rgba(14,22,53,0.5) 50%, rgba(14,22,53,0) 100%);
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding: 30px 3vw;
}
.hero-overlay h1 {
    font-size: 2rem;
    margin-bottom: 8px;
    max-height: 2.8em; 
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}
.hero-overlay p {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 15px;
    max-height: 2.8em; 
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.play-button-hero {
    background: var(--accent);
    color: var(--bg-primary);
    padding: 12px 25px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1.05rem;
    cursor: pointer;
    transition: background-color .3s, transform .3s, box-shadow .3s;
    border: none;
    display: flex;
    align-items: center;
    gap: 8px;
    width: fit-content;
}
.play-button-hero:hover {
    background: var(--accent-2);
    transform: translateY(-2px);
    box-shadow: 0 8px 15px var(--shadow-accent);
}

/* ------------------------------------------- */


/* ------------------------------------------- */
/* ‚¨áÔ∏è MEN√ö DE NAVEGACI√ìN INFERIOR */
/* ------------------------------------------- */
#bottomNav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: var(--nav-height);
  background: var(--bg-darker);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 -4px 15px var(--shadow-dark);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
  padding: 0 5px;
}
.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4px 0;
  flex: 1;
  color: var(--muted);
  font-size: 0.7rem;
  font-weight: 500;
  cursor: pointer;
  user-select: none;
  min-width: 0; 
}
.nav-item i {
  font-size: 1.2rem;
  margin-bottom: 3px;
}
.nav-item.active {
  color: var(--accent);
}

/* Grid de resultados y paginaci√≥n */
/* MODIFICADO: La cuadr√≠cula principal ahora usa minmax(120px, 1fr) para m√°s columnas */
#dynamicGrid {
    padding: 0 3vw;
    display: grid;
    /* ‚û°Ô∏è MODIFICADO: Grid para PC (4 columnas o m√°s) */
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
    gap: 10px;
    margin-bottom: 20px;
    margin-top: 20px;
}

#loadingIndicator {
    display: none;
    text-align: center;
    padding: 15px;
    color: var(--muted);
}


/* ------------------------------------------- */
/* üñºÔ∏è VISTA DE DETALLE */
/* ------------------------------------------- */
#detailView{
    position:fixed;
    inset:0;
    background:var(--bg-primary);
    overflow-y:auto; 
    display:none;
    z-index:200;
    animation:fade .3s ease-out;
}

.detail-header{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:16px;padding:16px 3vw;background:linear-gradient(180deg,rgba(14,22,53,.98),transparent);backdrop-filter:blur(5px);box-shadow:0 2px 10px rgba(0,0,0,.5);}
.btn{border:0;background:var(--accent);color:var(--bg-primary);padding:10px 18px;border-radius:8px;font-weight:700;cursor:pointer;transition:.3s;}
.btn:hover{background:var(--accent-2);transform:translateY(-2px);box-shadow: 0 4px 15px rgba(255, 71, 126, 0.4);}
.detail-title{flex:1;font-size:1.4rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;}
.detail-main{display:flex;flex-wrap:wrap;gap:35px;padding:35px 3vw; position: relative; z-index: 5;}

.details{flex:1 1 560px; position: relative;}

.details h2{font-size:2.2rem;margin-bottom:8px}

.details p#detailDesc{
    color:var(--muted);
    line-height:1.6;
    margin:10px 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}
.details p#detailGenres{color:var(--accent-2);font-weight:600;margin-top:15px}

/* Bot√≥n de Favorito */
#favoriteBtn {
    position: absolute;
    top: 0;
    right: 0;
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--muted);
    transition: color 0.3s, transform 0.2s;
}
#favoriteBtn.active {
    color: var(--accent);
    transform: scale(1.1);
}

/* üé¨ SECCI√ìN DE EPISODIOS/CAP√çTULOS */
.episodes{margin-top:26px;padding-top:18px;border-top:1px solid rgba(255,255,255,.15);}
.episodes h3{margin-bottom:12px;text-transform:uppercase;font-size:1.2rem;}
.episodes-list{
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 400px; 
    overflow-y: scroll; 
    padding-right: 8px;
    -webkit-overflow-scrolling: touch; 
}
.episodes-list::-webkit-scrollbar { width: 6px; }
.episodes-list::-webkit-scrollbar-thumb { background-color: var(--accent-2); border-radius: 10px; }
.episodes-list::-webkit-scrollbar-track { background: #31406e; }


.episode-item{
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-card);
    border-radius: 8px;
    padding: 8px;
    cursor: pointer;
    transition: background-color .3s, transform .2s, border-color .3s;
    border: 1px solid transparent;
}
.episode-item:hover{
    background-color: #2a385f;
    transform: translateX(4px);
}
.episode-item.active{
    border-color: var(--accent);
    background: #31406e;
}
/* Estilo para el cap√≠tulo VISTO */
.episode-item.watched {
    background-color: var(--watched-color); 
    border-color: #31406e; 
    opacity: 0.85; 
}
.episode-item.watched .play-icon {
    color: var(--muted); 
}
.episode-item.watched:hover {
    background-color: #58679b; 
    opacity: 1;
}


.episode-thumb{
    flex-shrink: 0;
    width: 80px;
    height: 45px;
    overflow: hidden;
    border-radius: 4px;
}
.episode-thumb img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}
.episode-info{
    flex-grow: 1;
}
.episode-info strong{
    display: block;
    font-size: 0.95rem;
    color: var(--text);
    white-space: nowrap; 
    overflow: hidden;
    text-overflow: ellipsis;
}
.episode-info span{
    display: block;
    font-size: 0.8rem;
    color: var(--muted);
}
.play-icon{
    font-size: 1.2rem;
    color: var(--accent);
    flex-shrink: 0;
    padding: 8px;
}

/* üì± Media Queries */
@media (max-width:900px){
    .details h2{font-size:1.8rem}
    .hero-overlay h1 { font-size: 1.6rem; }
}

/* ‚û°Ô∏è MODIFICADO: Regla para m√≥viles (max-width: 680px) */
@media (max-width:680px){
    /* Ajuste para pantallas peque√±as */
    .card{
        /* En la vista de cuadr√≠cula (dynamicGrid) y b√∫squeda, las tarjetas se ajustan al grid */
        flex: 1 1 auto; 
    }
    .card img{
        /* Altura reducida a 170px para m√≥vil en vista de cuadr√≠cula */
        height:170px;
    } 

    /* üéØ CAMBIO CLAVE: En las vistas de Series/Pel√≠culas, forzamos 3 columnas */
    #dynamicGrid {
        /* Fuerza 3 columnas de igual ancho para Series, Pel√≠culas, Canales y Favoritos */
        grid-template-columns: repeat(3, 1fr); 
    }
    
    /* Ajuste para las tarjetas en el scroll horizontal, manteniendo el ancho fijo */
    .horizontal-scroll .card {
        flex: 0 0 140px; 
    }
}
@media (max-width:480px){
    /* Ajuste para pantallas a√∫n m√°s peque√±as (m√≥viles muy peque√±os) */
    #dynamicGrid {
        /* Permite que se adapten autom√°ticamente si 3 es demasiado ancho (por ejemplo, 2 columnas) */
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
    }
}
</style>
</head>
<body>

<main>
  <div id="mainView">
    <div id="content">
        </div>
    <div id="loadingIndicator">Cargando...</div>
  </div>
  
  <div id="searchView">
    <div id="searchHeader">
        <i class="fas fa-arrow-left" id="backFromSearch"></i>
        <input type="text" id="searchInput" placeholder="Buscar contenido, g√©nero...">
    </div>
    <h2 id="searchResultsTitle"></h2>
    <div id="searchResultsGrid">
    </div>
  </div>
</div>

<div id="detailView">
    <div class="detail-header">
        <button id="backBtn" class="btn">‚ùÆ Volver</button>
        <h2 id="detailTitle" class="detail-title"></h2>
    </div>

    <div class="detail-main">
        <div class="details">
            <h2 id="detailName"></h2>
            <button id="favoriteBtn"><i class="fas fa-heart"></i></button>
            <p id="detailDesc"></p>
            <p id="detailGenres"></p>

            <div id="detailEpisodes" class="episodes">
                <h3>Cap√≠tulos</h3>
                <div class="episodes-list"></div>
            </div>
        </div>
    </div>
</div>

<nav id="bottomNav">
  <div class="nav-item active" data-tab="home">
    <i class="fas fa-house-chimney"></i>
    <span>Inicio</span>
  </div>
  <div class="nav-item" data-tab="series">
    <i class="fas fa-clapperboard"></i>
    <span>Series</span>
  </div>
  <div class="nav-item" data-tab="movies">
    <i class="fas fa-film"></i>
    <span>Pel√≠culas</span>
  </div>
  <div class="nav-item" data-tab="channels">
    <i class="fas fa-tv"></i>
    <span>Canales</span>
  </div>
  <div class="nav-item" data-tab="favorites">
    <i class="fas fa-heart"></i>
    <span>Favoritos</span>
  </div>
  <div class="nav-item" data-tab="search">
    <i class="fas fa-search"></i>
    <span>Buscar</span>
  </div>
</nav>

<script>
const ANIME_JSON = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
const M3U8_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";

let contentData = [], series = [], movies = [], channels = [];
let currentTab = 'home', currentItem = null;
let currentLoadLimit = 30;
const LOAD_INCREMENT = 30; 
let allContent = []; 
let isLoading = false; 

// Referencias del DOM
const content = document.getElementById('content');
const detailView = document.getElementById('detailView');
const backBtn = document.getElementById('backBtn');
const mainView = document.getElementById('mainView');
const searchView = document.getElementById('searchView');
const searchInput = document.getElementById('searchInput');
const searchResultsGrid = document.getElementById('searchResultsGrid');
const searchResultsTitle = document.getElementById('searchResultsTitle');
const bottomNavItems = document.querySelectorAll('.nav-item');
const favoriteBtn = document.getElementById('favoriteBtn');
const detailTitle = document.getElementById('detailTitle');
const detailName = document.getElementById('detailName');
const detailDesc = document.getElementById('detailDesc');
const detailGenres = document.getElementById('detailGenres');
const episodesListContainer = document.querySelector('.episodes-list'); 
const loadingIndicator = document.getElementById('loadingIndicator');

// ----------------------------------------------------
// --- FUNCIONES DE EPISODIOS VISTOS (CACHE) ---
// ----------------------------------------------------
function getWatchedEpisodes() {
    try {
        const watched = localStorage.getItem('animebox_watched');
        return watched ? JSON.parse(watched) : {};
    } catch(e) { 
        console.error("Error al leer episodios vistos:", e);
        return {};
    }
}
function saveWatchedEpisode(seriesId, episodeIndex) {
    let watched = getWatchedEpisodes();
    if (!watched[seriesId]) {
        watched[seriesId] = [];
    }
    if (!watched[seriesId].includes(episodeIndex)) {
        watched[seriesId].push(episodeIndex);
        try {
            localStorage.setItem('animebox_watched', JSON.stringify(watched));
            console.log(`Guardado: ${seriesId} - Episodio ${episodeIndex + 1} como visto.`);
        } catch(e) {
            console.error("Error al guardar episodio visto:", e);
        }
    }
}
function isEpisodeWatched(seriesId, episodeIndex) {
    const watched = getWatchedEpisodes();
    return watched[seriesId] && watched[seriesId].includes(episodeIndex);
}

// ----------------------------------------------------
// --- L√≥gica de Favoritos ---
function getFavorites() {
    try {
        const favs = localStorage.getItem('animebox_favorites');
        return favs ? JSON.parse(favs) : [];
    } catch(e) { return []; }
}
function saveFavorites(favs) {
    try { localStorage.setItem('animebox_favorites', JSON.stringify(favs)); }
    catch(e) { console.error("Error al guardar favoritos:", e); }
}
function isFavorite(item) {
    const favs = getFavorites();
    const itemId = item.id || item.title;
    return favs.some(fav => (fav.id || fav.title) === itemId);
}
function toggleFavorite(item) {
    let favs = getFavorites();
    const itemId = item.id || item.title;
    const index = favs.findIndex(fav => (fav.id || fav.title) === itemId);
    const itemToSave = { ...item, id: itemId };
    
    if (index > -1) {
        favs.splice(index, 1);
        favoriteBtn.classList.remove('active');
        if(currentTab === 'favorites') { renderCurrentTab(); } 
    } else {
        favs.push(itemToSave);
        favoriteBtn.classList.add('active');
    }
    saveFavorites(favs);
}
// ----------------------------


// --- Funciones de Datos y Separaci√≥n ---
async function fetchData(){
  try { 
    loadingIndicator.style.display = 'block';
    
    // Suponemos que contentData est√° ordenado del m√°s nuevo al m√°s viejo.
    contentData = await (await fetch(ANIME_JSON)).json(); 
    series = contentData.filter(item => item.episodes && item.episodes.length > 0);
    movies = contentData.filter(item => !item.episodes || item.episodes.length === 0);

    await fetchChannels();
    
    combineAllContent(); 

    loadingIndicator.style.display = 'none';
    renderCurrentTab();

  }
  catch(e){ 
    console.error("Error al cargar los datos:", e); 
    contentData=[]; series=[]; movies=[]; channels=[]; 
    content.innerHTML = `<p style="color:var(--accent); padding: 50px 3vw; text-align: center;">‚ùå Error al cargar los datos. Intenta recargar la p√°gina.</p>`;
    loadingIndicator.style.display = 'none';
  }
}

async function fetchChannels(){
  try {
    const res = await fetch(M3U8_URL);
    const text = await res.text();
    const lines = text.split(/\r?\n/);
    let current = null; channels=[];
    for(const lineRaw of lines){
      const line = lineRaw.trim();
      if(!line) continue;
      if(line.startsWith('#EXTINF:')){
        const logo = (line.match(/tvg-logo="([^"]*)"/)||[])[1]||null;
        const name = (line.match(/,(.*)$/)||[])[1]?.trim()||'Canal';
        // Asignar una imagen de marcador de posici√≥n si el logo es nulo
        const coverImage = logo || 'https://via.placeholder.com/140x200?text=TV'; 
        current = {id:name,title:name,coverImage,logo,type:'channel',isChannel:true, video_url:'', genre: ['En Vivo', 'Canal']};
      } else if(!line.startsWith('#') && current){
        current.video_url = line;
        channels.push(current);
        current=null;
      }
    }
  } catch(e){ console.error("Error al cargar canales:", e); channels=[]; }
}

function combineAllContent() {
    // El orden en contentData (series y pel√≠culas) se mantiene para priorizar la novedad
    allContent = [...contentData, ...channels]; 
}
// ----------------------------


// --- HERO Est√°tico (√öltimo Contenido A√±adido) ---
function renderStaticHero(item) {
    if (!item) return null;
    
    const container = document.createElement('div');
    container.className = 'hero-static-container';
    
    const heroCover = item.coverImage || 'https://via.placeholder.com/600x300?text=√öltima Novedad';
    const itemId = item.id || item.title;

    container.innerHTML = `
        <img src="${heroCover}" alt="${item.title}" onerror="this.onerror=null;this.src='https://via.placeholder.com/600x300?text=√öltima Novedad';">
        <div class="hero-overlay">
            <h1>${item.title}</h1>
            <p>${item.description || 'La √∫ltima adici√≥n a nuestro cat√°logo premium. ¬°No te la pierdas!'}</p>
            <button class="play-button-hero" onclick="openDetail(allContent.find(i => (i.id || i.title) === '${itemId}'))">
                <i class="fas fa-play"></i>
                Reproducir Ahora
            </button>
        </div>
    `;

    return container;
}
// ----------------------------------------------------


// --- Renderizado de Tarjeta ---
function createCardHTML(item) {
    const cover = item.coverImage || item.logo || 'https://via.placeholder.com/140x200?text=Portada'; // Ajustada altura placeholder
    const spanText = item.isChannel ? 'En vivo' : (item.genre ? item.genre[0] : '');
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `<img src="${cover}" alt="${item.title}" onerror="this.onerror=null;this.src='https://via.placeholder.com/140x200?text=Portada';"><div class="info"><h3>${item.title}</h3><span>${spanText}</span></div>`;
    card.onclick = () => openDetail(item);
    setTimeout(() => card.classList.add('show'), 50);
    return card;
}
// ----------------------------


// --- Renderizado de Vistas Principales (Home y Scroll Infinito) ---
function renderHomePage() {
    content.innerHTML = '';
    
    // üåü Obtiene el √∫ltimo elemento a√±adido (el primero de la lista)
    const featuredItem = allContent[0]; 
    
    // --- 1. Crear el Hero Est√°tico (√öltima Novedad) ---
    if (featuredItem) {
        const heroElement = renderStaticHero(featuredItem);
        if (heroElement) {
            content.appendChild(heroElement);
        }
    }
    
    // --- 2. Definir las secciones de scroll horizontal (G√©neros) ---
    const sections = [
        { title: ' Canales en Vivo', list: channels.slice(0, 10) },
        { title: ' Acci√≥n', genre: 'Acci√≥n', listType: 'all' },
        { title: ' Animaci√≥n', genre: 'Animaci√≥n', listType: 'all' },
        { title: ' Anime', genre: 'Anime', listType: 'all' },
        { title: ' Terror y Thriller', genre: 'Terror', listType: 'all' },
        { title: ' Documentales', genre: 'Documental', listType: 'all' },
    ];
    
    // Renderiza las secciones horizontales
    sections.forEach((section) => {
        let list = section.list;
        
        if (section.genre) {
            let source = allContent;
            if (section.listType === 'series') {
                source = series;
            } else if (section.listType === 'movies') {
                source = movies;
            }
            
            // Filtra por g√©nero y toma los 10 primeros (ordenados por novedad impl√≠cita)
            list = source.filter(a => a.genre && a.genre.includes(section.genre)).slice(0, 10);
        }

        if (list && list.length > 0) {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'content-section';

            const titleElement = document.createElement('h2');
            titleElement.className = 'section-title';
            titleElement.textContent = section.title;

            const scrollDiv = document.createElement('div');
            scrollDiv.className = 'horizontal-scroll';

            list.forEach(item => {
                scrollDiv.appendChild(createCardHTML(item));
            });
            
            sectionDiv.appendChild(titleElement);
            sectionDiv.appendChild(scrollDiv);
            content.appendChild(sectionDiv);
        }
    });

    content.classList.add('loaded');
}

function renderGridPagePaginated(list, titleText, initialLoad = true) {
    if (initialLoad) {
        content.innerHTML = '';
        currentLoadLimit = LOAD_INCREMENT; 
        
        const title = document.createElement('h2');
        title.className = 'section-title';
        title.textContent = titleText;
        title.style.paddingLeft = '3vw';
        title.style.marginTop = '20px'; 
        content.appendChild(title);

        const gridDiv = document.createElement('div');
        gridDiv.id = 'dynamicGrid';
        content.appendChild(gridDiv);
        content.appendChild(loadingIndicator); 

        if (list.length === 0) {
            gridDiv.innerHTML = `<p style="color:var(--muted); padding: 20px 0; text-align: center;">${currentTab === 'favorites' ? 'No tienes favoritos guardados.' : 'No hay contenido disponible.'}</p>`;
            loadingIndicator.style.display = 'none';
            return;
        }
    }

    const gridDiv = document.getElementById('dynamicGrid');
    
    const itemsToRender = list.slice(0, currentLoadLimit);
    const newItems = itemsToRender.slice(gridDiv.children.length);
    
    if (initialLoad) {
        gridDiv.innerHTML = ''; 
    }

    newItems.forEach(item => {
        gridDiv.appendChild(createCardHTML(item));
    });

    if (gridDiv.children.length < list.length) {
        loadingIndicator.style.display = 'block';
        loadingIndicator.textContent = `Cargando m√°s contenido... (${gridDiv.children.length}/${list.length})`;
    } else {
        if(list.length > 0) {
            loadingIndicator.style.display = 'block';
            loadingIndicator.textContent = `Fin de resultados (${list.length} en total)`;
        } else {
            loadingIndicator.style.display = 'none';
        }
    }

    content.classList.add('loaded');
    isLoading = false; 
}
// ----------------------------


// --- L√≥gica de Scroll Infinito ---
function handleScrollPagination() {
    // Solo si estamos en una vista de cuadr√≠cula paginada
    if (['series', 'movies', 'channels', 'favorites'].includes(currentTab) && !isLoading) {

        const scrollTop = document.documentElement.scrollTop;
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;

        const threshold = 100; 

        if (scrollTop + clientHeight >= scrollHeight - threshold) {
            let list = [];
            let title = '';

            if (currentTab === 'series') {
                list = series; title = 'Todas las Series';
            } else if (currentTab === 'movies') {
                list = movies; title = 'Todas las Pel√≠culas';
            } else if (currentTab === 'channels') {
                list = channels; title = 'Todos los Canales en Vivo';
            } else if (currentTab === 'favorites') {
                list = getFavorites(); title = 'Mis Favoritos';
            }
            
            if (currentLoadLimit < list.length) {
                isLoading = true; 
                currentLoadLimit += LOAD_INCREMENT;
                
                setTimeout(() => {
                    renderGridPagePaginated(list, title, false);
                }, 100); 
            } else {
                if(list.length > 0) {
                    loadingIndicator.style.display = 'block';
                    loadingIndicator.textContent = `Fin de resultados (${list.length} en total)`;
                }
            }
        }
    }
}

window.addEventListener('scroll', handleScrollPagination);
// ----------------------------


// --- L√≥gica de Vistas (Navegaci√≥n) ---
function showView(viewId) {
    mainView.style.display = viewId === 'mainView' ? 'block' : 'none';
    searchView.style.display = viewId === 'searchView' ? 'block' : 'none';
}

function renderCurrentTab(){
    // Limpiar el estado activo del bot√≥n Volver de la b√∫squeda
    document.getElementById('backFromSearch').style.display = 'none';
    
    // Actualizar texto del nav-item
    document.querySelector('.nav-item[data-tab="home"] span').textContent = 'Inicio';
    document.querySelector('.nav-item[data-tab="series"] span').textContent = 'Series';
    document.querySelector('.nav-item[data-tab="movies"] span').textContent = 'Pel√≠culas';
    document.querySelector('.nav-item[data-tab="channels"] span').textContent = 'Canales';
    document.querySelector('.nav-item[data-tab="favorites"] span').textContent = 'Favoritos';
    document.querySelector('.nav-item[data-tab="search"] span').textContent = 'Buscar';
    
    if(allContent.length > 0) {
        loadingIndicator.style.display = 'none';
    }
    isLoading = false;

    if (currentTab === 'search') {
        showView('searchView');
        searchInput.focus();
        searchResultsGrid.innerHTML = '';
        searchResultsTitle.textContent = "Empieza a escribir para buscar (t√≠tulo o g√©nero)...";
        document.getElementById('backFromSearch').style.display = 'block'; 
        return;
    }
    
    showView('mainView');
    
    if(currentTab === 'home'){
        renderHomePage();
    } else if (currentTab === 'series') {
        renderGridPagePaginated(series, 'Todas las Series', true);
    } else if (currentTab === 'movies') {
        renderGridPagePaginated(movies, 'Todas las Pel√≠culas', true);
    } else if (currentTab === 'channels') {
        renderGridPagePaginated(channels, 'Todos los Canales en Vivo', true);
    } else if (currentTab === 'favorites') {
        renderGridPagePaginated(getFavorites(), 'Mis Favoritos', true);
    }
    window.scrollTo(0, 0);
}

// Eventos de Navegaci√≥n Inferior
bottomNavItems.forEach(btn => btn.onclick = () => {
  bottomNavItems.forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  if(currentTab === 'search' && btn.dataset.tab !== 'search') {
    // Simular el cierre de la b√∫squeda al cambiar de pesta√±a
    searchInput.value = '';
    showView('mainView');
    currentTab = btn.dataset.tab;
  } else {
    currentTab = btn.dataset.tab;
  }
  
  renderCurrentTab();
});


// Eventos de Buscador
document.getElementById('backFromSearch').onclick = () => {
    searchInput.value = '';
    currentTab = 'home';
    document.querySelector('.nav-item.active').classList.remove('active');
    document.querySelector('.nav-item[data-tab="home"]').classList.add('active');
    renderCurrentTab();
}

searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase().trim();
    searchResultsGrid.innerHTML = '';
    
    if (query.length < 2) {
        searchResultsTitle.textContent = "Empieza a escribir para buscar (t√≠tulo o g√©nero)...";
        return;
    }
    
    // MODIFICADO: Ahora el filtro es m√°s robusto y busca en el g√©nero
    const filtered = allContent.filter(item => 
        item.title.toLowerCase().includes(query) ||
        (item.genre && item.genre.some(g => g.toLowerCase().includes(query))) || // Busca si *alg√∫n* g√©nero coincide con la query
        (item.description && item.description.toLowerCase().includes(query))
    );

    searchResultsTitle.textContent = `Resultados para "${query}" (${filtered.length})`;

    if (filtered.length === 0) {
        searchResultsGrid.innerHTML = `<p style="color:var(--muted); padding: 20px 0; text-align: center;">No se encontraron resultados para "${query}".</p>`;
    } else {
        filtered.forEach(item => {
            searchResultsGrid.appendChild(createCardHTML(item));
        });
    }
});
// ----------------------------


// --- L√≥gica de Detalle ---
function openDetail(item){
    currentItem=item;
    
    const coverUrl = item.coverImage || item.logo || 'https://via.placeholder.com/140x200?text=Portada'; // Ajustada altura placeholder
    const seriesId = item.id || item.title; // Usamos ID o T√≠tulo como clave √∫nica para el cache de vistos
    
    detailView.classList.add('active'); 
    detailView.style.display='block';
    detailView.scrollTo(0, 0);
    
    detailTitle.textContent=detailName.textContent=item.title;
    detailDesc.textContent=item.description||'No hay descripci√≥n disponible para este contenido.';
    detailGenres.textContent=Array.isArray(item.genre)&&item.genre.length?'üé≠ '+item.genre.join(', '):'';
    
    favoriteBtn.onclick = () => toggleFavorite(item);
    if (isFavorite(item)) { favoriteBtn.classList.add('active'); } else { favoriteBtn.classList.remove('active'); }

    episodesListContainer.innerHTML='';
    const episodesSection = document.getElementById('detailEpisodes');
    episodesSection.style.display = 'block';

    if(item.episodes && item.episodes.length){
        // Si tiene episodios, se listan
        episodesSection.querySelector('h3').textContent = 'Cap√≠tulos';

        item.episodes.forEach((ep,i)=>{
            const episodeIndex = i; // √çndice base 0
            const isWatched = isEpisodeWatched(seriesId, episodeIndex);
            
            const episodeItem = document.createElement('div');
            // A√±ade la clase 'watched' si ya fue visto
            episodeItem.className = `episode-item ${isWatched ? 'watched' : ''}`;
            
            const thumbUrl = ep.thumb || item.coverImage || 'https://via.placeholder.com/80x45?text=Episodio'; 
            const episodeTitle = `Episodio ${i+1}`;
            
            // Cambiamos el icono para los vistos
            const iconClass = isWatched ? 'fas fa-check-circle' : 'fas fa-play';

            episodeItem.innerHTML = `
                <div class="episode-thumb"><img src="${thumbUrl}" alt="Ep. ${i+1}" onerror="this.onerror=null;this.src='https://via.placeholder.com/80x45?text=Episodio';"></div>
                <div class="episode-info">
                    <strong>${episodeTitle}</strong>
                    <span>${ep.title || item.title}</span>
                </div>
                <i class="${iconClass} play-icon"></i>
            `;
            
            episodeItem.onclick = () => {
                document.querySelectorAll('.episode-item').forEach(x => x.classList.remove('active'));
                
                // --- L√ìGICA DE GUARDADO DE VISTO ---
                saveWatchedEpisode(seriesId, episodeIndex); 
                // Actualiza el estado visual al hacer clic (marcar como visto y activo)
                episodeItem.classList.add('watched', 'active');
                episodeItem.querySelector('.play-icon').className = 'fas fa-check-circle play-icon';
                // ----------------------------------------
                
                window.open(ep.video_url, '_blank');
            };
            
            episodesListContainer.appendChild(episodeItem);
        });
    } else if(item.video_url){
        // Si es Pel√≠cula o Canal, un solo bot√≥n de Reproducir
        episodesSection.querySelector('h3').textContent = item.isChannel ? 'Ver Canal en Vivo' : 'Ver Pel√≠cula';
        
        const playItem = document.createElement('div');
        playItem.className = 'episode-item active'; 

        playItem.innerHTML = `
            <div class="episode-thumb"><img src="${coverUrl}" alt="Portada" onerror="this.onerror=null;this.src='https://via.placeholder.com/80x45?text=Portada';"></div>
            <div class="episode-info">
                <strong>${item.isChannel ? 'Reproducir Canal Ahora' : 'Ver Pel√≠cula Ahora'}</strong>
                <span>${item.title}</span>
            </div>
            <i class="fas fa-play play-icon"></i>
        `;

        playItem.onclick = () => {
            window.open(item.video_url, '_blank');
        };
        episodesListContainer.appendChild(playItem);

    } else {
        episodesSection.style.display = 'none';
    }
}

backBtn.onclick=()=>{
    detailView.style.display='none';
    detailView.classList.remove('active'); 
};
// ----------------------------


// --- Inicializaci√≥n ---
document.addEventListener('DOMContentLoaded',async()=>{
  await fetchData();
});
</script>

</body>
</html>
