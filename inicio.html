<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PrimeBox+ Premium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* BASE & RESET */
        *{ box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
        :root{
            --bg: #0f171e; --bg-card: #1a242f; --accent: #00a8e1; --text: #ffffff;
            --muted: #aeb4c6; --yt-red: #ff0000; --check: #2ecc71;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body, html{ font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100%; overflow: hidden; }

        main { height: 100vh; width: 100vw; overflow-y: auto; padding-bottom: 90px; scroll-behavior: smooth; }

        /* ANIMACIONES DE ENTRADA */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .view { display: none; animation: fadeInUp 0.4s ease-out; }
        .view.active { display: block; }

        /* HEADER PREMIUM */
        #heroBanner { position: relative; width: 100%; height: 380px; overflow: hidden; background: #000; }
        #heroBanner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; transition: transform 2s ease; }
        #heroBanner:hover img { transform: scale(1.05); }
        .hero-overlay { position: absolute; inset: 0; background: linear-gradient(0deg, var(--bg) 5%, transparent 70%); padding: 25px; display: flex; flex-direction: column; justify-content: flex-end; }
        .hero-overlay h1 { font-size: 2rem; margin-bottom: 12px; text-shadow: 2px 2px 10px rgba(0,0,0,0.8); font-weight: 800; }

        /* BADGES MEJORADOS */
        .badge { padding: 5px 12px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; width: fit-content; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .tag-series { background: #6c5ce7; color: white; }
        .tag-movie { background: var(--accent); color: white; }
        .tag-live { background: var(--yt-red); color: white; animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }

        /* SECCIONES Y SCROLL */
        .section-title { padding: 20px 15px 5px; font-size: 1.2rem; color: var(--text); font-weight: bold; letter-spacing: 0.5px; }
        .h-scroll { display: flex; overflow-x: auto; gap: 14px; padding: 15px; }
        .h-scroll::-webkit-scrollbar { display: none; }

        /* TARJETAS MODERNAS */
        .card {
            background: var(--bg-card); border-radius: 8px; overflow: hidden; position: relative;
            flex: 0 0 140px; transition: var(--transition); transform-origin: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .card:active { transform: scale(0.95); opacity: 0.8; }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; display: block; transition: 0.5s; }
        .card-info { padding: 10px; font-size: 0.8rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; background: linear-gradient(180deg, transparent, rgba(0,0,0,0.8)); position: absolute; bottom: 0; width: 100%; }

        /* ETIQUETA DE TIPO EN CARTA */
        .card::after {
            content: attr(data-type);
            position: absolute; top: 8px; right: 8px;
            font-size: 0.6rem; padding: 2px 6px; border-radius: 3px;
            background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            text-transform: uppercase; font-weight: bold;
        }

        /* CAPÍTULOS */
        .ep-card { display: flex; background: var(--bg-card); border-radius: 10px; margin-bottom: 12px; overflow: hidden; text-decoration: none; color: white; border: 1px solid rgba(255,255,255,0.05); transition: var(--transition); }
        .ep-card:active { background: #252e39; transform: scale(0.98); }
        .ep-thumb { width: 130px; height: 75px; position: relative; flex-shrink: 0; }
        .ep-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ep-progress { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: 0.8s ease; }
        .ep-info { padding: 12px; flex: 1; display: flex; align-items: center; justify-content: space-between; }

        /* NAV CON BLUR */
        nav { position: fixed; bottom: 0; width: 100%; height: 75px; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); display: flex; border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); font-size: 0.7rem; transition: var(--transition); opacity: 0.7; }
        .nav-item.active { color: var(--accent); opacity: 1; transform: translateY(-3px); }
        .nav-item i { font-size: 1.4rem; margin-bottom: 5px; }

        /* DETAIL VIEW ANIMATION */
        #detailView { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .btn-action { background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; padding: 16px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-bottom: 15px; width: 100%; border: none; font-size: 1rem; transition: var(--transition); box-shadow: 0 4px 15px rgba(0,168,225,0.3); }
        .btn-action:active { transform: scale(0.96); }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 15px; animation: fadeInUp 0.5s ease; }
    </style>
</head>
<body>

    <main id="mainScroll">
        <div id="homeView" class="view active">
            <div id="heroBanner"></div>
            <div id="homeSections"></div>
        </div>

        <div id="gridView" class="view">
            <h2 id="gridTitle" class="section-title"></h2>
            <div id="dynamicGrid" class="grid"></div>
        </div>

        <div id="favView" class="view">
            <h2 class="section-title">Mis Favoritos</h2>
            <div id="favGrid" class="grid"></div>
        </div>

        <div id="searchView" class="view">
            <div style="padding:15px; position:sticky; top:0; background:var(--bg); z-index:100;">
                <input type="text" id="searchInput" placeholder="Buscar películas, series o canales..." style="width:100%; padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.1); background:var(--bg-card); color:white; outline:none; font-size:1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            </div>
            <div id="searchGrid" class="grid"></div>
        </div>
    </main>

    <div id="detailView">
        <button onclick="closeDetail()" style="position:absolute; top:20px; left:20px; z-index:10; background:rgba(0,0,0,0.6); backdrop-filter:blur(5px); border:none; color:white; width:45px; height:45px; border-radius:50%;"><i class="fas fa-arrow-left"></i></button>
        <button id="favBtn" class="btn-fav" onclick="toggleFav()" style="position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.6); backdrop-filter:blur(5px); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; z-index: 10; font-size: 1.2rem;"><i class="fas fa-heart"></i></button>

        <div style="width:100%; height:350px; position:relative;">
            <img id="detImg" style="width:100%; height:100%; object-fit:cover;">
            <div style="position:absolute; inset:0; background:linear-gradient(0deg, var(--bg) 10%, transparent);"></div>
        </div>

        <div style="padding:20px; transform: translateY(-40px);">
            <div id="detBadgeArea"></div>
            <h2 id="detTitle" style="font-size:2rem; margin-top:10px;"></h2>
            <p id="detDesc" style="color:var(--muted); font-size:0.95rem; margin:15px 0 25px; line-height:1.6;"></p>
            <div id="mainAction"></div>
            <div id="epList"></div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i><span>Inicio</span></div>
        <div class="nav-item" onclick="switchTab('series')"><i class="fas fa-tv"></i><span>Series</span></div>
        <div class="nav-item" onclick="switchTab('movies')"><i class="fas fa-film"></i><span>Películas</span></div>
        <div class="nav-item" onclick="switchTab('favs')"><i class="fas fa-heart"></i><span>Favoritos</span></div>
        <div class="nav-item" onclick="switchTab('channels')"><i class="fas fa-broadcast-tower"></i><span>En Vivo</span></div>
        <div class="nav-item" onclick="switchTab('search')"><i class="fas fa-search"></i><span>Buscar</span></div>
    </nav>

    <script>
        const DATA_JSON = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        const M3U_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";

        let db = { all: [], series: [], movies: [], channels: [] };
        let favs = JSON.parse(localStorage.getItem('pb_vfinal_favs') || '[]');
        let watched = JSON.parse(localStorage.getItem('pb_vfinal_watched') || '{}');
        let currentFilter = [], page = 0, activeTab = 'home', currentItem = null;

        async function init() {
            try {
                const [r1, r2] = await Promise.all([
                    fetch(DATA_JSON).then(r=>r.json()),
                    fetch(M3U_URL).then(r=>r.text())
                ]);
                db.series = r1.filter(i => i.episodes).map(i => ({...i, type:'Serie'}));
                db.movies = r1.filter(i => !i.episodes).map(i => ({...i, type:'Peli'}));
                db.channels = parseM3U(r2).filter(c => c.url && c.url.trim().startsWith('http')).map(c => ({...c, type:'Live'}));
                db.all = [...db.series, ...db.movies, ...db.channels];

                renderHero();
                renderHome();
                setupScroll();
            } catch(e) { console.error("Error cargando app"); }
        }

        function parseM3U(text) {
            const lines = text.split('\n');
            let res = [], cur = null;
            lines.forEach(l => {
                if(l.includes('#EXTINF')) {
                    const isEvent = l.toLowerCase().includes('group-title="evento"');
                    cur = { title: l.split(',')[1]?.trim(), img: l.match(/tvg-logo="([^"]*)"/)?.[1], isChannel: true, isEvent: isEvent };
                } else if(l.startsWith('http') && cur) {
                    cur.url = l.trim(); res.push(cur); cur = null;
                }
            });
            return res;
        }

        function renderHero() {
            const h = document.getElementById('heroBanner');
            const eventItem = db.channels.find(c => c.isEvent);

            if(eventItem) {
                h.innerHTML = `
                    <img src="${eventItem.img || 'https://via.placeholder.com/800x450?text=Evento+en+Vivo'}">
                    <div class="hero-overlay">
                        <div class="badge tag-live">EN VIVO AHORA</div>
                        <h1>${eventItem.title}</h1>
                        <a href="${eventItem.url}" class="btn-action" style="width:fit-content; padding: 12px 30px;">VER EVENTO</a>
                    </div>`;
            } else {
                const randomItem = db.all.filter(i => !i.isChannel)[Math.floor(Math.random() * (db.all.length - db.channels.length))];
                if(randomItem) {
                    h.innerHTML = `
                        <img src="${randomItem.img || randomItem.coverImage}">
                        <div class="hero-overlay">
                            <div class="badge tag-movie">DESTACADO HOY</div>
                            <h1>${randomItem.title}</h1>
                            <button onclick='openDetail(${JSON.stringify(randomItem).replace(/'/g, "'")})' class="btn-action" style="width:fit-content; padding: 12px 30px;">VER DETALLES</button>
                        </div>`;
                }
            }
        }

        function createCard(item) {
            const div = document.createElement('div');
            div.className = 'card';
            div.setAttribute('data-type', item.type || '');
            div.innerHTML = `<img src="${item.img || item.coverImage}" loading="lazy"><div class="card-info">${item.title}</div>`;
            div.onclick = () => openDetail(item);
            return div;
        }

        function renderHome() {
            const container = document.getElementById('homeSections');
            container.innerHTML = '';
            const sections = [
                { t: "Mis Favoritos", d: db.all.filter(i => favs.includes(i.title)) },
                { t: "Canales en Vivo", d: db.channels },
                { t: "Series Premium", d: db.series },
                { t: "Películas de Estreno", d: db.movies }
            ];
            sections.forEach(s => {
                if(s.d.length > 0) {
                    const wrap = document.createElement('div');
                    wrap.innerHTML = `<h2 class="section-title">${s.t}</h2><div class="h-scroll"></div>`;
                    s.d.slice(0, 15).forEach(item => wrap.querySelector('.h-scroll').appendChild(createCard(item)));
                    container.appendChild(wrap);
                }
            });
        }

        function openDetail(item) {
            if(typeof item === 'string') item = JSON.parse(item);
            currentItem = item;
            document.getElementById('detTitle').textContent = item.title;
            document.getElementById('detImg').src = item.img || item.coverImage;
            document.getElementById('detDesc').textContent = item.description || "Disfruta de este contenido premium con la mejor calidad de audio y video en PrimeBox+.";

            const badgeArea = document.getElementById('detBadgeArea');
            badgeArea.innerHTML = item.episodes ? '<span class="badge tag-series">SERIE COMPLETA</span>' : (item.isChannel ? '<span class="badge tag-live">CANAL TV</span>' : '<span class="badge tag-movie">PELÍCULA</span>');

            document.getElementById('favBtn').style.color = favs.includes(item.title) ? '#ff4757' : 'white';
            renderEpisodes();
            document.getElementById('detailView').style.display = 'block';
        }

        function renderEpisodes() {
            const actionArea = document.getElementById('mainAction');
            const epArea = document.getElementById('epList');
            actionArea.innerHTML = ''; epArea.innerHTML = '';
            if(currentItem.episodes) {
                const nextIdx = currentItem.episodes.findIndex((_, i) => !watched[`${currentItem.title}_${i}`]);
                const playIdx = nextIdx === -1 ? 0 : nextIdx;
                actionArea.innerHTML = `<a href="${currentItem.episodes[playIdx].video_url}" onclick="setWatched(${playIdx}); renderEpisodes();" class="btn-action"><i class="fas fa-play"></i>&nbsp;&nbsp;CONTINUAR CAP ${playIdx + 1}</a>`;
                currentItem.episodes.forEach((ep, i) => {
                    const id = `${currentItem.title}_${i}`;
                    const div = document.createElement('a');
                    div.className = `ep-card ${watched[id] ? 'is-watched' : ''}`;
                    div.href = ep.video_url;
                    div.onclick = (e) => { setWatched(i); renderEpisodes(); };
                    div.innerHTML = `
                        <div class="ep-thumb"><img src="${currentItem.img || currentItem.coverImage}"><div class="ep-progress" style="width:${watched[id]?'100':'0'}%"></div></div>
                        <div class="ep-info"><h4>Episodio ${i+1}</h4><i class="fas fa-check-circle" style="color:var(--check); display:${watched[id]?'block':'none'}"></i></div>`;
                    epArea.appendChild(div);
                });
            } else {
                actionArea.innerHTML = `<a href="${currentItem.url || currentItem.video_url}" class="btn-action"><i class="fas fa-play"></i>&nbsp;&nbsp;REPRODUCIR AHORA</a>`;
            }
        }

        function switchTab(tab) {
            activeTab = tab; page = 0;
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(tab === 'home') {
                document.getElementById('homeView').classList.add('active');
            } else if(tab === 'search') {
                document.getElementById('searchView').classList.add('active');
            } else if(tab === 'favs') {
                document.getElementById('favView').classList.add('active');
                renderFavsGrid();
            } else {
                document.getElementById('gridView').classList.add('active');
                document.getElementById('gridTitle').textContent = tab === 'series' ? 'Series Premium' : (tab === 'movies' ? 'Películas de Estreno' : 'Televisión en Vivo');
                document.getElementById('dynamicGrid').innerHTML = '';
                currentFilter = db[tab];
                loadMore();
            }
        }

        function renderFavsGrid() {
            const grid = document.getElementById('favGrid');
            grid.innerHTML = '';
            const myFavs = db.all.filter(i => favs.includes(i.title));
            if(myFavs.length === 0) grid.innerHTML = '<p style="padding:20px; color:var(--muted);">No tienes favoritos aún.</p>';
            else myFavs.forEach(item => grid.appendChild(createCard(item)));
        }

        function loadMore() {
            const grid = activeTab === 'search' ? document.getElementById('searchGrid') : document.getElementById('dynamicGrid');
            const chunk = currentFilter.slice(page * 30, (page + 1) * 30);
            chunk.forEach(item => grid.appendChild(createCard(item)));
            page++;
        }

        function toggleFav() {
            const name = currentItem.title;
            if(favs.includes(name)) favs = favs.filter(n => n !== name);
            else favs.push(name);
            localStorage.setItem('pb_vfinal_favs', JSON.stringify(favs));
            document.getElementById('favBtn').style.color = favs.includes(name) ? '#ff4757' : 'white';
            if(activeTab === 'favs') renderFavsGrid();
            renderHome();
        }

        function setWatched(idx) {
            watched[`${currentItem.title}_${idx}`] = true;
            localStorage.setItem('pb_vfinal_watched', JSON.stringify(watched));
        }

        function setupScroll() {
            document.getElementById('mainScroll').onscroll = (e) => {
                const el = e.target;
                if(activeTab !== 'home' && activeTab !== 'favs' && el.scrollTop + el.clientHeight >= el.scrollHeight - 300) {
                    if(currentFilter.length > page * 30) loadMore();
                }
            };
        }

        document.getElementById('searchInput').oninput = (e) => {
            const q = e.target.value.toLowerCase();
            const grid = document.getElementById('searchGrid');
            grid.innerHTML = '';
            if(q.length < 2) return;
            currentFilter = db.all.filter(i => i.title.toLowerCase().includes(q));
            page = 0;
            loadMore();
        };

        function closeDetail() { document.getElementById('detailView').style.display = 'none'; }

        init();
    </script>
</body>
</html>
