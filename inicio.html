<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AnimeRoll | Vortex Edition</title>
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root {
            --cr-bg: #000000;
            --cr-bg-card: #23252b;
            --cr-orange: #f47521; 
            --cr-text: #ffffff;
            --cr-subtext: #a0a0a0;
            --nav-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: 'Roboto', sans-serif; 
            background-color: var(--cr-bg); 
            color: var(--cr-text); 
            overflow: hidden; 
            height: 100vh;
            user-select: none;
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        img { -webkit-user-drag: none; }

        main {
            position: absolute; inset: 0; 
            padding-bottom: var(--nav-height); 
            overflow: hidden;
        }

        .view-container {
            height: 100%; width: 100%;
            overflow-y: auto; overflow-x: hidden;
            display: none; padding-bottom: 30px;
        }
        
        .view-container.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        @keyframes cardPop {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card-animate { animation: cardPop 0.4s ease forwards; opacity: 0; }

        .app-header {
            position: absolute; top: 0; left: 0; right: 0;
            height: 60px; z-index: 50;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px;
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
        }
        .logo-text { 
            color: var(--cr-orange); font-weight: 900; font-size: 1.3rem; 
            letter-spacing: 1px; text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .event-header-btn {
            background: linear-gradient(45deg, #ff0000, #ff4d4d);
            color: white; font-weight: 900; font-size: 0.75rem;
            padding: 5px 10px; border-radius: 20px;
            box-shadow: 0 0 10px red;
            display: flex; align-items: center; gap: 5px;
            cursor: pointer; margin-right: 10px;
            animation: pulseEvent 2s infinite;
        }
        @keyframes pulseEvent { 0%{transform:scale(1);} 50%{transform:scale(1.05); box-shadow: 0 0 15px red;} 100%{transform:scale(1);} }

        /* PERFIL */
        .profile-wrapper { position: relative; }
        .profile-menu {
            position: absolute; top: 50px; right: 0; 
            background: #1a1b20; border: 1px solid #333;
            width: 260px; border-radius: 8px; display: none; flex-direction: column;
            box-shadow: 0 4px 25px black; overflow: hidden; z-index: 100;
        }
        .profile-menu.show { display: flex; animation: slideDown 0.2s; }
        @keyframes slideDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
        
        .profile-header {
            background: linear-gradient(135deg, #2a2d35, #151619);
            padding: 15px; border-bottom: 1px solid #333;
            text-align: center;
        }
        .user-avatar {
            width: 60px; height: 60px; background: var(--cr-orange); border-radius: 50%;
            margin: 0 auto 10px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: #000; font-weight: bold; border: 2px solid white;
        }
        .user-name { font-weight: bold; font-size: 1rem; margin-bottom: 5px; color: white; }
        
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px;
            background: #111;
        }
        .stat-box {
            background: #23252b; padding: 8px; border-radius: 4px; text-align: center;
        }
        .stat-val { font-size: 0.9rem; font-weight: bold; color: var(--cr-orange); }
        .stat-label { font-size: 0.65rem; color: #888; text-transform: uppercase; margin-top: 2px;}
        
        .last-seen-box {
            padding: 10px; border-top: 1px solid #222; background: #1a1b20;
            font-size: 0.8rem; color: #ccc;
        }
        .last-seen-title { color: white; font-weight: bold; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .menu-opt {
            padding: 12px 15px; display: flex; align-items: center; gap: 10px;
            font-size: 0.9rem; color: #ccc; cursor: pointer; border-top: 1px solid #333;
            background: #23252b;
        }
        .menu-opt:active { background: #333; color: red; }

        /* HERO & LISTS */
        .hero-section {
            width: 100%; height: 50vh; max-height: 480px;
            position: relative;
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; mask-image: linear-gradient(to bottom, black 80%, transparent 100%); }
        .hero-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(0deg, var(--cr-bg) 0%, rgba(0,0,0,0.3) 50%, rgba(0,0,0,0.6) 100%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 20px;
        }

        .btn-cr {
            background: var(--cr-orange); color: black; border: none;
            padding: 10px 24px; font-weight: 700; text-transform: uppercase;
            font-size: 0.9rem; letter-spacing: 0.5px; cursor: pointer;
            width: fit-content; display: flex; align-items: center; gap: 8px;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: transform 0.1s;
        }
        .btn-cr:active { transform: scale(0.96); filter: brightness(0.9); }

        .shelf { padding: 20px 0 5px 0; }
        .shelf-title { 
            font-size: 1.1rem; font-weight: 600; color: var(--cr-text); 
            padding: 0 15px; margin-bottom: 12px; border-left: 4px solid var(--cr-orange);
            display: flex; align-items: center;
        }
        .shelf-scroll { 
            display: flex; overflow-x: auto; gap: 12px; padding: 0 15px; 
            scroll-snap-type: x mandatory; 
        }

        /* CONFIGURACIÓN DE GRILLA (CATÁLOGO GENERAL) */
        .catalog-grid {
    display: grid !important;
    grid-template-columns: repeat(3, 1fr) !important; /* 3 columnas iguales para todo */
    gap: 12px; 
    padding: 15px;
    align-content: start;
}
        
        /* CONFIGURACIÓN DE GRILLA (MODO DENSO - SERIES Y PELICULAS 3 COLUMNAS) */
        .catalog-grid.dense-grid {
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 10px !important;
        }
        
        @media(min-width: 600px) {
        .catalog-grid { 
        grid-template-columns: repeat(3, 1fr) !important; /* 5 columnas en PC/Tablet */
    }            .catalog-grid.dense-grid { grid-template-columns: repeat(3, 1fr) !important; }
        }

.media-card {
    flex: 0 0 120px; /* Tamaño en el scroll horizontal */
    width: 100%; 
    cursor: pointer; 
    position: relative;
    scroll-snap-align: start;
    aspect-ratio: 2 / 3 !important; /* Proporción vertical fija */
    overflow: hidden;
    border-radius: 6px;
    background: var(--cr-bg-card);
    border: 1px solid #333;
}


        
        @media(min-width: 600px) { .media-card { flex: 0 0 160px; } }

   
   .media-card img { 
    width: 100%; 
    height: 100%; 
    object-fit: cover; /* Esto estira la imagen para llenar el póster */
    opacity: 0; 
    transition: opacity 0.4s ease-in; 
}
        .media-card img.loaded { opacity: 1; }

        .card-info-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 50%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 8px;
        }
        .card-title-text {
            font-size: 0.75rem; font-weight: 500; color: white;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .badge-ep {
            position: absolute; top: 5px; right: 5px; background: var(--cr-orange); color: black;
            padding: 2px 5px; font-weight: 900; border-radius: 2px; font-size: 0.6rem;
        }
        .live-badge {
            position: absolute; top: 5px; right: 5px; background: red; color: white;
            padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 0.6rem;
        }
        
        .card-prog-bg { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(255,255,255,0.3); }
        .card-prog-fill { height: 100%; background: var(--cr-orange); }

        .search-area { padding: 70px 15px 10px; }
        #searchInput {
            width: 100%; background: var(--cr-bg-card); border: 1px solid #444;
            color: white; padding: 12px; font-size: 1rem; outline: none;
            clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);
        }
        #searchInput:focus { border-color: var(--cr-orange); }

        .detail-hero { height: 35vh; position: relative; }
        .detail-hero img { width: 100%; height: 100%; object-fit: cover; opacity: 0.5; }
        .detail-content { padding: 15px; position: relative; top: -40px; }
        
        .poster-float {
            width: 110px; aspect-ratio: 2/3; background: #333; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.8); object-fit: cover; border: 1px solid #444;
        }
        
        .action-row { display: flex; gap: 15px; margin-top: 20px; }
        .btn-fav {
            width: 45px; height: 45px; background: var(--cr-bg-card); 
            border: 1px solid #444; color: white; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            clip-path: polygon(8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%, 0 8px);
        }
        .btn-fav.active { color: var(--cr-orange); border-color: var(--cr-orange); }

        .episode-row {
            display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid #222;
            align-items: center; cursor: pointer; background: rgba(255,255,255,0.02);
        }
        .episode-row:active { background: rgba(255,255,255,0.1); }
        .ep-thumb { width: 110px; height: 62px; object-fit: cover; background: #111; position: relative; }
        .ep-seen { color: var(--cr-orange); font-size: 0.8rem; margin-left: auto; }
        
        .ep-prog-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: rgba(0,0,0,0.5); }
        .ep-prog-val { height: 100%; background: var(--cr-orange); width: 0%; }

        #videoOverlay {
            position: fixed; inset: 0; background: black; z-index: 9999;
            display: none; flex-direction: column; justify-content: center;
        }

        video { 
            width: 100%; height: 100%; background: black; 
            object-fit: fill; 
            opacity: 0; transition: opacity 0.5s; 
        }
        video.ready { opacity: 1; }
        
        #videoControls {
            position: absolute; inset: 0; 
            background: linear-gradient(0deg, rgba(0,0,0,0.95) 0%, transparent 40%);
            display: flex; flex-direction: column; justify-content: flex-end;
            padding: 20px; transition: opacity 0.3s;
        }
        #videoControls.hidden { opacity: 0; pointer-events: none; }

        .progress-area {
            width: 100%; height: 20px; cursor: pointer; display: flex; align-items: center;
            margin-bottom: 5px;
        }
        .progress-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.3); position: relative; }
        .progress-fill { height: 100%; background: var(--cr-orange); width: 0%; position: absolute; left: 0; }
        .progress-thumb {
            width: 14px; height: 14px; background: var(--cr-orange); border-radius: 50%;
            position: absolute; top: 50%; transform: translate(50%, -50%); right: -7px;
        }

        .ctrl-btn { background: none; border: none; color: white; font-size: 1.4rem; padding: 10px; cursor: pointer; }
        .center-play { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-size: 4rem; opacity: 0.8; color: white;
        }

        .skip-next-btn {
            position: absolute; bottom: 80px; right: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            color: white; border: 1px solid rgba(255,255,255,0.4);
            padding: 8px 16px; border-radius: 4px;
            font-weight: bold; cursor: pointer; font-size: 0.9rem;
            display: none; align-items: center; gap: 8px;
            z-index: 10002;
            transition: background 0.2s;
        }
        .skip-next-btn:active { background: rgba(244, 117, 33, 0.8); border-color: var(--cr-orange); }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: var(--nav-height); background: #151619;
            border-top: 1px solid #333; display: flex;
            justify-content: space-around; align-items: center; z-index: 100;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: #777; font-size: 0.7rem; flex: 1; padding: 8px 0; cursor: pointer;
        }
        .nav-item i { font-size: 1.2rem; }
        .nav-item.active { color: var(--cr-orange); }

    </style>
</head>

<div id="filterBtn" style="position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px; background: #f47521; border-radius: 50%; display: none; align-items: center; justify-content: center; color: black; font-size: 1.3rem; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; cursor: pointer;" onclick="toggleFilterMenu()">
    <i class="fas fa-filter"></i>
</div>

<div id="filterMenu" style="position: fixed; bottom: 145px; right: 20px; background: #23252b; border: 1px solid #444; border-radius: 12px; width: 200px; max-height: 350px; overflow-y: auto; display: none; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.8); z-index: 1001; padding: 5px;">
    <div id="genreList"></div>
</div>

<body>

    <div class="app-header">
        <div class="logo-text"></div>
        <div style="display:flex; align-items:center; gap:5px;">
            <div id="headerEventArea"></div>
            
            <i class="fas fa-search" style="color:white; font-size:1.2rem; padding:10px;" onclick="navTo('search')"></i>
            <div class="profile-wrapper">
                <i class="fas fa-user-circle" style="color:white; font-size:1.6rem; padding:5px;" onclick="toggleProfile()"></i>
                <div id="profileMenu" class="profile-menu">
                    <div class="profile-header">
                        <div class="user-avatar">V</div>
                        <div class="user-name">Usuario Vortex</div>
                        <div style="font-size:0.75rem; color:#888;">Miembro Gratis</div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div id="statTime" class="stat-val">0h 0m</div>
                            <div class="stat-label">Tiempo Total</div>
                        </div>
                        <div class="stat-box">
                            <div id="statCompleted" class="stat-val">0</div>
                            <div class="stat-label">Completados</div>
                        </div>
                    </div>

                    <div class="last-seen-box">
                        <span style="color:#777; font-size:0.7rem;">Último visto:</span>
                        <span id="statLastTitle" class="last-seen-title">-</span>
                    </div>

                    <div class="menu-opt" onclick="clearFavs()"><i class="fas fa-trash"></i> Borrar Historial/Favs</div>
                </div>
            </div>
        </div>
    </div>

    <main>
        <div id="view-home" class="view-container active">
            <div id="hero-container"></div>
            <div id="home-content"></div>
        </div>

        <div id="view-catalog" class="view-container">
            <h2 class="shelf-title" style="margin-top:70px;" id="catalogTitle">CATÁLOGO</h2>
            <div id="grid-container" class="catalog-grid"></div>
            <div id="infiniteLoader" style="text-align:center; padding:20px; color:var(--cr-orange); display:none;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
            </div>
        </div>

        <div id="view-search" class="view-container">
            <div class="search-area">
                <input type="text" id="searchInput" placeholder="Buscar animes, películas...">
            </div>
            <div id="search-grid" class="catalog-grid"></div>
        </div>

        <div id="view-detail" class="view-container" style="background: #111;">
            <div id="detail-content-area"></div>
        </div>
    </main>

    <div id="videoOverlay">
        <div id="fakeLoader" style="position:absolute; top:0; left:0; right:0; bottom:0; background:black; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2;">
            <div style="color:var(--cr-orange); margin-bottom:15px; font-size:3rem;"><i class="fas fa-play-circle fa-beat"></i></div>
            <div style="color:white; font-weight:bold; letter-spacing:1px;">CARGANDO VIDEO...</div>
            <div style="width:150px; height:4px; background:#333; margin-top:15px; border-radius:2px; overflow:hidden;">
                <div style="width:100%; height:100%; background:var(--cr-orange); animation: loadBar 1.5s infinite;"></div>
            </div>
            <style>@keyframes loadBar { 0%{transform:translateX(-100%)} 100%{transform:translateX(100%)} }</style>
        </div>
        
        <div id="bufferLoader" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--cr-orange); font-size:3rem; display:none; z-index:1;">
            <i class="fas fa-circle-notch fa-spin"></i>
        </div>
        
        <video id="player" playsinline></video>
        
        <button id="skipBtn" class="skip-next-btn" onclick="nextEpPlayer()">
            Siguiente <i class="fas fa-step-forward"></i>
        </button>

        <div id="videoControls">
            <div style="position:absolute; top:20px; left:20px; display:flex; align-items:center; gap:10px;">
                <button class="ctrl-btn" onclick="closePlayerManually()"><i class="fas fa-arrow-left"></i></button>
                <span id="playerTitle" style="color:white; font-weight:bold; width:200px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Titulo</span>
            </div>

            <div class="center-play" onclick="togglePlay()">
                <i class="fas fa-pause" id="centerIcon"></i>
            </div>

            <div class="progress-area" id="scrubber">
                <div class="progress-bg">
                    <div class="progress-fill" id="progFill">
                        <div class="progress-thumb"></div>
                    </div>
                </div>
            </div>

            <div class="ctrl-row" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <button class="ctrl-btn" onclick="togglePlay()"><i class="fas fa-pause" id="bottomIcon"></i></button>
                    <span id="timeDisplay" style="color:white; font-size:0.8rem;">00:00 / 00:00</span>
                </div>
                <div>
                    <button id="nextEpBtn" class="ctrl-btn" onclick="nextEpPlayer()" style="display:none;"><i class="fas fa-step-forward"></i></button>
                    <button class="ctrl-btn" onclick="toggleFull()"><i class="fas fa-expand"></i></button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="navTo('home')"><i class="fas fa-home"></i>Inicio</div>
        <div class="nav-item" onclick="navTo('live')"><i class="fas fa-tv"></i>En Vivo</div>
        <div class="nav-item" onclick="navTo('movies')"><i class="fas fa-film"></i>Películas</div>
        <div class="nav-item" onclick="navTo('series')"><i class="fas fa-layer-group"></i>Series</div>
        <div class="nav-item" onclick="navTo('favorites')"><i class="fas fa-heart"></i>Favs</div>
    </nav>

    <div id="resumeModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:10000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
        <div style="background:#23252b; padding:25px; border:1px solid #444; width:85%; max-width:300px; text-align:center;">
            <h3 style="color:var(--cr-orange); margin-bottom:15px;">¿Continuar viendo?</h3>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:20px;">Lo dejaste en <span id="resumeTimeStr" style="color:white; font-weight:bold;"></span></p>
            <button onclick="confirmResume(true)" class="btn-cr" style="width:100%; justify-content:center; margin-bottom:10px;">Continuar</button>
            <button onclick="confirmResume(false)" class="btn-cr" style="width:100%; justify-content:center; background:#444; color:white;">Empezar de cero</button>
        </div>
    </div>

    
    <script>
        
const URLS = {
    json: "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json",
    m3u8: "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8",
    fallbackImg: "https://via.placeholder.com/200x300/111/444?text=Vortex"
};

let DATA = {
    all: [], series: [], movies: [], channels: [],
    action: [], romance: [], suspense: [],
    premiere: [], anime: [], superheroes: [], kids: [], horror: [],
    eventChannel: null
};

let STATE = {
    list: [], page: 0,
    isLoading: false,
    favs: JSON.parse(localStorage.getItem('favs') || '[]'),
    hist: JSON.parse(localStorage.getItem('hist') || '{}')
};

let PLAYER = { active: false, item: null, epIdx: -1, interval: null, tempResume: null, fakeLoading: false, controlsTimeout: null };

const hlsConfig = {
    enableWorker: true,
    lowLatencyMode: true,
    backBufferLength: 60
};

const els = {
    grid: document.getElementById('grid-container'),
    loader: document.getElementById('infiniteLoader'),
    video: document.getElementById('player'),
    overlay: document.getElementById('videoOverlay'),
    pMenu: document.getElementById('profileMenu'),
    skipBtn: document.getElementById('skipBtn'),
    fakeLoader: document.getElementById('fakeLoader'),
    headerEvent: document.getElementById('headerEventArea'),
    controls: document.getElementById('videoControls') // Referencia añadida
};

async function init() {
    try {
        console.log("Descargando datos actualizados...");
        const d = await fetch(URLS.json + "?t=" + Date.now()).then(r => r.json());
        const m = await fetch(URLS.m3u8 + "?t=" + Date.now()).then(r => r.text());

        localStorage.removeItem('vortex_data_cache');
        localStorage.removeItem('vortex_cache_time');

        DATA.series = d.filter(x => x.episodes?.length > 0);
        DATA.movies = d.filter(x => !x.episodes || x.episodes.length === 0);

        const checkGenre = (x, tags) => x.genre?.some(g => tags.some(t => g.toLowerCase().includes(t)));

        DATA.action = d.filter(x => checkGenre(x, ['acción', 'action']));
        DATA.romance = d.filter(x => checkGenre(x, ['romance']));
        DATA.suspense = d.filter(x => checkGenre(x, ['suspenso', 'suspense', 'thriller']));
        DATA.premiere = d.filter(x => checkGenre(x, ['estreno', 'nuevo', '2024', '2025', '2026']));
        DATA.anime = d.filter(x => checkGenre(x, ['anime', 'animación japonesa']));
        DATA.superheroes = d.filter(x => checkGenre(x, ['super', 'héroe', 'marvel', 'dc', 'hero']));
        DATA.kids = d.filter(x => checkGenre(x, ['infantil', 'niños', 'kids', 'family']));
        DATA.horror = d.filter(x => checkGenre(x, ['terror', 'miedo', 'horror']));

        parseChannels(m);
        DATA.all = [...d, ...DATA.channels];

        renderHome();
        setupPlayerGestures(); // Iniciamos los gestos aquí
    } catch (e) { console.error(e); }
}

function parseChannels(txt) {
    if (txt.trim().startsWith('<')) {
        const regex = /<channel.*?name="(.*?)".*?>(.*?)<\/channel>/g;
        let match;
        while ((match = regex.exec(txt)) !== null) {
            DATA.channels.push({
                title: match[1],
                video_url: match[2],
                coverImage: URLS.fallbackImg,
                isChannel: true,
                isEvent: false
            });
        }
    } else {
        let curr = null;
        txt.split('\n').forEach(l => {
            l = l.trim();
            if (l.startsWith('#EXTINF:')) {
                const isEvent = l.toLowerCase().includes('group-title="evento"');
                curr = {
                    title: l.split(',')[1],
                    coverImage: l.match(/tvg-logo="([^"]*)"/)?.[1],
                    isChannel: true,
                    isEvent: isEvent
                };
            } else if (l.includes('://') && curr) {
                curr.video_url = l;
                if (curr.isEvent) {
                    DATA.eventChannel = curr;
                } else {
                    DATA.channels.push(curr);
                }
                curr = null;
            }
        });
    }
}

function navTo(tab) {
    if (tab !== 'search') {
        const sInput = document.getElementById('searchInput');
        const sGrid = document.getElementById('search-grid');
        if (sInput && sInput.value !== '') { sInput.value = ''; sGrid.innerHTML = ''; }
    }

    document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

    if (event && event.currentTarget && event.currentTarget.classList.contains('nav-item')) {
        event.currentTarget.classList.add('active');
    }
    els.pMenu.classList.remove('show');

    const fBtn = document.getElementById('filterBtn');
    const fMenu = document.getElementById('filterMenu');
    if (fBtn) {
        if (tab === 'movies' || tab === 'series') {
            fBtn.style.display = 'flex';
            prepareGenreFilter(tab);
        } else {
            fBtn.style.display = 'none';
            if (fMenu) fMenu.style.display = 'none';
        }
    }

    if (tab === 'home') {
        document.getElementById('view-home').classList.add('active');
        renderHome();
    } else if (tab === 'search') {
        document.getElementById('view-search').classList.add('active');
        document.getElementById('searchInput').focus();
    } else {
        const v = document.getElementById('view-catalog');
        v.classList.add('active');
        v.scrollTop = 0;

        if (tab === 'movies' || tab === 'series') els.grid.classList.add('dense-grid');
        else els.grid.classList.remove('dense-grid');

        STATE.page = 0;
        STATE.isLoading = false;
        els.grid.innerHTML = '';
        document.getElementById('catalogTitle').innerText = tab === 'favorites' ? 'FAVORITOS' : tab.toUpperCase();

        if (tab === 'series') STATE.list = DATA.series;
        else if (tab === 'live') STATE.list = DATA.channels;
        else if (tab === 'movies') STATE.list = DATA.movies;
        else if (tab === 'favorites') STATE.list = DATA.all.filter(x => STATE.favs.includes(x.title));

        loadMore();
    }
}

function renderHome() {
    const c = document.getElementById('home-content');
    const h = document.getElementById('hero-container');

    if (!h.innerHTML) {
        if (DATA.series.length) {
            const item = DATA.series[Math.floor(Math.random() * DATA.series.length)];
            const img = item.coverImage || URLS.fallbackImg;
            h.innerHTML = `
                <div class="hero-section">
                    <img class="hero-img" src="${img}" onerror="this.src='${URLS.fallbackImg}'">
                    <div class="hero-overlay">
                        <h1 style="font-size:2rem; font-weight:900; line-height:1; margin-bottom:5px; text-shadow:0 2px 5px black;">${item.title}</h1>
                        <p style="color:#ccc; margin-bottom:15px; font-size:0.9rem;">${item.genre?.join(' • ') || 'Anime'}</p>
                        <button class="btn-cr" onclick='openDetail(DATA.all.find(x=>x.title=="${item.title}"))'>
                            <i class="fas fa-play"></i> VER AHORA
                        </button>
                    </div>
                </div>
            `;
        }
    }
    c.innerHTML = '';

    if (DATA.eventChannel) {
        els.headerEvent.innerHTML = `
            <div class="event-header-btn" onclick="launchPlayer('${DATA.eventChannel.video_url}', '${DATA.eventChannel.title}', false, DATA.eventChannel)">
                <i class="fas fa-broadcast-tower"></i> EVENTO
            </div>
        `;
    } else {
        els.headerEvent.innerHTML = '';
    }

    addShelf('Canales en Vivo', DATA.channels, c);

    const watching = DATA.all.filter(x => {
        if (x.isChannel) return false;
        const h = STATE.hist[x.title];
        return h && ((h.time > 0) || (h.last !== undefined));
    });

    watching.sort((a, b) => {
        const ta = STATE.hist[a.title]?.updated || 0;
        const tb = STATE.hist[b.title]?.updated || 0;
        return tb - ta;
    });

    if (watching.length) addShelf('Seguir Viendo', watching, c);

    addShelf('Estreno', DATA.premiere.slice(0, 15), c);
    addShelf('Anime', DATA.anime.slice(0, 15), c);
    addShelf('Superhéroes', DATA.superheroes.slice(0, 15), c);
    addShelf('Acción', DATA.action.slice(0, 15), c);
    addShelf('Terror', DATA.horror.slice(0, 15), c);
    addShelf('Infantil', DATA.kids.slice(0, 15), c);
    addShelf('Películas Recomendadas', DATA.movies.slice(0, 15), c);
    addShelf('Series Populares', DATA.series.slice(0, 15), c);
}

function addShelf(t, list, p) {
    if (!list.length) return;
    const d = document.createElement('div');
    d.className = 'shelf';
    d.innerHTML = `<div class="shelf-title">${t}</div><div class="shelf-scroll"></div>`;
    const s = d.querySelector('.shelf-scroll');
    list.forEach(i => s.appendChild(createCard(i)));
    p.appendChild(d);
}

function createCard(item, grid = false) {
    const d = document.createElement('div');
    d.className = grid ? 'media-card card-animate' : 'media-card';
    if (grid) d.style.width = '100%';

    const imgUrl = item.coverImage || item.logo || URLS.fallbackImg;
    const hist = STATE.hist[item.title];

    let pct = 0;
    if (!item.isChannel && hist) {
        if (item.episodes && hist.last !== undefined) {
            const lastEp = hist.eps?.[hist.last];
            if (lastEp) pct = (lastEp.time / lastEp.dur) * 100;
        } else if (!item.episodes) {
            pct = (hist.time / hist.dur) * 100;
        }
    }

    d.innerHTML = `
        <img src="${imgUrl}" loading="lazy" 
             onload="this.classList.add('loaded')" 
             onerror="this.src='${URLS.fallbackImg}'; this.classList.add('loaded');">
             
        <div class="card-info-overlay">
            <div class="card-title-text">${item.title}</div>
        </div>
        ${item.episodes ? `<div class="badge-ep">${item.episodes.length} EP</div>` : ''}
        ${item.isChannel ? `<div class="live-badge">LIVE</div>` : ''}
        ${pct > 0 && pct < 95 ? `<div class="card-prog-bg"><div class="card-prog-fill" style="width:${pct}%"></div></div>` : ''}
        ${pct > 95 ? `<div class="live-badge" style="background:#4caf50; left:5px; right:auto;">VISTO</div>` : ''}
    `;
    d.onclick = () => openDetail(item);
    return d;
}

function loadMore() {
    if (STATE.isLoading) return;
    const chunk = STATE.list.slice(STATE.page, STATE.page + 20);
    if (!chunk.length) { els.loader.style.display = 'none'; return; }

    STATE.isLoading = true;
    els.loader.style.display = 'block';

    setTimeout(() => {
        chunk.forEach((i, idx) => {
            const card = createCard(i, true);
            card.style.animationDelay = `${idx * 50}ms`;
            els.grid.appendChild(card);
        });
        STATE.page += 30;
        STATE.isLoading = false;
        els.loader.style.display = 'none';
    }, 400);
}

document.getElementById('view-catalog').onscroll = (e) => {
    if (e.target.scrollTop + e.target.clientHeight >= e.target.scrollHeight - 150) loadMore();
};

function openDetail(item) {
    const fBtn = document.getElementById('filterBtn');
    if (fBtn) fBtn.style.display = 'none';

    document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
    const detailView = document.getElementById('view-detail');
    detailView.classList.add('active');

    detailView.scrollTop = 0;

    const bg = item.coverImage || item.logo || URLS.fallbackImg;
    const isFav = STATE.favs.includes(item.title);
    const c = document.getElementById('detail-content-area');

    let html = `
        <div class="detail-hero"><img src="${bg}" onerror="this.src='${URLS.fallbackImg}'"></div>
        <div class="detail-content">
            <div style="display:flex; gap:15px; align-items:flex-end;">
                <img src="${bg}" class="poster-float" onerror="this.src='${URLS.fallbackImg}'">
                <div style="flex:1;">
                    <h1 style="font-size:1.4rem; color:var(--cr-orange); margin-bottom:5px; line-height:1.1;">${item.title}</h1>
                    <div style="color:#aaa; font-size:0.8rem;">${item.genre?.join(' | ') || 'Contenido'}</div>
                </div>
            </div>
            <div class="action-row">
                <button class="btn-cr" style="flex:1; justify-content:center;" onclick="playMain('${item.title}')">
                    <i class="fas fa-play"></i> REPRODUCIR
                </button>
                <button class="btn-fav ${isFav ? 'active' : ''}" onclick="toggleFav('${item.title}', this)">
                    <i class="${isFav ? 'fas' : 'far'} fa-heart"></i>
                </button>
            </div>
            <p style="margin-top:20px; color:#ccc; line-height:1.5; font-size:0.9rem;">${item.description || 'Sin descripción.'}</p>
    `;

    if (item.episodes) {
        html += `<div style="margin-top:30px; border-bottom:1px solid #333; padding-bottom:10px; font-weight:bold; color:white;">EPISODIOS</div><div>`;
        item.episodes.forEach((ep, i) => {
            const h = STATE.hist[item.title]?.eps?.[i];
            const pct = h ? (h.time / h.dur) * 100 : 0;
            const thumb = ep.thumb || bg;
            html += `
                <div class="episode-row" onclick="checkPlay('${item.title}', ${i})">
                    <div class="ep-thumb">
                        <img src="${thumb}" style="width:100%; height:100%; object-fit:cover;" onerror="this.src='${URLS.fallbackImg}'">
                        ${pct > 0 ? `<div class="ep-prog-bar"><div class="ep-prog-val" style="width:${pct}%"></div></div>` : ''}
                    </div>
                    <div style="flex:1;">
                        <h4 style="font-size:0.9rem; color:${pct > 90 ? '#777' : 'white'}; margin-bottom:4px;">Capítulo ${i + 1}</h4>
                        <span style="font-size:0.75rem; color:#777;">${item.title}</span>
                    </div>
                    ${pct > 90 ? `<i class="fas fa-check-circle ep-seen"></i>` : ''}
                </div>
            `;
        });
        html += '</div>';
    }
    c.innerHTML = html + '</div>';
}

function playMain(title) {
    const item = DATA.all.find(x => x.title === title);
    if (item.isChannel) launchPlayer(item.video_url, item.title, false, item);
    else if (item.episodes) {
        const idx = STATE.hist[title]?.last || 0;
        checkPlay(title, idx);
    } else {
        checkPlay(title, -1);
    }
}

function checkPlay(title, idx) {
    const item = DATA.all.find(x => x.title === title);
    const url = idx === -1 ? item.video_url : item.episodes[idx].video_url;
    let time = (idx === -1) ? (STATE.hist[title]?.time || 0) : (STATE.hist[title]?.eps?.[idx]?.time || 0);
    let dur = (idx === -1) ? (STATE.hist[title]?.dur || 0) : (STATE.hist[title]?.eps?.[idx]?.dur || 0);

    if (time > 30 && time < dur * 0.95) {
        PLAYER.tempResume = { url, title, idx, time, item };
        document.getElementById('resumeTimeStr').innerText = Math.floor(time / 60) + " min";
        document.getElementById('resumeModal').style.display = 'flex';
    } else {
        launchPlayer(url, title, idx, item);
    }
}

function confirmResume(yes) {
    document.getElementById('resumeModal').style.display = 'none';
    const { url, title, idx, time, item } = PLAYER.tempResume;
    launchPlayer(url, title, idx, item, yes ? time : 0);
}

// --- LOGICA DEL REPRODUCTOR MEJORADA (ESTILO YOUTUBE) ---

function launchPlayer(url, title, idx, item, startTime = 0) {
    history.pushState({ player: true }, null, "");

    PLAYER.active = true; PLAYER.item = item; PLAYER.epIdx = idx;

    // Estado inicial visual
    PLAYER.fakeLoading = true;
    els.video.classList.remove('ready');
    els.fakeLoader.style.display = 'flex';
    els.controls.classList.add('hidden'); // Empezar oculto hasta que cargue
    els.overlay.style.display = 'flex';
    document.getElementById('bufferLoader').style.display = 'none';
    els.skipBtn.style.display = 'none';

    // Ocultar botón fullscreen si existe (Petición del usuario)
    const fsBtn = document.querySelector('button[onclick="toggleFull()"]');
    if(fsBtn) fsBtn.style.display = 'none';
    // Ocultar cualquier icono que use fa-expand
    const fsIcons = document.querySelectorAll('.fa-expand');
    fsIcons.forEach(ic => ic.parentElement.style.display = 'none');

    let tStr = title; if (idx !== false && idx > -1) tStr += ` - E${idx + 1}`;
    document.getElementById('playerTitle').innerText = tStr;

    document.getElementById('nextEpBtn').style.display = 'none';
    updatePlayPauseIcons(false); // Icono de pausa por defecto

    if (Hls.isSupported() && (url.includes('.m3u8') || url.includes('.ts'))) {
        if (window.hls) window.hls.destroy();
        window.hls = new Hls(hlsConfig);
        window.hls.loadSource(url);
        window.hls.attachMedia(els.video);
        window.hls.on(Hls.Events.MANIFEST_PARSED, () => startVid(startTime));
        window.hls.on(Hls.Events.ERROR, (e, data) => {
            if (data.fatal) {
                console.warn("HLS falló, intentando nativo...");
                window.hls.destroy();
                els.video.src = url;
                startVid(startTime);
            }
        });
    } else {
        if (window.hls) { window.hls.destroy(); window.hls = null; }
        els.video.src = url;
        startVid(startTime);
    }

    clearInterval(PLAYER.interval);
    PLAYER.interval = setInterval(saveProgress, 3000);

    if (els.overlay.requestFullscreen) els.overlay.requestFullscreen().catch(e => { });
    else if (els.overlay.webkitRequestFullscreen) els.overlay.webkitRequestFullscreen();
}

function startVid(t) {
    els.video.currentTime = t;
    const playPromise = els.video.play();

    if (playPromise !== undefined) {
        playPromise.then(_ => {
            updatePlayPauseIcons(true);
        }).catch(error => {
            console.error("Error al reproducir:", error);
            updatePlayPauseIcons(false);
        });
    }

    els.video.onplaying = () => {
        document.getElementById('bufferLoader').style.display = 'none';
        updatePlayPauseIcons(true);
    };
    els.video.onpause = () => updatePlayPauseIcons(false);
    els.video.onwaiting = () => {
        if (!PLAYER.fakeLoading) document.getElementById('bufferLoader').style.display = 'block';
    };
}

// Nueva función unificada para actualizar iconos
function updatePlayPauseIcons(isPlaying) {
    const cls = isPlaying ? "fas fa-pause" : "fas fa-play";
    if(document.getElementById('centerIcon')) document.getElementById('centerIcon').className = cls;
    if(document.getElementById('bottomIcon')) document.getElementById('bottomIcon').className = cls;
}

function saveProgress() {
    if (!PLAYER.active || PLAYER.item?.isChannel || els.video.paused) return;
    const t = els.video.currentTime, d = els.video.duration, title = PLAYER.item.title;
    const now = Date.now();

    if (!STATE.hist[title]) STATE.hist[title] = {};
    STATE.hist[title].updated = now;

    if (PLAYER.epIdx > -1) {
        if (!STATE.hist[title].eps) STATE.hist[title].eps = {};
        STATE.hist[title].eps[PLAYER.epIdx] = { time: t, dur: d };
        STATE.hist[title].last = PLAYER.epIdx;
    } else {
        STATE.hist[title].time = t; STATE.hist[title].dur = d;
    }
    localStorage.setItem('hist', JSON.stringify(STATE.hist));
}

function closePlayer() {
    if (!PLAYER.active) return;
    saveProgress();
    els.video.pause();
    els.video.removeAttribute('src');
    els.video.load();
    if (window.hls) { window.hls.destroy(); window.hls = null; }

    clearInterval(PLAYER.interval);
    els.overlay.style.display = 'none';
    PLAYER.active = false;
    if (document.fullscreenElement) document.exitFullscreen().catch(e => { });
}

function closePlayerManually() { history.back(); }

window.onpopstate = (event) => { if (PLAYER.active) closePlayer(); };

document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement && PLAYER.active) history.back(); });
document.addEventListener('webkitfullscreenchange', () => { if (!document.webkitFullscreenElement && PLAYER.active) history.back(); });

function togglePlay() {
    if (els.video.paused) {
        els.video.play();
        activateAutoHide(); // Si damos play, activamos el auto-ocultar
    } else {
        els.video.pause();
        showControls(); // Si pausamos, mostramos controles y NO se ocultan
    }
}

function nextEpPlayer() {
    if (PLAYER.item?.episodes && PLAYER.epIdx + 1 < PLAYER.item.episodes.length) {
        checkPlay(PLAYER.item.title, PLAYER.epIdx + 1);
    } else {
        closePlayerManually();
    }
}

els.video.onended = () => { saveProgress(); nextEpPlayer(); };

els.video.ontimeupdate = () => {
    if (!els.video.duration) return;

    const cur = els.video.currentTime;

    if (PLAYER.fakeLoading && cur > 0.5) {
        PLAYER.fakeLoading = false;
        els.fakeLoader.style.display = 'none';
        els.video.classList.add('ready');
        showControls(); // Mostrar controles al iniciar video real
        activateAutoHide(); // Iniciar timer de ocultar
    }

    const dur = els.video.duration;
    const p = (cur / dur) * 100 || 0;

    document.getElementById('progFill').style.width = p + '%';
    document.getElementById('timeDisplay').innerText = fmt(cur) + " / " + fmt(dur);

    const remain = dur - cur;
    if (remain <= 6 && remain > 0 && PLAYER.item?.episodes && (PLAYER.epIdx + 1 < PLAYER.item.episodes.length)) {
        els.skipBtn.style.display = 'flex';
        els.skipBtn.innerHTML = `Siguiente en ${Math.ceil(remain)}s <i class="fas fa-step-forward"></i>`;
    } else {
        els.skipBtn.style.display = 'none';
    }
};

document.getElementById('scrubber').onclick = (e) => {
    const r = e.currentTarget.getBoundingClientRect();
    els.video.currentTime = ((e.clientX - r.left) / r.width) * els.video.duration;
};

// Se mantiene toggleFull pero se oculta el botón visualmente
function toggleFull() { document.fullscreenElement ? document.exitFullscreen() : els.overlay.requestFullscreen(); }

// --- GESTIÓN DE CONTROLES E INTERFAZ (CORE YOUTUBE LOGIC) ---

function showControls() {
    els.controls.classList.remove('hidden');
    clearTimeout(PLAYER.controlsTimeout);
}

function hideControls() {
    // Solo ocultamos si NO está pausado. En YouTube si está pausado los controles se quedan.
    if (!els.video.paused) {
        els.controls.classList.add('hidden');
    }
}

function activateAutoHide() {
    clearTimeout(PLAYER.controlsTimeout);
    if (!els.video.paused) {
        PLAYER.controlsTimeout = setTimeout(() => {
            hideControls();
        }, 3000); // 3 Segundos para ocultar
    }
}

function setupPlayerGestures() {
    let lastTap = 0;
    let tapTimeout;

    // Usamos 'click' en el overlay general para manejar la lógica de mostrar/ocultar
    // y detectamos doble click manualmente con timestamps para mayor control.
    els.overlay.addEventListener('click', (e) => {
        // Ignorar si se hace click en controles interactivos
        if (e.target.closest('.ctrl-btn') || 
            e.target.closest('.progress-area') || 
            e.target.closest('.skip-next-btn') ||
            e.target.closest('.event-header-btn')) {
            activateAutoHide(); // Reiniciar timer si se toca un control
            return;
        }

        const now = Date.now();
        const timeDiff = now - lastTap;
        
        if (timeDiff < 300 && timeDiff > 0) {
            // --- DOBLE TOQUE DETECTADO ---
            clearTimeout(tapTimeout); // Cancelar el toggle del toque simple
            
            const rect = els.overlay.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            // Decidir lado (Izquierda: Retroceder, Derecha: Avanzar)
            if (x < rect.width / 2) {
                seekVideo(-10);
            } else {
                seekVideo(10);
            }
            
            // Al hacer doble toque, mostramos controles momentáneamente
            showControls();
            activateAutoHide();

        } else {
            // --- POSIBLE TOQUE SIMPLE ---
            // Esperamos 300ms para asegurar que no viene un segundo toque
            tapTimeout = setTimeout(() => {
                toggleControlsUI();
            }, 300);
        }
        
        lastTap = now;
    });

    // Soporte táctil mejorado para botones (evita el delay de 300ms del navegador)
    document.querySelectorAll('.ctrl-btn').forEach(btn => {
        btn.addEventListener('touchend', (e) => {
            e.preventDefault(); // Evitar doble disparo
            btn.click();
        });
    });
}

function toggleControlsUI() {
    if (els.controls.classList.contains('hidden')) {
        showControls();
        activateAutoHide();
    } else {
        // Si están visibles, forzamos ocultar (incluso si está pausado, el usuario quiere ver la imagen limpia)
        els.controls.classList.add('hidden');
        clearTimeout(PLAYER.controlsTimeout);
    }
}

function seekVideo(seconds) {
    els.video.currentTime = Math.max(0, Math.min(els.video.duration, els.video.currentTime + seconds));
    
    // Animación visual (Icono flash)
    const iconClass = seconds > 0 ? "fas fa-forward" : "fas fa-backward";
    const side = seconds > 0 ? "right: 25%" : "left: 25%";
    
    let icon = document.createElement('div');
    icon.innerHTML = `<i class="${iconClass}"></i><br><span style="font-size:0.8rem; font-weight:bold;">10s</span>`;
    // CSS Inline para la animación
    icon.style.cssText = `
        position: absolute; top: 50%; ${side}; transform: translateY(-50%);
        font-size: 2rem; color: white; background: rgba(0,0,0,0.4);
        padding: 20px; border-radius: 50%; z-index: 200; pointer-events: none;
        display: flex; flex-direction: column; align-items: center;
        animation: fadeOut 0.6s forwards;
    `;
    
    // Keyframe para fadeOut si no existe en CSS
    if(!document.getElementById('animStyles')) {
        const style = document.createElement('style');
        style.id = 'animStyles';
        style.innerHTML = `@keyframes fadeOut { 0% { opacity: 1; transform: translateY(-50%) scale(0.8); } 50% { transform: translateY(-50%) scale(1.1); } 100% { opacity: 0; transform: translateY(-50%) scale(1); } }`;
        document.head.appendChild(style);
    }
    
    els.overlay.appendChild(icon);
    setTimeout(() => icon.remove(), 600);
}

// --- FIN LOGICA REPRODUCTOR ---

function toggleProfile() {
    const m = els.pMenu;
    if (m.classList.contains('show')) {
        m.classList.remove('show');
    } else {
        updateProfileStats();
        m.classList.add('show');
    }
}

function updateProfileStats() {
    let totalSecs = 0;
    let finishedCount = 0;
    let lastSeen = { title: "Nada aún", time: 0 };

    Object.entries(STATE.hist).forEach(([k, v]) => {
        if (v.updated && v.updated > lastSeen.time) {
            lastSeen = { title: k, time: v.updated };
        }

        if (v.eps) {
            Object.values(v.eps).forEach(ep => {
                totalSecs += ep.time || 0;
                if (ep.dur && (ep.time / ep.dur) > 0.9) finishedCount++;
            });
        } else {
            totalSecs += v.time || 0;
            if (v.dur && (v.time / v.dur) > 0.9) finishedCount++;
        }
    });

    const hours = Math.floor(totalSecs / 3600);
    const mins = Math.floor((totalSecs % 3600) / 60);

    document.getElementById('statTime').innerText = `${hours}h ${mins}m`;
    document.getElementById('statCompleted').innerText = finishedCount;
    document.getElementById('statLastTitle').innerText = lastSeen.title;
}

function clearFavs() {
    if (confirm('¿Borrar historial y favoritos?')) {
        STATE.favs = [];
        STATE.hist = {};
        localStorage.setItem('favs', '[]');
        localStorage.setItem('hist', '{}');
        navTo('home');
    }
}

document.getElementById('searchInput').oninput = (e) => {
    const v = e.target.value.toLowerCase(), g = document.getElementById('search-grid');
    g.innerHTML = '';
    if (v.length > 1) {
        const r = DATA.all.filter(x => x.title.toLowerCase().includes(v));
        r.forEach(i => g.appendChild(createCard(i, true)));
    }
};

function toggleFav(t, btn) {
    if (STATE.favs.includes(t)) {
        STATE.favs = STATE.favs.filter(x => x !== t);
        btn.classList.remove('active');
        btn.querySelector('i').className = 'far fa-heart';
    } else {
        STATE.favs.push(t);
        btn.classList.add('active');
        btn.querySelector('i').className = 'fas fa-heart';
    }
    localStorage.setItem('favs', JSON.stringify(STATE.favs));
}

function fmt(s) {
    if (isNaN(s)) return "00:00";
    const m = Math.floor(s / 60), sec = Math.floor(s % 60);
    return `${m}:${sec < 10 ? '0' + sec : sec}`;
}

window.onclick = (e) => { if (!e.target.closest('.profile-wrapper')) els.pMenu.classList.remove('show'); };

function toggleFilterMenu() {
    const menu = document.getElementById('filterMenu');
    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
}

function prepareGenreFilter(type) {
    const source = type === 'series' ? DATA.series : DATA.movies;
    const genres = new Set();
    
    source.forEach(item => {
        if(item.genre) item.genre.forEach(g => genres.add(g));
    });

    const listDiv = document.getElementById('genreList');
    listDiv.innerHTML = '';

    const allOpt = document.createElement('div');
    allOpt.style = "padding: 10px; font-size: 0.9rem; cursor: pointer; color: var(--cr-orange); border-bottom: 1px solid #333;";
    allOpt.innerText = "⭐ Ver Todos";
    allOpt.onclick = () => { applyGenreFilter(null, type); };
    listDiv.appendChild(allOpt);

    Array.from(genres).sort().forEach(genre => {
        const opt = document.createElement('div');
        opt.style = "padding: 10px; font-size: 0.85rem; cursor: pointer; border-bottom: 1px solid #2a2a2a; color: #ccc;";
        opt.innerText = genre;
        opt.onclick = () => { applyGenreFilter(genre, type); };
        listDiv.appendChild(opt);
    });
}

function applyGenreFilter(genre, type) {
    const source = type === 'series' ? DATA.series : DATA.movies;
    
    if (genre === null) {
        STATE.list = source;
        document.getElementById('catalogTitle').innerText = type.toUpperCase();
    } else {
        STATE.list = source.filter(x => x.genre && x.genre.includes(genre));
        document.getElementById('catalogTitle').innerText = `${genre.toUpperCase()}`;
    }

    STATE.page = 0;
    els.grid.innerHTML = '';
    loadMore();
    document.getElementById('filterMenu').style.display = 'none';
    document.getElementById('view-catalog').scrollTop = 0;
}

init();



</script>
</body>
</html>
