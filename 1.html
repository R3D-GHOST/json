<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeBox+ | Streaming Premium</title>
    <meta name="theme-color" content="#0f171e">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-app-capable" content="yes">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" media="print" onload="this.media='all'">

    <style>
        /* CSS Crítico e Inmediato */
        *{ box-sizing:border-box; margin:0; padding:0; }
        :root{ 
            --bg-primary: #0f171e; --bg-card: #1a242f; --bg-darker: #000000; 
            --text: #ffffff; --muted: #aeb4c6; --accent: #00a8e1; 
            --accent-2: #4ec2e7; --shadow-dark: rgba(0, 0, 0, 0.9); 
            --shadow-accent: rgba(0, 168, 225, 0.5); --nav-height: 60px; 
            --watched-color: #3b4d61; 
        } 
        body, html{ 
            font-family:'Inter', sans-serif; background:var(--bg-primary); 
            color:var(--text); height: 100%; width: 100%; overflow: hidden; 
            scroll-behavior:smooth; line-height:1.45; 
        } 
        main{ position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden; } 
        #mainView, #searchView, #detailView { 
            height: 100%; width: 100%; overflow-y: auto; overflow-x: hidden; 
            position: relative; padding-bottom: calc(var(--nav-height) + 20px); 
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        } 
        
        /* Estilos de Contenedores */
        .content-section { padding: 15px 0 5px 0; } 
        .section-title { font-size: 1.6rem; font-weight: 700; padding: 0 3vw; margin-bottom: 10px; border-left: 4px solid var(--accent); padding-left: 14px; } 
        .horizontal-scroll { 
            display: flex; overflow-x: auto; padding: 10px 3vw; gap: 15px; 
            scroll-snap-type: x mandatory; scrollbar-width: none;
        } 
        .horizontal-scroll::-webkit-scrollbar { display: none; } 

        /* Card Optimizado con hardware acceleration */
        .card{
            flex: 0 0 140px; background:var(--bg-card); border-radius:4px; 
            overflow:hidden; cursor:pointer; position: relative;
            transform: translateZ(0); transition: transform .2s ease;
            will-change: transform;
        }
        .card img{ display:block; width:100%; height:200px; object-fit:cover; content-visibility: auto; } 
        .info{padding:8px 6px; min-height:55px; background: rgba(0,0,0,0.2);} 
        .info h3{ font-size:0.95rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; } 
        .info span{display:block; color:var(--muted); font-size:.8rem;} 
        
        /* Hero */
        .hero-static-container { position: relative; width: 100%; height: 350px; overflow: hidden; background: #000; } 
        .hero-static-container img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); } 
        .hero-overlay { 
            position: absolute; inset: 0; padding: 30px 3vw;
            background: linear-gradient(0deg, var(--bg-primary) 5%, transparent 100%); 
            display: flex; flex-direction: column; justify-content: flex-end; 
        } 
        .play-button-hero { 
            background: var(--text); color: var(--bg-primary); padding: 12px 25px; border-radius: 4px; 
            font-weight: 700; cursor: pointer; border: none; width: fit-content; 
        } 

        /* Nav */
        #bottomNav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); 
            background: var(--bg-darker); display: flex; z-index: 100; border-top: 1px solid #111;
        } 
        .nav-item { 
            flex: 1; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; color: var(--muted); font-size: 0.7rem; cursor: pointer; 
        } 
        .nav-item.active { color: var(--accent); } 

        /* Detail & Search */
        #searchView, #detailView { display: none; position: fixed; inset: 0; background: var(--bg-primary); z-index: 200; }
        #dynamicGrid { padding: 0 3vw; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; } 

        #loadingIndicator { text-align: center; padding: 20px; color: var(--accent); display: none; }
        #loadingIndicator.show { display: block; }

        /* Badges */
        .card-badge{ position:absolute; top:8px; left:8px; padding:4px 8px; border-radius:4px; font-size:.7rem; font-weight:700; z-index:5; color:#fff; }
        .card-badge.movie{background:#e50914}
        .card-badge.series{background:#00a8e1}
        .card-badge.channel{background:#4caf50}
        .card-badge.adult{background:#ff4757}
        .caps-badge{ position:absolute; bottom:8px; right:8px; background:rgba(0,0,0,.8); padding:4px 8px; border-radius:4px; font-size:.7rem; }

        @media (max-width:680px){ 
            #dynamicGrid { grid-template-columns: repeat(3, 1fr); gap: 8px; } 
            .horizontal-scroll .card { flex: 0 0 120px; } 
        }
    </style>
</head>
<body>

    <div id="ageModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:var(--bg-card); padding:40px; border-radius:10px; text-align:center; max-width:320px;">
            <h2 style="color:#ff4757">CONTENIDO +18</h2>
            <p style="margin:20px 0; color:var(--muted)">¿Eres mayor de edad?</p>
            <button class="play-button-hero" onclick="verifyAge()">SÍ, SOY MAYOR</button>
        </div>
    </div>

    <main>
        <div id="mainView">
            <div id="content"></div>
            <h2 id="gridTitle" class="section-title" style="display:none; margin-top:20px;"></h2>
            <div id="dynamicGrid"></div>
            <div id="loadingIndicator"><i class="fas fa-spinner fa-spin"></i></div>
        </div>

        <div id="searchView">
            <div style="padding: 20px 3vw; display:flex; gap:10px;">
                <button onclick="closeSearch()" style="background:none; border:none; color:#fff; font-size:1.5rem;"><i class="fas fa-arrow-left"></i></button>
                <input type="text" id="searchInput" placeholder="Buscar..." style="flex:1; padding:12px; border-radius:5px; border:none; background:var(--bg-card); color:#fff;">
            </div>
            <div id="searchResultsGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap:10px; padding: 0 3vw;"></div>
        </div>

        <div id="detailView">
            <button id="backBtn" style="position:absolute; top:20px; left:20px; z-index:10; padding:10px 20px; border-radius:5px; border:none; background:var(--accent); color:#fff;">Volver</button>
            <div id="detailHero" style="height:300px; width:100%; position:relative;">
                <img id="detailHeroImage" src="" style="width:100%; height:100%; object-fit:cover;">
                <div style="position:absolute; inset:0; background:linear-gradient(to top, var(--bg-primary), transparent); display:flex; align-items:flex-end; padding:20px 3vw;">
                    <h1 id="detailHeroTitle"></h1>
                </div>
            </div>
            <div style="padding:20px 3vw;">
                <button id="reproduceBtn" class="play-button-hero" style="margin-bottom:20px;"></button>
                <p id="detailDesc" style="color:var(--muted); margin-bottom:20px;"></p>
                <div id="detailEpisodes" class="content-section">
                    <h3>Capítulos</h3>
                    <div class="episodes-list horizontal-scroll" style="margin-top:10px;"></div>
                </div>
            </div>
        </div>
    </main>

    <nav id="bottomNav">
        <div class="nav-item active" onclick="changeTab('home')"><i class="fas fa-home"></i><span>Inicio</span></div>
        <div class="nav-item" onclick="changeTab('series')"><i class="fas fa-tv"></i><span>Series</span></div>
        <div class="nav-item" onclick="changeTab('movies')"><i class="fas fa-film"></i><span>Cine</span></div>
        <div class="nav-item" onclick="changeTab('channels')"><i class="fas fa-satellite"></i><span>Vivos</span></div>
        <div class="nav-item" onclick="changeTab('hentai')"><i class="fas fa-pepper-hot"></i><span>+18</span></div>
        <div class="nav-item" onclick="changeTab('search')"><i class="fas fa-search"></i><span>Buscar</span></div>
    </nav>

    <script>
        // --- DATA & CONFIG ---
        const API_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/data.json";
        const M3U_URL = "https://raw.githubusercontent.com/R3D-GHOST/json/refs/heads/main/CV.m3u8";
        
        let allData = [], series = [], movies = [], channels = [];
        let currentTab = 'home';
        const itemsPerPage = 24;
        let currentPage = 0;

        // --- OPTIMIZED FETCH ---
        async function init() {
            try {
                const [vodRes, m3uRes] = await Promise.all([
                    fetch(API_URL).then(r => r.json()),
                    fetch(M3U_URL).then(r => r.text())
                ]);
                
                allData = vodRes;
                series = allData.filter(i => i.episodes?.length > 0 && !isAdult(i));
                movies = allData.filter(i => !i.episodes?.length && !isAdult(i));
                parseM3U(m3uRes);
                
                renderHome();
            } catch (e) { console.error("Load error", e); }
        }

        function parseM3U(text) {
            const lines = text.split('\n');
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF:')) {
                    const name = lines[i].split(',')[1]?.trim();
                    const logo = lines[i].match(/tvg-logo="([^"]+)"/)?.[1];
                    const url = lines[i+1]?.trim();
                    if (url) channels.push({ title: name, coverImage: logo, video_url: url, isChannel: true });
                }
            }
        }

        const isAdult = (item) => item.genre?.some(g => g.toLowerCase() === 'hentai' || g === '+18');

        // --- RENDER ENGINE ---
        function createCard(item) {
            const card = document.createElement('div');
            card.className = 'card';
            // Lazy loading nativo para imágenes
            const badge = isAdult(item) ? 'adult' : (item.isChannel ? 'channel' : (item.episodes?.length ? 'series' : 'movie'));
            const badgeTxt = isAdult(item) ? '+18' : (item.isChannel ? 'En Vivo' : (item.episodes?.length ? 'Serie' : 'Película'));
            
            card.innerHTML = `
                <div class="card-badge ${badge}">${badgeTxt}</div>
                <img src="${item.coverImage || item.logo || ''}" loading="lazy" alt="">
                <div class="info">
                    <h3>${item.title}</h3>
                </div>
            `;
            card.onclick = () => openDetail(item);
            return card;
        }

        function renderHome() {
            const content = document.getElementById('content');
            content.innerHTML = '';
            
            // Hero
            if (allData[0]) {
                const hero = document.createElement('div');
                hero.className = 'hero-static-container';
                hero.innerHTML = `
                    <img src="${allData[0].coverImage}" alt="">
                    <div class="hero-overlay">
                        <h1>${allData[0].title}</h1>
                        <button class="play-button-hero" onclick='openDetail(${JSON.stringify(allData[0])})'>VER AHORA</button>
                    </div>
                `;
                content.appendChild(hero);
            }

            // Secciones horizontales
            const row = (title, list) => {
                const sec = document.createElement('div');
                sec.className = 'content-section';
                sec.innerHTML = `<h2 class="section-title">${title}</h2>`;
                const scroll = document.createElement('div');
                scroll.className = 'horizontal-scroll';
                list.slice(0,12).forEach(i => scroll.appendChild(createCard(i)));
                sec.appendChild(scroll);
                content.appendChild(sec);
            }

            row('Canales TV', channels);
            row('Series Recientes', series);
            row('Cine Premium', movies);
        }

        function renderGrid(list, title) {
            document.getElementById('content').innerHTML = '';
            const grid = document.getElementById('dynamicGrid');
            const gTitle = document.getElementById('gridTitle');
            grid.innerHTML = '';
            gTitle.innerText = title;
            gTitle.style.display = 'block';
            list.slice(0, itemsPerPage).forEach(i => grid.appendChild(createCard(i)));
        }

        // --- NAVIGATION ---
        function changeTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('searchView').style.display = 'none';
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('gridTitle').style.display = 'none';
            document.getElementById('dynamicGrid').innerHTML = '';

            if (tab === 'home') renderHome();
            else if (tab === 'series') renderGrid(series, 'Series');
            else if (tab === 'movies') renderGrid(movies, 'Películas');
            else if (tab === 'channels') renderGrid(channels, 'Canales en Vivo');
            else if (tab === 'hentai') {
                if (localStorage.getItem('age') !== 'true') document.getElementById('ageModal').style.display = 'flex';
                else renderGrid(allData.filter(isAdult), 'Contenido +18');
            }
            else if (tab === 'search') {
                document.getElementById('mainView').style.display = 'none';
                document.getElementById('searchView').style.display = 'block';
                document.getElementById('searchInput').focus();
            }
        }

        function openDetail(item) {
            const view = document.getElementById('detailView');
            view.style.display = 'block';
            document.getElementById('detailHeroImage').src = item.coverImage || item.logo;
            document.getElementById('detailHeroTitle').innerText = item.title;
            document.getElementById('detailDesc').innerText = item.description || 'Sin descripción.';
            
            const btn = document.getElementById('reproduceBtn');
            const epList = view.querySelector('.episodes-list');
            epList.innerHTML = '';

            if (item.episodes?.length) {
                btn.innerText = "REPRODUCIR CAP. 1";
                btn.onclick = () => window.open(item.episodes[0].video_url, '_blank');
                item.episodes.forEach((ep, idx) => {
                    const eDiv = document.createElement('div');
                    eDiv.style = "flex:0 0 200px; background:var(--bg-card); padding:10px; border-radius:5px; cursor:pointer;";
                    eDiv.innerHTML = `<strong>Cap. ${idx+1}</strong><p style="font-size:0.8rem; color:var(--muted)">${ep.title || 'Ver ahora'}</p>`;
                    eDiv.onclick = () => window.open(ep.video_url, '_blank');
                    epList.appendChild(eDiv);
                });
            } else {
                btn.innerText = "REPRODUCIR AHORA";
                btn.onclick = () => window.open(item.video_url, '_blank');
                view.querySelector('#detailEpisodes').style.display = 'none';
            }
        }

        function closeSearch() { changeTab('home'); }

        function verifyAge() {
            localStorage.setItem('age', 'true');
            document.getElementById('ageModal').style.display = 'none';
            changeTab('hentai');
        }

        // Búsqueda instantánea
        document.getElementById('searchInput').oninput = (e) => {
            const val = e.target.value.toLowerCase();
            const grid = document.getElementById('searchResultsGrid');
            grid.innerHTML = '';
            if (val.length < 2) return;
            allData.filter(i => i.title.toLowerCase().includes(val) && !isAdult(i))
                  .forEach(i => grid.appendChild(createCard(i)));
        };

        document.getElementById('backBtn').onclick = () => { document.getElementById('detailView').style.display = 'none'; };

        init();
    </script>
</body>
</html>
